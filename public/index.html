<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crew Dawg Calculator</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f7fa;
  margin:0;
  padding:20px;
  color:#222;
}

.app{
  width:100%;
  max-width:620px;
  margin:0 auto;
  padding:10px;
}

h1{
  text-align:center;
  margin:10px 0 18px;
}

/* ---------- TOP FORM (SINGLE GRID) ---------- */
.form-grid{
  display:grid;
  grid-template-columns: max-content 120px 34px 92px 120px;
  column-gap:8px;
  row-gap:14px;
  align-items:center;
}

.form-row{
  display:contents;
  font-weight:bold;
}

.label{
  white-space:nowrap;
}

/* Floating-label input wrapper (used for Zulu + Local) */
.floating-wrap{
  position:relative;
  display:inline-block;
  width:120px;
}
.floating-input{
  width:120px;
  padding:6px;
  font-size:16px;
  text-align:center;
  box-sizing:border-box;
}
.floating-label{
  position:absolute;
  left:8px;
  top:-9px;
  font-size:10px;
  color:#666;
  background:#f5f7fa;
  padding:0 4px;
}

/* small "at" */
.at{
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
}

.icao-input{
  width:92px;
  padding:6px;
  font-size:16px;
  text-transform:uppercase;
  text-align:center;
  box-sizing:border-box;
}

/* ---------- ROW 3 (3 equal chunks) ---------- */
.third-content{
  grid-column: 1 / -1;
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  align-items:center;
  gap:12px;
  font-weight:normal;
  width:100%;
}

.aircraft-wrap{
  justify-self:start;
}

#aircraft{
  width:120px;
  padding:6px;
  font-size:16px;
  box-sizing:border-box;
}

.spacer{
  justify-self:center;
  color:#666;
  font-size:12px;
}

.crew-toggle{
  justify-self:end;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  white-space:nowrap;
}

.crew-label{
  font-weight:normal;
  color:#333;
}
.crew-label.active{
  font-weight:bold;
}

/* switch */
.switch{
  position:relative;
  width:52px;
  height:26px;
  flex:0 0 auto;
}
.switch input{ display:none; }

.slider{
  position:absolute;
  inset:0;
  background:#d0d0d0;
  border-radius:26px;
}
.slider:before{
  content:"◀";
  position:absolute;
  height:22px;
  width:22px;
  left:2px;
  top:2px;
  background:#fff;
  border-radius:50%;
  display:grid;
  place-items:center;
  font-size:12px;
  color:#444;
  transition:0.25s;
  box-shadow:0 1px 2px rgba(0,0,0,0.2);
}
input:checked + .slider:before{
  transform:translateX(26px);
  content:"▶";
}

/* ---------- BUTTON ---------- */
button{
  margin-top:20px;
  padding:12px;
  font-size:16px;
  width:100%;
  cursor:pointer;
}

/* ---------- OUTPUT ---------- */
.output{
  margin-top:28px;
  padding:20px;
  background:white;
  border-radius:8px;
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-top:12px;
  font-weight:bold;
}

.subtext{
  font-size:12px;
  color:#666;
  margin-top:2px;
  margin-bottom:6px;
}

.warn{
  background-color:#fff3cd;
  padding:4px 6px;
  border-radius:4px;
}

.danger{
  background-color:#f8d7da;
  padding:4px 6px;
  border-radius:4px;
}

.inline-input{
  width:92px;
  padding:6px;
  font-size:14px;
  text-align:center;
  box-sizing:border-box;
}

.mini-plus{
  border:none;
  background:transparent;
  font-weight:bold;
  font-size:16px;
  line-height:1;
  padding:0 6px;
  margin:0;
  width:auto;
  cursor:pointer;
  color:#333;
  opacity:0.7;
}
.mini-plus:hover{ opacity:1; }
.mini-plus:disabled{ opacity:0.25; cursor:not-allowed; }

.event-grid{
  display:grid;
  grid-template-columns: 1fr 84px 92px;
  gap:8px;
  margin-top:8px;
}

.event-grid input{
  padding:6px;
  font-size:14px;
  box-sizing:border-box;
}

/* ---------- DISCLAIMER ---------- */
.disclaimer{
  margin-top:40px;
  font-size:13px;
  color:#444;
  line-height:1.5;
  text-align:justify;
  text-justify:inter-word;
}

/* ---------- FOOTER ---------- */
.footer{
  margin-top:40px;
  text-align:center;
  font-weight:bold;
}
.footer small{
  display:block;
  font-weight:normal;
  color:#666;
}

/* ---------- MOBILE ---------- */
@media (max-width:620px){
  .form-grid{
    grid-template-columns: max-content 1fr 34px 92px 1fr;
  }
  .floating-wrap, .floating-input{
    width:100%;
  }

  .third-content{
    grid-template-columns: 1fr;
    gap:10px;
  }
  .aircraft-wrap, .spacer, .crew-toggle{
    justify-self:start;
  }
}
</style>
</head>

<body>
<div class="app">

<h1>Crew Dawg Calculator</h1>

<div class="form-grid">

  <!-- Row 1 -->
  <div class="form-row">
    <div class="label">Scheduled Takeoff Time:</div>

    <div class="floating-wrap">
      <div class="floating-label">Zulu</div>
      <input id="takeoffTime" class="floating-input" placeholder="HHMM" maxlength="4">
    </div>

    <div class="at">at</div>

    <input id="takeoffICAO" class="icao-input" placeholder="ICAO" maxlength="4">

    <div class="floating-wrap">
      <div class="floating-label">Local</div>
      <input id="takeoffLocal" class="floating-input" placeholder="HHMM" maxlength="4">
    </div>
  </div>

  <!-- Row 2 -->
  <div class="form-row">
    <div class="label">Scheduled Land Time:</div>

    <div class="floating-wrap">
      <div class="floating-label">Zulu</div>
      <input id="landingTime" class="floating-input" placeholder="HHMM" maxlength="4">
    </div>

    <div class="at">at</div>

    <input id="landingICAO" class="icao-input" placeholder="ICAO" maxlength="4">

    <div class="floating-wrap">
      <div class="floating-label">Local</div>
      <input id="landingLocal" class="floating-input" placeholder="HHMM" maxlength="4">
    </div>
  </div>

  <!-- Row 3 -->
  <div class="form-row">
    <div class="third-content">
      <div class="aircraft-wrap">
        <select id="aircraft">
          <option selected>KC-135</option>
          <option>KC-46</option>
          <option>C-5</option>
          <option>C-17</option>
          <option>C-130</option>
          <option>C-21</option>
          <option>C-32</option>
          <option>C-37</option>
          <option>C-40</option>
          <option>VC-25</option>
        </select>
      </div>

      <div class="spacer"></div>

      <div class="crew-toggle">
        <span id="basicLbl" class="crew-label active">Basic</span>
        <label class="switch">
          <input type="checkbox" id="augmented">
          <span class="slider"></span>
        </label>
        <span id="augLbl" class="crew-label">Augmented</span>
      </div>
    </div>
  </div>

</div>

<button id="calcBtn">Calculate</button>

<div id="output" class="output"></div>

<div class="disclaimer">
  <p><strong>Disclaimer:</strong> I am a crew dog, not a coder. I created this tool to try and help other crew dogs do “pilot math.” I try to keep this up to date with current regulations, but there is no guarantee of its accuracy. Please make sure you <em>trust but verify</em> the information generated on this page (technique only). Information in this calculator is based on AFMAN 11-202V3_AMC SUP, 29 JULY 2024.</p>

  <p>Also, as much as I would like to take credit for this and lead you to think I am smart, I created this tool with the help of ChatGPT. If you find an error, please let me know at <strong>[your email]</strong>.</p>

  <p><strong>Donations:</strong> This tool is free for you to use to help manage your crew. It costs you nothing and costs me a little time. If you feel so inclined to make a donation, please pay it forward and buy your Crew Chief a beer on the next TDY… or just make the Copilot do it. I appreciate your consideration, but I have already taken the bonus, so I am screwed either way. Cheers!</p>
</div>

<div class="footer">
  NKAWT...GF
  <small>(If you know, you know…)</small>
</div>

<script>
/* ----------------- helpers ----------------- */
function isHHMM(s){
  return typeof s === "string" && /^\d{4}$/.test(s) &&
    parseInt(s.slice(0,2),10) <= 23 && parseInt(s.slice(2,4),10) <= 59;
}

function hhmmToMinutes(hhmm){
  return parseInt(hhmm.slice(0,2),10)*60 + parseInt(hhmm.slice(2,4),10);
}

function minutesToHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  return String(Math.floor(mins/60)).padStart(2,"0") +
         String(mins%60).padStart(2,"0");
}

function minutesToHHMMZ(mins){
  return minutesToHHMM(mins) + "Z";
}

function diffMinutes(start, end){
  let d = end - start;
  if(d < 0) d += 1440;
  return d;
}

function minutesToHPlusMM(mins){
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${h}+${String(m).padStart(2,"0")}`;
}

function parseHPlusMM(s){
  if(typeof s !== "string") return null;
  const t = s.trim();
  let m = t.match(/^(\d+)\+([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  m = t.match(/^(\d+):([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  return null;
}

function parseBriefTime(s){
  // accept "HHMM" or "HHMMZ"
  if(typeof s !== "string") return null;
  const t = s.trim().toUpperCase().replace("Z","");
  if(!isHHMM(t)) return null;
  return hhmmToMinutes(t);
}

/* ----------------- ICAO offset (stub for now) ----------------- */
function getUtcOffsetMinutesFromICAO(_icao){
  return 0; // placeholder: Local == Zulu
}

function zuluToLocalMinutes(zuluMins, icao){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase());
  return zuluMins + off;
}
function localToZuluMinutes(localMins, icao){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase());
  return localMins - off;
}

/* ----------------- extra events ----------------- */
const extraEvents = []; // { label: string, offsetMin: number }

/* ----------------- brief override ----------------- */
let briefOffsetMin = 150;          // default 2+30
let briefTimeOverrideMin = null;   // if user edits the output box, we store minutes here

/* ----------------- main calc + render ----------------- */
function calculate(){
  const takeoff = takeoffTime.value.trim();
  const landing = landingTime.value.trim();
  const augmented = augmentedBox.checked;
  const out = document.getElementById("output");

  if(!isHHMM(takeoff) || !isHHMM(landing)){
    out.innerHTML = "Please enter times in HHMM format (0000–2359).";
    return;
  }

  const takeoffMin = hhmmToMinutes(takeoff);
  const landingMin = hhmmToMinutes(landing);

  const showTime   = takeoffMin - 195;
  const crewRest   = takeoffMin - 855;
  const lastBeer   = takeoffMin - 720;
  const legalAlert = takeoffMin - 255;

  // brief time is either override (user-edited) or default offset
  let briefTimeMin = (briefTimeOverrideMin != null) ? briefTimeOverrideMin : (takeoffMin - briefOffsetMin);

  // if override is set, recompute offset so subtext stays truthful
  if(briefTimeOverrideMin != null){
    briefOffsetMin = diffMinutes(briefTimeMin, takeoffMin);
  }

  const stepTime   = takeoffMin - 120;
  const engine     = takeoffMin - 30;

  const flightMin = diffMinutes(takeoffMin, landingMin);
  const flightHrs = (flightMin/60).toFixed(1);

  const fdp = augmented ? 1440 : 960;
  const cdp = augmented ? 1485 : 1080;
  const tdp = 720;
  const apu = augmented ? 1080 : 720;

  const landingFromShow = diffMinutes(showTime, landingMin);

  function hl(limitMinutes){
    if(landingFromShow > limitMinutes) return "danger";
    if(landingFromShow >= limitMinutes * 0.8) return "warn";
    return "";
  }

  const extraRowsHtml = extraEvents.map((ev, idx) => {
    const t = takeoffMin - ev.offsetMin;
    return `
      <div class="row">
        <span>${escapeHtml(ev.label || `Event ${idx+1}`)}</span>
        <span>${minutesToHHMMZ(t)}</span>
      </div>
      <div class="subtext">T/O − ${minutesToHPlusMM(ev.offsetMin)}</div>
    `;
  }).join("");

  out.innerHTML = `
    <div style="font-weight:bold;font-size:18px;text-align:center;">Crew Timing</div>

    <div class="row"><span>Enter Crew Rest</span><span>${minutesToHHMMZ(crewRest)}</span></div>
    <div class="subtext">T/O − 14+15</div>

    <div class="row"><span>Last Beer</span><span>${minutesToHHMMZ(lastBeer)}</span></div>
    <div class="subtext">T/O − 12+00</div>

    <div class="row"><span>Legal for Alert</span><span>${minutesToHHMMZ(legalAlert)}</span></div>
    <div class="subtext">T/O − 4+15</div>

    <div class="row">
      <span>
        Show Time
        <button class="mini-plus" id="addEventBtn" title="Add custom event" ${extraEvents.length>=3 ? "disabled" : ""}>+</button>
      </span>
      <span>${minutesToHHMMZ(showTime)}</span>
    </div>
    <div class="subtext">T/O − 3+15</div>

    <div id="eventEditor" style="margin-top:6px;">
      ${renderEventEditorHtml()}
    </div>

    ${extraRowsHtml}

    <div class="row">
      <span>Brief Time</span>
      <span>
        <input id="briefTimeEdit" class="inline-input" value="${minutesToHHMM(briefTimeMin)}" maxlength="5" title="Edit HHMM (Zulu)">
        <span style="font-size:12px;color:#666;">Z</span>
      </span>
    </div>
    <div class="subtext">T/O − ${minutesToHPlusMM(briefOffsetMin)} (edit time above)</div>

    <div class="row"><span>Step Time</span><span>${minutesToHHMMZ(stepTime)}</span></div>
    <div class="subtext">T/O − 2+00</div>

    <div class="row"><span>Engine Start</span><span>${minutesToHHMMZ(engine)}</span></div>
    <div class="subtext">T/O − 0+30</div>

    <div class="row"><span>Takeoff</span><span>${minutesToHHMMZ(takeoffMin)}</span></div>
    <div class="subtext">T/O − 0+00</div>

    <hr>

    <div class="row"><span>Flight Time</span><span>${flightHrs} hrs</span></div>

    <hr>

    <div style="font-weight:bold;font-size:18px;text-align:center;">Duty Limitations</div>

    <div class="row ${hl(fdp)}"><span>Flight Duty Period</span><span>${minutesToHHMMZ(showTime+fdp)}</span></div>
    <div class="subtext">Show + ${minutesToHPlusMM(fdp)}</div>

    <div class="row ${hl(cdp)}"><span>Crew Duty Time</span><span>${minutesToHHMMZ(showTime+cdp)}</span></div>
    <div class="subtext">Show + ${minutesToHPlusMM(cdp)}</div>

    <div class="row"><span>Transition Duty Day</span><span>${minutesToHHMMZ(showTime+tdp)}</span></div>
    <div class="subtext">Show + ${minutesToHPlusMM(tdp)}</div>

    <div class="row ${hl(apu)}"><span>Autopilot INOP FDP</span><span>${minutesToHHMMZ(showTime+apu)}</span></div>
    <div class="subtext">Show + ${minutesToHPlusMM(apu)}</div>
  `;

  wireEventEditorHandlers();

  // subtle plus next to show time
  document.getElementById("addEventBtn")?.addEventListener("click", () => {
    if(extraEvents.length >= 3) return;
    extraEvents.push({ label: `Event ${extraEvents.length+1}`, offsetMin: 165 }); // default 2+45
    calculate();
  });

  // brief time editable in output
  document.getElementById("briefTimeEdit")?.addEventListener("input", (e) => {
    const val = parseBriefTime(e.target.value);
    if(val == null) return;
    briefTimeOverrideMin = val;
    calculate();
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function renderEventEditorHtml(){
  if(extraEvents.length === 0){
    return ``; // keep it subtle until they add an event
  }

  return `
    ${extraEvents.map((ev, idx) => `
      <div class="event-grid">
        <input data-ev-idx="${idx}" data-ev-field="label" value="${escapeHtml(ev.label)}" maxlength="24" placeholder="Label">
        <input data-ev-idx="${idx}" data-ev-field="offset" value="${minutesToHPlusMM(ev.offsetMin)}" title="H+MM before takeoff">
        <button data-ev-idx="${idx}" data-ev-field="remove" style="padding:6px 8px;font-size:12px; width:auto; margin:0;">✕</button>
      </div>
    `).join("")}
  `;
}

function wireEventEditorHandlers(){
  document.querySelectorAll('[data-ev-field="label"]').forEach(inp => {
    inp.addEventListener("input", (e) => {
      const idx = parseInt(e.target.dataset.evIdx,10);
      extraEvents[idx].label = e.target.value;
      calculate();
    });
  });

  document.querySelectorAll('[data-ev-field="offset"]').forEach(inp => {
    inp.addEventListener("input", (e) => {
      const idx = parseInt(e.target.dataset.evIdx,10);
      const val = parseHPlusMM(e.target.value);
      if(val != null) extraEvents[idx].offsetMin = val;
      calculate();
    });
  });

  document.querySelectorAll('[data-ev-field="remove"]').forEach(btn => {
    btn.addEventListener("click", (e) => {
      const idx = parseInt(e.target.dataset.evIdx,10);
      extraEvents.splice(idx,1);
      calculate();
    });
  });
}

/* ----------------- local time sync ----------------- */
let suppressSync = false;

function syncLocalFromZulu(zuluInput, icaoInput, localInput){
  if(suppressSync) return;
  const z = zuluInput.value.trim();
  if(!isHHMM(z)) return;
  const zM = hhmmToMinutes(z);
  const locM = zuluToLocalMinutes(zM, icaoInput.value.trim());
  suppressSync = true;
  localInput.value = minutesToHHMM(locM);
  suppressSync = false;
}

function syncZuluFromLocal(localInput, icaoInput, zuluInput){
  if(suppressSync) return;
  const l = localInput.value.trim();
  if(!isHHMM(l)) return;
  const lM = hhmmToMinutes(l);
  const zM = localToZuluMinutes(lM, icaoInput.value.trim());
  suppressSync = true;
  zuluInput.value = minutesToHHMM(zM);
  suppressSync = false;
}

/* ----------------- bindings ----------------- */
const augmentedBox = document.getElementById("augmented");
const basicLbl = document.getElementById("basicLbl");
const augLbl = document.getElementById("augLbl");

function syncToggleLabels(){
  basicLbl.classList.toggle("active", !augmentedBox.checked);
  augLbl.classList.toggle("active", augmentedBox.checked);
}

augmentedBox.addEventListener("change", () => {
  syncToggleLabels();
  calculate();
});

document.getElementById("calcBtn").addEventListener("click", calculate);

syncToggleLabels();

/* Local time listeners (both rows) */
const takeoffTime = document.getElementById("takeoffTime");
const takeoffICAO = document.getElementById("takeoffICAO");
const takeoffLocal = document.getElementById("takeoffLocal");

const landingTime = document.getElementById("landingTime");
const landingICAO = document.getElementById("landingICAO");
const landingLocal = document.getElementById("landingLocal");

[takeoffTime, takeoffICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(takeoffTime, takeoffICAO, takeoffLocal);
  calculate();
}));
takeoffLocal.addEventListener("input", () => {
  syncZuluFromLocal(takeoffLocal, takeoffICAO, takeoffTime);
  calculate();
});

[landingTime, landingICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(landingTime, landingICAO, landingLocal);
  calculate();
}));
landingLocal.addEventListener("input", () => {
  syncZuluFromLocal(landingLocal, landingICAO, landingTime);
  calculate();
});
</script>

</div>
</body>
</html>
