<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crew Dawg Calculator</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #eee;
      padding: 40px;
      max-width: 800px;
      margin: auto;
    }
    h1, h2 {
      margin-top: 30px;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    input, select, button {
      margin-top: 5px;
      padding: 8px;
      font-size: 1rem;
      width: 100%;
    }
    button {
      margin-top: 30px;
      cursor: pointer;
    }
    table {
      margin-top: 15px;
      width: 100%;
      border-collapse: collapse;
    }
    td {
      padding: 8px;
      border-bottom: 1px solid #333;
    }
    td:first-child {
      font-weight: 600;
    }
  </style>
</head>
<body>

<h1>Crew Dawg Calculator</h1>

<h2>Takeoff</h2>
<label>
  Time (HHMM)
  <input type="text" id="to_time" placeholder="1300">
</label>

<label>
  Time Reference
  <select id="to_ref">
    <option value="Z">Zulu</option>
    <option value="L">Local</option>
  </select>
</label>

<label>
  ICAO Airfield
  <input type="text" id="to_icao" placeholder="KADW">
</label>

<h2>Landing</h2>
<label>
  Time (HHMM)
  <input type="text" id="ld_time" placeholder="1625">
</label>

<label>
  Time Reference
  <select id="ld_ref">
    <option value="Z">Zulu</option>
    <option value="L">Local</option>
  </select>
</label>

<label>
  ICAO Airfield
  <input type="text" id="ld_icao" placeholder="EDDF">
</label>

<button onclick="calculate()">Generate Timeline</button>

<div id="output"></div>

<script>
  // TEMPORARY mock offset: Local = Zulu - 5 hours


  function parseHHMM(value) {
    if (!/^\d{4}$/.test(value)) return null;
    const h = Number(value.slice(0,2));
    const m = Number(value.slice(2,4));
    if (h > 23 || m > 59) return null;
    return h * 60 + m;
  }

  function formatTime(mins, suffix) {
    mins = (mins + 1440) % 1440;
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return `${String(h).padStart(2,'0')}${String(m).padStart(2,'0')}${suffix}`;
  }

const WORKER_URL = "https://old-surf-349b.calvincraig.workers.dev/convert";

async function getTimesFromWorker(icao, time, ref) {
  const response = await fetch(
    `${WORKER_URL}?icao=${icao}&time=${time}&ref=${ref}`
  );

  if (!response.ok) {
    throw new Error("Worker error");
  }

  return await response.json();
}

function formatZuluAndLocalFromWorker(zuluMinutes, localMinutes) {
  const zulu = formatTime(zuluMinutes, "Z");
  const local = formatTime(localMinutes, "L");
  return `${zulu} / ${local}`;
}

  
  async function calculate() {
  try {
    const toTimeRaw = document.getElementById('to_time').value.trim();
    const localOffset = toData.localMinutes - toData.zuluMinutes;
    const ldTimeRaw = document.getElementById('ld_time').value.trim();

    if (!/^\d{4}$/.test(toTimeRaw) || !/^\d{4}$/.test(ldTimeRaw)) {
      document.getElementById('output').textContent =
        "Please enter times in HHMM format.";
      return;
    }

    const toRef = document.getElementById('to_ref').value;
    const ldRef = document.getElementById('ld_ref').value;
    const toICAO = document.getElementById('to_icao').value.trim().toUpperCase();
    const ldICAO = document.getElementById('ld_icao').value.trim().toUpperCase();

    const toData = await getTimesFromWorker(toICAO, toTimeRaw, toRef);
    let ldData = await getTimesFromWorker(ldICAO, ldTimeRaw, ldRef);

    let toZulu = toData.zuluMinutes;
    let ldZulu = ldData.zuluMinutes;

    if (ldZulu < toZulu) {
      ldZulu += 1440;
    }

    const flightMinutes = ldZulu - toZulu;
    const flightHours = (flightMinutes / 60).toFixed(1);

    const timeline = [
      { label: "Enter Crew Rest", offset: -975 },
      { label: "Last Beer ðŸº", offset: -720 },
      { label: "Legal for Alert", offset: -255 },
      { label: "Show Time", offset: -195 },
      { label: "Brief Time", offset: -150 },
      { label: "Step Time", offset: -120 },
      { label: "Engine Start", offset: -30 },
      { label: "Takeoff Time", offset: 0 },
      { label: "Estimated Land Time", absolute: ldZulu }
    ];

    const showTime = toZulu - 195;

    const dutyLimits = [
      { label: "Flight Duty Ends", time: showTime + 960 },
      { label: "Crew Duty Ends", time: showTime + 1080 },
      { label: "Transition Duty Ends", time: showTime + 720 },
      { label: "Autopilot INOP Duty Ends", time: showTime + 720 }
    ];

    let timelineRows = "";
    for (const e of timeline) {
      const zulu = e.absolute !== undefined
        ? e.absolute
        : toZulu + e.offset;

      timelineRows += `
        <tr>
          <td>${e.label}</td>
          <td>${formatZuluAndLocalFromWorker(
            zulu,
            (zulu + localOffset + 1440) % 1440
          )}</td>
        </tr>`;
    }

    let dutyRows = "";
    for (const d of dutyLimits) {
      dutyRows += `
        <tr>
          <td>${d.label}</td>
          <td>${formatZuluAndLocalFromWorker(
            d.time,
            (d.time + (zulu + localOffset + 1440) % 1440

          )}</td>
        </tr>`;
    }

    document.getElementById('output').innerHTML = `
      <h2>Timeline</h2>
      <table>${timelineRows}</table>

      <h2>Estimated Flight Time</h2>
      <p><strong>${flightHours} hours</strong></p>

      <h2>Duty Limits</h2>
      <table>${dutyRows}</table>
    `;
  } catch (err) {
    document.getElementById('output').textContent =
      "Error calculating timeline. Check ICAO codes.";
  }
}

</script>

</body>
</html>
