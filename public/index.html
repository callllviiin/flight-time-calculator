<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flight Time Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
    }
    label {
      display: block;
      margin-top: 12px;
    }
    input, select, button {
      margin-top: 4px;
      padding: 6px;
      font-size: 14px;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
      width: 100%;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    h2 {
      margin-top: 30px;
    }
  </style>
</head>
<body>

<h1>Flight Time Calculator</h1>

<label>
  Takeoff ICAO:
  <input id="to_icao" placeholder="KADW" />
</label>

<label>
  Takeoff Time (HHMM):
  <input id="to_time" placeholder="1200" />
  <select id="to_ref">
    <option value="Z">Zulu</option>
    <option value="L">Local</option>
  </select>
</label>

<label>
  Landing ICAO:
  <input id="ld_icao" placeholder="KDEN" />
</label>

<label>
  Landing Time (HHMM):
  <input id="ld_time" placeholder="1525" />
  <select id="ld_ref">
    <option value="Z">Zulu</option>
    <option value="L">Local</option>
  </select>
</label>

<br />
<button onclick="calculate()">Calculate</button>

<div id="output"></div>

<script>
const WORKER_URL = "https://old-surf-349b.calvincraig.workers.dev/convert/";

function parseTime(hhmm) {
  const h = parseInt(hhmm.slice(0, 2), 10);
  const m = parseInt(hhmm.slice(2), 10);
  return h * 60 + m;
}

function formatTime(mins, suffix) {
  mins = ((mins % 1440) + 1440) % 1440;
  const h = Math.floor(mins / 60).toString().padStart(2, '0');
  const m = (mins % 60).toString().padStart(2, '0');
  return `${h}${m}${suffix}`;
}

async function getTimesFromWorker(icao, time, ref) {
  const response = await fetch(
    `${WORKER_URL}?icao=${icao}&time=${time}&ref=${ref}`
  );

  if (!response.ok) {
    throw new Error("Worker error");
  }

  return await response.json();
}

function formatZuluLocal(zulu, local) {
  return `${formatTime(zulu, "Z")} / ${formatTime(local, "L")}`;
}

async function calculate() {
  try {
    console.log("CALCULATE RUNNING");

    const toICAO = document.getElementById("to_icao").value.trim().toUpperCase();
    const ldICAO = document.getElementById("ld_icao").value.trim().toUpperCase();
    const toTime = document.getElementById("to_time").value.trim();
    const ldTime = document.getElementById("ld_time").value.trim();
    const toRef = document.getElementById("to_ref").value;
    const ldRef = document.getElementById("ld_ref").value;

    if (!/^\d{4}$/.test(toTime) || !/^\d{4}$/.test(ldTime)) {
      document.getElementById("output").textContent =
        "Times must be entered as HHMM.";
      return;
    }

    const toData = await getTimesFromWorker(toICAO, toTime, toRef);
    const ldData = await getTimesFromWorker(ldICAO, ldTime, ldRef);

    let toZulu = toData.zuluMinutes;
    let ldZulu = ldData.zuluMinutes;

    if (ldZulu < toZulu) {
      ldZulu += 1440;
    }

    const localOffset = toData.localMinutes - toData.zuluMinutes;

    const flightMinutes = ldZulu - toZulu;
    const flightHours = (flightMinutes / 60).toFixed(1);

    const showTime = toZulu - 195;

    const timeline = [
      { label: "Enter Crew Rest", time: toZulu - 975 },
      { label: "Last Beer ðŸº", time: toZulu - 720 },
      { label: "Legal for Alert", time: toZulu - 255 },
      { label: "Show Time", time: showTime },
      { label: "Brief Time", time: toZulu - 150 },
      { label: "Step Time", time: toZulu - 120 },
      { label: "Engine Start", time: toZulu - 30 },
      { label: "Takeoff Time", time: toZulu },
      { label: "Estimated Land Time", time: ldZulu }
    ];

    const dutyLimits = [
      { label: "Flight Duty Ends", time: showTime + 960 },
      { label: "Crew Duty Ends", time: showTime + 1080 },
      { label: "Transition Duty Ends", time: showTime + 720 },
      { label: "Autopilot INOP Duty Ends", time: showTime + 720 }
    ];

    let html = "<h2>Timeline</h2><table>";
    for (const e of timeline) {
      const local = e.time + localOffset;
      html += `<tr><td>${e.label}</td><td>${formatZuluLocal(e.time, local)}</td></tr>`;
    }
    html += "</table>";

    html += `<h2>Estimated Flight Time</h2><p><strong>${flightHours} hours</strong></p>`;

    html += "<h2>Duty Limits</h2><table>";
    for (const d of dutyLimits) {
      const local = d.time + localOffset;
      html += `<tr><td>${d.label}</td><td>${formatZuluLocal(d.time, local)}</td></tr>`;
    }
    html += "</table>";

    document.getElementById("output").innerHTML = html;

  } catch (err) {
    console.error(err);
    document.getElementById("output").textContent =
      "Error calculating timeline. Check ICAO codes.";
  }
}
</script>

</body>
</html>
