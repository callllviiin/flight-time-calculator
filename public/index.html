<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crew Dawg Calculator</title>

<style>
/* ======================================================== BEGINNING OF STYLE ======================================================= */

/* =========================
   GLOBAL / PAGE WRAPPER 
   ========================= */
html{
  overflow-y: scroll; /* reserve scrollbar space to prevent 1st-click centering shift */
}

body{
  font-family: Arial, sans-serif;
  background:#f5f7fa;
  margin:0;
  padding:20px;
  color:#222;
}

.app{
  width: 100%;
  max-width: 744px;     /* iPad mini portrait baseline */
  margin: 0 auto;
  padding: 10px 12px;   /* inner breathing room */
  box-sizing: border-box;
}

#pageRoot{
  padding-left: 16px;
  padding-right: 16px;
  box-sizing: border-box;
}

/* =========================
   HEADER (TITLE + RESET)
   ========================= */
.headerbar{
  display: grid;
  grid-template-columns: 80px 1fr 80px;
  align-items: center;

  margin: 0 0 8px;
  min-height: 44px;
}

/* Title */
.headerbar h1{
  grid-column: 2;
  white-space: nowrap;   /* prevents wrap */
  margin: 10px 0;
  text-align: center;

  font-size: 30px;
  font-weight: 800;
  line-height: 1.1;
  text-shadow: 0 0 0.4px rgba(0,0,0,0.6);
}

/* Small Reset button (top-right) */
.headerbar .header-reset{
  grid-column: 3;
  justify-self: end;
  align-self: center;

  width: 80px;
  height: 30px;

  background: #fff;
  border: 1px solid #cfcfcf;

  font-family: Arial, sans-serif;
  font-size: 12px;
  font-weight: 700;
  font-variant: small-caps;
  letter-spacing: 0.6px;
  color: #1f2a44;

  border-radius: 8px;
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;

  box-shadow: 0 2px 6px rgba(0,0,0,0.08);

  transform: translateY(-9px);
}

.headerbar .header-reset:hover{
  background: #f5f7fa;
}

.headerbar .header-reset:active{
  background: #e9ecf2;
  transform: translateY(1px);
}

.app-title{
  font-variant: small-caps;
  letter-spacing: 1px;
}

/* =========================
   INPUTS & PANEL (border) (shared)
   ========================= */
input,
select{
  font-family: Consolas, Menlo, "Courier New", monospace;
}

input{
  letter-spacing: 2.2px;
  font-weight: 600;
}

.input-panel{
  margin-top: 14px;
  padding: 21px 14px 18px;

  background: #fafbfd;
  border: 1px solid #1f2a44;
  border-radius: 10px;

  box-sizing: border-box;
}

/* =========================
   TOP FORM GRID (ROWS 1–3)
   ========================= */
.form-grid{
  display:grid;
  width:100%;
   
  /* 6 columns: Label | Zulu | at/gap | ICAO | gap | Local */
  grid-template-columns: 200px 104px 20px 104px 20px 104px;
   
  column-gap:8px;
  row-gap:20px;
  align-items:center;
  margin-top:0px;

  justify-content:center; /* centers the whole grid inside the 744px app */
}

.form-row{
  display:contents;
  font-weight:bold;
}

/* left labels */
.label{
  white-space:normal;
  line-height:1.1;
}

.form-label{
  font-variant: small-caps;
  letter-spacing: 0.8px;
}

/* common input sizing */
.box{
  width:104px;
  padding:6px;
  font-size:18px;
  text-align:center;
  box-sizing:border-box;
}

input.box{
  vertical-align: middle;
}

/* invalid state (does NOT override focus ring) */
input.box.invalid{
  border: 1.5px solid #8b0000;
}

/* Home Station: lock metrics so invalid doesn't change height */
.home-wrap input.box{
  border: 1.5px solid #cfcfcf;
  border-radius: 4px;
  background: #fff;
  box-sizing: border-box;
}


/* =========================
   FLOATING LABELS + HINTS
   ========================= */
.floating-wrap{
  position: relative;
  display: inline-block;
  width: 104px;
  padding-top: 0 !important;   /* prevents alignment shift */
  overflow: visible;           /* ensure focus ring isn’t clipped */
}

.floating-label{
  position:absolute;
  left:4px;
  top:-9px;
  z-index:3;
  pointer-events:none;

  font-size:9px;
  font-weight:600;
  line-height:1;

  background:#f5f7fa;
  padding:0 3px;
  border-radius:4px;
  color:#666;
}

/* Generic hint (positioned under its field) */
.icao-hint{
  position:absolute;
  left:0;
  right:0;
  top:100%;
  margin-top:2px;

  font-size:10px;
  font-weight:600;
  line-height:1.1;
  color:#666;

  text-align:center;
  pointer-events:none;
  white-space:nowrap;

  min-height:14px;             /* stable spacing */
  transform: translateY(-1px); /* subtle tuck */
}

.icao-hint.bad{
  color:#8b0000;
}

/* Time-only hint: tuck under right edge of a 104px box */
.icao-hint.time-hint{
  left:auto;
  right:0;
  width:104px;
  text-align:right;
}

/* ICAO wrapper */
.icao-wrap{
  position:relative;
  width:104px;
}
.icao-wrap .box{ width:100%; }

/* "at" column */
.at{
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
}

.gap{
  /* same width/behavior as the “at” column, but blank */
  display:flex;
  align-items:center;
  justify-content:center;
}
   
/* Local column spacing */
.local-wrap{
  margin-left:0;
  justify-self:start;
}

/* Day shift marker inside local box */
.day-shift{
  position:absolute;
  right:6px;
  bottom:6px;
  font-size:10px;
  color:#666;
  font-weight:700;
  line-height:1;
  pointer-events:none;
  background:transparent;
}

/* Give Local inputs room so +1/-1 doesn't overlap digits */
.local-wrap .box{
  padding-right:18px;
  padding-left:18px;
}


/* =========================
   TIME SHIFT SUPERSCRIPTS (output + local)
   ========================= */
.shift-sup{
  font-size:10px;
  font-weight:700;
  margin-left:0px;
  vertical-align:super;
  color:#000;
  opacity:1;
}

.timewrap{
  position:relative;
  display:inline-block;
  padding-right:12px;
}

.timewrap .shift-sup{
  position:absolute;
  right:0;
  top:-2px;
  margin-left:0;
}


/* =========================
   ROW 3: AIRCRAFT / HOME / AUGMENTED
   ========================= */
/* Aircraft select look/feel */
#aircraft{
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;

  width:104px;
  height:34px;
  box-sizing:border-box;

  border:1px solid #cfcfcf;
  border-radius:4px;
  background:#fff;
  color:#222;

  padding:6px 26px 6px 6px;
  line-height:normal;

  font-size:18px;
  font-family: Consolas, Menlo, "Courier New", monospace;
  font-weight:600;
  text-align:center;

  cursor:pointer;
  justify-self:start;
  transform: translateY(1px);
  background-image:
    linear-gradient(45deg, transparent 50%, #555 50%),
    linear-gradient(135deg, #555 50%, transparent 50%);
  background-position:
    calc(100% - 16px) 55%,
    calc(100% - 11px) 55%;
  background-size:5px 5px;
  background-repeat:no-repeat;
}

/* Home wrap */
.home-wrap{
  position:relative;
  width:104px;
}
.home-wrap .box{
  width:100%;
  padding:6px;
  font-size:18px;
  text-align:center;
}

/* Grid placement for Row 3 items (main 5-col grid) */
.form-grid .form-row #aircraft{
  grid-column: 2;
}
.form-grid .form-row .at{
  grid-column: 3;
}
.form-grid .form-row .home-wrap{
  grid-column: 4;
  justify-self:start;
}
.form-grid .form-row .crew-check{
  grid-column: 6;
  display:flex;
  align-items:center;
  justify-self:start;
  height:30px;
  white-space:nowrap;
}

/* Row 3 label */
.aircraft-crew-label{
  font-weight:bold;
}

/* Crew Check component */
.crew-check-label{
  cursor: pointer;
  display:flex;
  align-items:center;
  gap:3px;                    /* spacing between checkbox and word */
  user-select:none;
  transform: translateX(-2px) translateY(-2px);
}

.crew-check-label input[type="checkbox"]{
  cursor: pointer;
  width:16px;
  height:16px;
  transform: translateY(1px);
  cursor:pointer;
}

.crew-check-text{
  cursor: pointer;
  font-family: Arial, sans-serif;
  font-variant: small-caps;
  letter-spacing:0.1px;
  font-size:14px;
  font-weight:400;
  color:#555;
  transform: translateY(0px);

  display:inline-block;
  min-width:9ch;          /* reserves space so bold can't grow */
  text-align:left;
}

/* Checked emphasis (keep weight-change feature) */
.crew-check-label input[type="checkbox"]:checked + .crew-check-text{
  font-weight:700;
  color:#000;
}


/* =========================
   PRIMARY BUTTONS
   ========================= */
button{
  margin-top:0px;
  padding:14px 12px;
  font-size:20px;
  font-weight:800;
  font-variant: small-caps;
  letter-spacing:0.8px;
  width:100%;
  cursor:pointer;

  background:#1f2a44;
  color:#fff;
  border:1px solid #141b2d;
  border-radius:10px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
}

button:hover{ filter:brightness(1.05); }

button:active{
  transform:translateY(1px);
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}

button:disabled{
  opacity:0.5;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}


/* =========================
   FOCUS RINGS (rounded orange)
   ========================= */
input.box:focus,
input.box:focus-visible{
  outline:none !important;
  box-shadow:0 0 0 2px #ff8a3d;
}

#aircraft:focus,
#aircraft:focus-visible{
  outline:none !important;
  box-shadow:0 0 0 2px #ff8a3d;
}

button:focus,
button:focus-visible{
  outline:none !important;
  box-shadow:0 0 0 2px #ff8a3d;
}


/* =========================
   OUTPUT PANEL + ROW SYSTEM
   ========================= */
:root{
  --row-label-w: 190px;
  --row-gap: 14px;
  --time-col-w: 92px;
  --row-time-minw: 70px;
  --row-time-mr: 40px;
  --row-pad-y: 4px;
  --row-pad-x: 6px;
  --row-radius: 4px;
}

.output{
  margin-top:16px;
  padding:20px 20px 12px;
  background:white;
  border-radius:8px;
  border:1px solid #1f2a44;
  overflow: visible;

  transform-origin: top;
  transition: opacity 260ms ease, transform 260ms ease;
}

.output.collapsing{
  opacity: 0;
  transform: scaleY(0);
}

.output.collapsing-to-idle{
  opacity:1;
  transform: scaleY(var(--idleScale, 0.35));
}

.output hr{ margin:14px 0; }

/* Output action buttons (bottom) */
.output-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.output-actions button{
  margin-top:0;
  width:100%;
  padding:12px 12px;
  font-size:16px;
  border-radius:10px;
}

.output-actions button:disabled{ opacity:0.55; }

/* Output: idle state */
.output.idle{
  height:52px;
  padding:0 12px;

  border:1px solid #1f2a44;
  border-radius:10px;
  background:#fff;

  font-variant: small-caps;
  letter-spacing:0.8px;

  font-size:14px;
  font-weight:600;
  color:rgba(31,42,68,0.55);
  line-height:1;

  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  text-align:center;
}

/* legacy row (flight time block) */
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-top:12px;
  font-weight:bold;
}

.row.flight-time .sc-label,
.row.flight-time .mono{
  font-size:17.5px;
}

/* Headers */
.sc-head{
  font-variant: small-caps;
  letter-spacing: 1px;
}

.sc-head.timing-head{
  font-size:20px;
  margin-top:-10px;
}

.sc-head.duty-head{
  font-size:19px;
}

/* Labels + mono */
.sc-label{
  font-variant: small-caps;
  letter-spacing: 0.6px;
}

.mono{
  font-family: Consolas, Menlo, "Courier New", monospace;
  letter-spacing: 1px;
  font-weight: 700;
  font-size: 1.05em;
}

.tz-sfx{
  font-size:10px;
  font-weight:700;
  margin-left:1px;
  color:#000;
  opacity:1;
}

/* Subtext under timing rows */
.subtext{
  font-size:11px;
  color:#666;
  margin-top:-1px;
  margin-bottom:8px;
  padding-left: var(--row-pad-x);
  padding-right: var(--row-pad-x);
  text-align:left;
}

/* Unified output rows */
.row3, .row4{
  display:grid;
  margin-top:12px;
  font-weight:bold;
  align-items:center;
  column-gap: var(--row-gap);
  box-sizing:border-box;
}

.row3.dutyrow{
  grid-template-columns: var(--row-label-w) 1fr var(--time-col-w);
}

.row3.timerow{
  grid-template-columns: var(--row-label-w) 1fr var(--time-col-w) var(--time-col-w);
}

.row4{
  grid-template-columns: var(--row-label-w) 1fr var(--time-col-w) var(--time-col-w);
}

.row3.timerow .mcol,
.row4 .mcol{
  display:flex;
  justify-content:flex-start;
  align-items:center;
  text-align:left;
  font-weight:500;
}

.row3.dutyrow .lcol{
  display:flex;
  justify-content:flex-start;
  align-items:center;
  text-align:left;
  font-weight:500;
}

.row3 .lcol, .row4 .lcol{
  text-align:right;
  font-weight:700;
  color:inherit;
  min-width: var(--row-time-minw);
  margin-right: 0;
}

.row3 .zcol, .row4 .zcol{
  text-align:right;
  min-width: var(--row-time-minw);
}

/* Crew timing padding frame */
.crew-timing .row3{
  font-size: inherit;
  padding: var(--row-pad-y) var(--row-pad-x);
  border-radius: var(--row-radius);
}

.crew-timing .mono{
  font-size:17.5px;
}

.crew-timing .row4{
  font-size:17.5px;
}

/* Show Time inline ORM note */
.showtime-inline{ white-space:nowrap; }

.show-orm-inline{
  font-family: Arial, sans-serif;
  font-variant: normal;
  letter-spacing: normal;
  text-transform: none;

  font-size:11px;
  font-weight:600;
  color:#000;
  margin-left:2.5em;
  white-space:nowrap;
}

.showtime-circ{
  font-size:12px;
  font-weight:650;
  color:#000;
}

.showtime-circ .mono{
  font-size:12px;
  font-weight:600;
  color:#000;
}

.show-orm-inline .showtime-circ{
  font-weight:700;
  color:#333;
}

/* ORM note */
.orm-note{
  display:block;
  font-size:11px;
  font-weight:600;
  color:inherit;
  line-height:1.1;
  text-align:left;
  margin-right:0;
}

.row3.midtext{
  grid-template-columns: var(--row-label-w) 1fr var(--time-col-w);
}

.row3.midtext .lcol{
  display:flex;
  justify-content:flex-start;
  align-items:center;
  font-weight:500;
}

.row3.midtext .orm-note{
  white-space:nowrap;
  display:inline-block;
}

.row3.dutyrow .orm-note{
  display:inline-block;
  white-space:nowrap;
}

/* ORM color bands (FDP strong) */
.orm-low{
  background:#d4edda;
  border:1px solid #7bbf8b;
  padding:4px 6px;
  border-radius:4px;
}

.orm-mod{
  background:#fff3cd;
  border:1px solid #d6b656;
  padding:4px 6px;
  border-radius:4px;
}

.orm-high{
  background:#ffb74d;
  border:1px solid #c77a16;
  padding:4px 6px;
  border-radius:4px;
}

.orm-severe{
  background:#f44336;
  border:1px solid #a10000;
  color:#000;
  padding:4px 6px;
  border-radius:4px;
}
.orm-severe .tz-sfx{ color:#000; }

.orm-exceed{
  background:#c62828;
  color:#fff;
  padding:4px 6px;
  border-radius:4px;
  outline:2px solid #7f0000;
  outline-offset:-1px;
}
.orm-exceed .tz-sfx{ color:#fff; opacity:1; }

/* ORM muted */
.ormm-low{
  background:#eaf6ee;
  border:1px solid #c7e7d0;
  padding:4px 6px;
  border-radius:4px;
}

.ormm-mod{
  background:#fff8e3;
  border:1px solid #f1e0b6;
  padding:4px 6px;
  border-radius:4px;
}

.ormm-high{
  background:#ffe2bf;
  border:1px solid #f3c08a;
  padding:4px 6px;
  border-radius:4px;
}

.ormm-severe{
  background:#ffd1d1;
  border:1px solid #f1a0a0;
  color:#000;
  padding:4px 6px;
  border-radius:4px;
}
.ormm-severe .tz-sfx{ color:#000; }

/* Make day shift readable on highlighted duty rows */
.orm-low .shift-sup,
.orm-mod .shift-sup,
.orm-high .shift-sup,
.orm-severe .shift-sup,
.orm-exceed .shift-sup,
.ormm-low .shift-sup,
.ormm-mod .shift-sup,
.ormm-high .shift-sup,
.ormm-severe .shift-sup{
  font-weight:900;
  opacity:1;
  color:#000;
}


/* =========================
   INLINE MINI EDITORS
   ========================= */
.inline-mini{
  width:44px;
  font-size:11px;
  font-family: Consolas, Menlo, "Courier New", monospace;
  padding:1px 1px;
  text-align:center;
  box-sizing:border-box;
  border-radius:4px;
  border:1px solid #cfcfcf;
  background:#fff;
}


/* =========================
   FOOTER LINKS + MODAL
   ========================= */
.footer{
  margin-top:25px;
  text-align:center;
  font-weight:bold;
}

.footer small{
  display:block;
  font-weight:normal;
  color:#666;
}

.info-links{
  margin-top:30px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:14px;
  flex-wrap:nowrap;
  white-space:nowrap;
  font-size:13px;
}

.info-links button{
  background:#fff;
  border:1px solid #cfcfcf;
  padding:6px 10px;
  margin:0;

  font-family: Arial, sans-serif;
  font-size:13px;
  font-weight:600;
  color:#1f2a44;

  text-decoration:none;
  cursor:pointer;

  border-radius:8px;
}

.info-links button:hover{ background:#f5f7fa; }
.info-links button:active{
  background:#e9ecf2;
  transform:translateY(1px);
}

/* Modal */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  padding:18px;
}

.modal-overlay.open{ display:flex; }

.modal{
  width:min(560px, 100%);
  max-height:85vh;
  background:#fff;
  border-radius:14px;
  border:1px solid #cfcfcf;
  box-shadow:0 18px 40px rgba(0,0,0,0.25);
  overflow:hidden;
  font-family: Arial, sans-serif;
}

.modal-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid #e6e6e6;
}

.modal-title{
  font-size:16px;
  font-weight:900;
  letter-spacing:0.3px;
  color:#1f2a44;
}

.modal-close{
  background:none !important;
  border:none !important;
  padding:6px 10px !important;
  margin:0 !important;
  width:auto !important;
  font-size:18px !important;
  font-weight:900 !important;
  color:#1f2a44 !important;
  cursor:pointer;
  box-shadow:none !important;
  border-radius:10px;
}

.modal-close:hover{ opacity:0.85; }

.modal-body{
  padding:14px;
  max-height: calc(85vh - 52px);
  overflow:auto;
  color:#222;
  font-size:13px;
  line-height:1.55;
}

.modal-body p{ margin:0 0 10px; }
.modal-body strong{ font-weight:900; }


/* =========================
   MOBILE PLACEHOLDER
   ========================= */


/* ======================================================== END OF STYLE ======================================================= */
</style>

</head>

<body>
<div id="pageRoot">

 <div class="app">

<div class="headerbar">
  <h1 class="app-title">Crew Dawg Calculator</h1>

<button id="resetBtn" class="header-reset" type="button" title="Reset" tabindex="-1">
  Reset
</button>

</div>

   <div class="input-panel">
    <div class="form-grid">

      <!-- Row 1 -->
      <div class="form-row">
        <div class="label form-label">Sched. Takeoff Time:</div>

        <div class="floating-wrap">
          <div class="floating-label">Zulu</div>
          <div id="takeoffTimeHint" class="icao-hint bad time-hint"></div>
          <input id="takeoffTime" class="box" placeholder="HHMM" maxlength="4" tabindex="1">
        </div>

        <div class="at">at</div>

      <div class="icao-wrap">
        <input id="takeoffICAO" class="box" placeholder="ICAO" maxlength="4" style="text-transform:uppercase;" tabindex="2">
        <div id="takeoffIcaoHint" class="icao-hint time-hint"></div>
      </div>

      <div class="gap"></div>
         
      <div class="floating-wrap local-wrap">
        <div class="floating-label">Local</div>
          <input id="takeoffLocal" class="box" placeholder="HHMM" maxlength="4" tabindex="-1">
          <span id="takeoffLocalDay" class="day-shift"></span>
         <div id="takeoffLocalHint" class="icao-hint bad time-hint"></div>
      </div>

      </div>

      <!-- Row 2 -->
      <div class="form-row">
        <div class="label form-label">Sched. Land Time:</div>

        <div class="floating-wrap">
          <div class="floating-label">Zulu</div>
          <div id="landingTimeHint" class="icao-hint bad time-hint"></div>
          <input id="landingTime" class="box" placeholder="HHMM" maxlength="4" tabindex="3">
        </div>

        <div class="at">at</div>

      <div class="icao-wrap">
        <input id="landingICAO" class="box" placeholder="ICAO" maxlength="4" style="text-transform:uppercase;" tabindex="4">
      <div id="landingIcaoHint" class="icao-hint time-hint"></div>
    </div>

      <div class="gap"></div>
         
      <div class="floating-wrap local-wrap">
       <div class="floating-label">Local</div>
         <input id="landingLocal" class="box" placeholder="HHMM" maxlength="4" tabindex="-1">
          <span id="landingLocalDay" class="day-shift"></span>
         <div id="landingLocalHint" class="icao-hint bad time-hint"></div>
      </div>

      </div>

      <!-- Row 3 -->
<div class="form-row">
  <div class="label aircraft-crew-label form-label">Aircraft / Crew:</div>

  <!-- Col 2: Aircraft -->
  <select id="aircraft" tabindex="-1">
    <option selected>KC-135</option>
    <option disabled>KC-46</option>
    <option disabled>C-5</option>
    <option disabled>C-17</option>
    <option disabled>C-130</option>
  </select>

  <!-- Col 3: blank spacer (same width as "at") -->
  <div class="at"></div>

  <!-- Col 4: Home -->
  <div class="home-wrap floating-wrap">
    <div class="floating-label">Home Station</div>
    <input id="homeICAO" class="box" placeholder="ICAO" maxlength="4" style="text-transform:uppercase;" tabindex="-1">
    <div id="homeIcaoHint" class="icao-hint time-hint"></div>
  </div>

  <!-- Col 5: NEW blank spacer -->
  <div class="gap"></div>

  <!-- Col 6: Augmented -->
  <div class="crew-check">
    <label class="crew-check-label">
      <input type="checkbox" id="augmented" tabindex="-1">
      <span id="augLbl" class="crew-check-text">Augmented</span>
    </label>
  </div>
</div>

 </div> <!-- end .form-grid -->
</div> <!-- end .input panel -->
    
<button id="calcBtn" tabindex="5">Calculate</button>

    <div id="output" class="output"></div>

   <!--
    <div class="disclaimer">
      <p><strong>Disclaimer:</strong> I am a crew dog, not a coder or developer. I created this tool to help other crew dogs do “pilot math.” I try to keep this up to date with current regulations, but there is no guarantee of its accuracy. Please make sure you <em>trust but verify</em> the information generated on this page (technique only). Information in this calculator is based on AFMAN 11-202V3_AMC SUP, 29 JULY 2024.</p>

      <p>Also, as much as I would like to take credit for this and lead you to think I am smart, which I am not, I created this tool with the help of ChatGPT. If you find an error or have a suggetion for a change, please let me know at <strong>[your email]</strong>.</p>

      <p><strong>Donations:</strong> This is a free tool to help manage crew timing. It costs you nothing and costs me a little time and effort. If you feel so inclined to make a donation, please pay it forward and buy your Crew Chief a beer on the next TDY… or just make the Copilot do it. I appreciate your consideration, but I have already taken the bonus, so I am screwed either way. Blue skies and fair winds. Cheers!</p>
    </div>
-->

<div class="info-links">
  <button type="button" data-modal="disclaimer">Disclaimer</button>
  <button type="button" data-modal="feedback">Feedback</button>
  <button type="button" data-modal="credits">Credits</button>
  <button type="button" data-modal="donations">Donations</button>
</div>


<!-- Modal content sources (kept out of the normal page flow) -->
<template id="tpl-disclaimer">
  <p><strong>Disclaimer:</strong> I am a crew dog, not a coder or developer. I created this tool to help other crew dogs do “pilot math.” I try to keep this up to date with current regulations, but there is no guarantee of its accuracy. Please make sure you <em>trust but verify</em> the information generated on this page (technique only). Information in this calculator is based on AFMAN 11-202V3_AMC SUP, 29 JULY 2024.</p>

  <p>Also, as much as I would like to take credit for this and lead you to think I am smart, which I am not, I created this tool with the help of ChatGPT. If you find an error or have a suggetion for a change, please let me know at <strong>[your email]</strong>.</p>
</template>

<template id="tpl-feedback">
  <p><strong>Feedback:</strong> Found a bug, wrong timing, missing ICAO, or a UX improvement? Send details (inputs + screenshot if possible) to <strong>[your email]</strong>.</p>
</template>

<template id="tpl-credits">
  <p><strong>Credits:</strong> Built by a crew dog for crew dogs. UI/logic assistance provided with ChatGPT. Thanks to early testers who tried to break it.</p>
</template>

<template id="tpl-donations">
  <p><strong>Donations:</strong> This is a free tool to help manage crew timing. It costs you nothing and costs me a little time and effort. If you feel so inclined to make a donation, please pay it forward and buy your Crew Chief a beer on the next TDY… or just make the Copilot do it. I appreciate your consideration, but I have already taken the bonus, so I am screwed either way. Blue skies and fair winds. Cheers!</p>
</template>

<!-- Modal shell (hidden until opened) -->
<div id="infoModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header">
      <div id="modalTitle" class="modal-title">Info</div>
      <button type="button" class="modal-close" id="modalCloseBtn" aria-label="Close">✕</button>
    </div>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>
  
   
    <div class="footer">
      NKAWT...GF
      <small>(If you know, you know…)</small>
    </div>
  </div>

</div>

<script>
  console.log("✅ Script loaded");
window.addEventListener("error", (e) => showRuntimeError(e.error || e.message));


  
/* ----------------- helpers ----------------- */

// ----------------- Crew Text (Phase 2 v1) -----------------
let lastCrewText = "";   // updated on every Calculate

function fmtZuluPlain(totalMins){
  const m = ((totalMins % 1440) + 1440) % 1440;
  return minutesToHHMM(m) + "Z";
}

function fmtLocalPlain(totalZuluMins, icao){
  const key = normICAO(icao || "");
  if(!isICAO(key) || !getTimeZoneFromICAO(key)) return "";

  const zNorm = ((totalZuluMins % 1440) + 1440) % 1440;
  const zHHMM = minutesToHHMM(zNorm);

  const res = zuluToLocalWithDay(zNorm, key, zHHMM);
  if(!res) return "";

  return minutesToHHMM(res.localMins) + "L";
}

function fmtLocalDelta(mins){
  // mins = UTC offset minutes (e.g., -480 for Pacific)
  // We want: "Local −08:00" or "Local +05:30"
  const sign = mins <= 0 ? "−" : "+";
  const a = Math.abs(mins);
  const hh = String(Math.floor(a / 60)).padStart(2, "0");
  const mm = a % 60;
  return mm ? `Local ${sign}${hh}:${String(mm).padStart(2,"0")}`
            : `Local ${sign}${hh}`;
}

function buildCrewText(tkIcao, times){
  // Determine Zulu offset relative to Local at takeoff ICAO
  let offsetMin = 0;
  if(isICAO(tkIcao)){
    const off = getUtcOffsetMinutesFromICAO(tkIcao, "0000");
    if(typeof off === "number") offsetMin = -off;
  }

  // Format +HH:MM
  const sign = offsetMin >= 0 ? "+" : "−";
  const abs  = Math.abs(offsetMin);
  const hh   = String(Math.floor(abs / 60)).padStart(2, "0");
  const mm   = String(abs % 60).padStart(2, "0");
  const offsetStr = `${sign}${hh}:${mm}`;

  const lines = [
    ["Crew Rest", times.crewRest],
    ["Alert",     times.legalAlert],
    ["Show",      times.showTime],
    ["Brief",     times.briefTime],
    ["Step",      times.stepTime],
    ["Takeoff",   times.takeoffMin],
  ];

  return [
    `Crew Timing (Zulu = Local ${offsetStr})`,
    ...lines.map(([label, zuluMins]) => {
      const local = fmtLocalPlain(zuluMins, tkIcao);
      return `${label}: ${local}`;
    })
  ].join("\n");
}

async function copyTextToClipboard(text){
  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
      return true;
    }
  }catch(_){}

  try{
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.setAttribute("readonly", "");
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    ta.style.top = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    document.body.removeChild(ta);
    return ok;
  }catch(_){
    return false;
  }
}

let crewToastEl = null;

function showCrewTextCopied(ok){
  if(crewToastEl) crewToastEl.remove();

  const el = document.createElement("div");
  el.textContent = ok ? "Crew text copied ✅" : "Copy failed — see console.";
  el.style.position = "fixed";
  el.style.left = "50%";
  el.style.bottom = "18px";
  el.style.transform = "translateX(-50%)";
  el.style.zIndex = "9999";

  el.style.padding = "10px 12px";
  el.style.borderRadius = "10px";
  el.style.boxShadow = "0 8px 24px rgba(0,0,0,0.18)";
  el.style.fontFamily = "Arial, sans-serif";
  el.style.fontSize = "13px";
  el.style.fontWeight = "800";
  el.style.letterSpacing = "0.3px";

  el.style.background = ok ? "#ffffff" : "#fff3cd";
  el.style.color = ok ? "#1f2a44" : "#8b0000";
  el.style.border = ok ? "1px solid #cfcfcf" : "1px solid #d6b656";

  document.body.appendChild(el);
  crewToastEl = el;

  setTimeout(() => {
    if(crewToastEl){
      crewToastEl.remove();
      crewToastEl = null;
    }
  }, 1400);
}


  
  function showRuntimeError(err){
  const out = document.getElementById("output");
  if(!out) return;
  out.innerHTML = `
    <div style="margin-top:12px; padding:10px; border-radius:8px; background:#f8d7da;">
      <div style="font-weight:bold;">Something broke (runtime error)</div>
      <div style="margin-top:6px; font-family:Consolas, Menlo, 'Courier New', monospace; font-size:12px; white-space:pre-wrap;">
        ${String(err && err.message ? err.message : err)}
      </div>
      <div style="margin-top:6px; font-size:12px; color:#333;">
        Copy/paste that error back to me and we’ll fix it fast.
      </div>
    </div>
  `;
}

function circadianClassFromLocalMins(localMins){
  if(localMins == null) return "";

  // Simple, editable banding (tune these later if you want)
  // Low: 0700–2159
  // Mod: 2200–2359 and 0600–0659
  // High: 0400–0559
  // Severe: 0000–0359
  const m = ((localMins % 1440) + 1440) % 1440;

  if(m < 240) return "circ-severe";     // 0000–0359
  if(m < 360) return "circ-high";       // 0400–0559
  if(m < 420) return "circ-mod";        // 0600–0659
  if(m < 1320) return "circ-low";       // 0700–2159
  return "circ-mod";                    // 2200–2359
}

function homeShowOrmClass(localMins){
  if(localMins == null) return "";
  const m = ((localMins % 1440) + 1440) % 1440;

  // Low: 0530–1400
  if(m >= 330 && m <= 840) return "orm-low";

  // Moderate: 1401–2000
  if(m >= 841 && m <= 1200) return "orm-mod";

  // High: 2001–0529 (wraps midnight)
  return "orm-high";
}

function homeShowOrmMessage(localMins){
  if(localMins == null) return "";
  const cls = homeShowOrmClass(localMins);

  if(cls === "orm-low")  return "ORM Low: Home Station Show Time 0530-1400L";
  if(cls === "orm-mod")  return "ORM Moderate: Home Station Show Time 1401-2000L";
  return "ORM High: Home Station Show Time 2001-0529L";
}

  
function setOutputIdle(message){
  const out = document.getElementById("output");
  if(!out) return;

  out.classList.add("idle");
out.style.display = "block";
out.style.opacity = "1";
out.innerHTML = message || "Enter inputs, then press Calculate";
}
  
function markDirty(){
  if(!hasCalculated) return;
  if(isCalculating) return;

  isDirty = true;

  const btn = document.getElementById("calcBtn");
  if(btn && btn.textContent !== "Re-Calculate"){
    btn.textContent = "Re-Calculate";
  }
}

function onUserEdit(){
  if(!hasCalculated) return;
  markDirty();
}
  
function clearDirty(){
  isDirty = false;

  const btn = document.getElementById("calcBtn");
  if(btn) btn.textContent = "Calculate";
}
  
function updateTimeHint(timeInput, hintEl){
  if(!hintEl) return;

  const raw = normHHMM(timeInput.value); // digits only, no padding

  // show nothing while typing fewer than 4 digits
  if(raw.length !== 4){
    hintEl.textContent = "";
    hintEl.classList.remove("bad");
    timeInput.classList.remove("invalid");
    return;
  }

  // only validate once they truly have 4 digits
  const ok = isHHMM(raw);
  hintEl.textContent = ok ? "" : "Invalid";

  // ensure invalid time is red, same as invalid ICAO
  if(ok){
    hintEl.classList.remove("bad");
    timeInput.classList.remove("invalid");
  }else{
    hintEl.classList.add("bad");
    timeInput.classList.add("invalid");
  }
}


function setCalcEnabled(){
  const tk = padHHMM(takeoffTime.value);
  const ld = padHHMM(landingTime.value);

  const ok = isHHMM(tk) && isHHMM(ld);

  const btn = document.getElementById("calcBtn");
  if(btn) btn.disabled = !ok;

  // Gentle idle guidance (pre-calculate only)
  if(!hasCalculated){
    const out = document.getElementById("output");
    if(out && out.classList.contains("idle")){
      const anyTyped =
        takeoffTime.value.trim().length > 0 ||
        landingTime.value.trim().length > 0;

      if(anyTyped && !ok){
        out.innerHTML = "Enter valid HHMM times (0000–2359), then press Calculate";
      }else{
        out.innerHTML = "Enter inputs, then press Calculate";
      }
    }
  }
}


function isHHMM(s){
  return typeof s === "string" && /^\d{4}$/.test(s) &&
    parseInt(s.slice(0,2),10) <= 23 && parseInt(s.slice(2,4),10) <= 59;
}
  
function hhmmToMinutes(hhmm){
  return parseInt(hhmm.slice(0,2),10)*60 + parseInt(hhmm.slice(2,4),10);
}
  
function minutesToHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  return String(Math.floor(mins/60)).padStart(2,"0") +
         String(mins%60).padStart(2,"0");
}
  
function minutesToHHMMZ(mins){ return minutesToHHMM(mins) + "Z"; 
}

function diffMinutes(start, end){
  let d = end - start;
  if(d < 0) d += 1440;
  return d;
}
  
function minutesToHPlusMM(mins){
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${h}+${String(m).padStart(2,"0")}`;
}
  
function parseHPlusMM(s){
  if(typeof s !== "string") return null;
  const t = s.trim();
  let m = t.match(/^(\d+)\+([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  m = t.match(/^(\d+):([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  return null;
}
  
function isICAO(s){
  return typeof s === "string" && /^[A-Z]{4}$/.test(s.trim().toUpperCase());
}

function normHHMM(s){
  // keep only digits, max 4
  return String(s || "").replace(/\D/g,"").slice(0,4);
}

function padHHMM(s){
  const d = normHHMM(s);          // digits only, up to 4
  if(d.length === 3) return "0" + d;  // 930 -> 0930
  return d;                       // 0-2 digits: leave as-is, 4 digits: keep
}
  
function normICAO(s){
  // keep only letters, max 4, uppercase
  return String(s || "").replace(/[^a-z]/gi,"").slice(0,4).toUpperCase();
}

function updateIcaoHint(icao, hintEl){
  if(!hintEl) return;

  const key = normICAO(icao);

  // Only show something once it's truly "ICAO shaped"
  if(key.length !== 4){
    hintEl.textContent = "";
    hintEl.classList.remove("bad");

    const inp = hintEl.previousElementSibling;
    if(inp && inp.classList.contains("box")){
      inp.classList.remove("invalid");
    }
    return;
  }

  // ICAO looks valid, but isn't mapped
  if(!getTimeZoneFromICAO(key)){
    hintEl.textContent = "Invalid";
    hintEl.classList.add("bad");

    const inp = hintEl.previousElementSibling;
    if(inp && inp.classList.contains("box")){
      inp.classList.add("invalid");
    }
    return;
  }

  // Mapped — clear
  hintEl.textContent = "";
  hintEl.classList.remove("bad");

  const inp = hintEl.previousElementSibling;
  if(inp && inp.classList.contains("box")){
    inp.classList.remove("invalid");
  }
}

function formatDayShift(n){
  if(!n) return "";
  return n > 0 ? `+${n}` : `${n}`;   // +1, -1, +2, etc.
}
  
function zuluToLocalWithDay(zuluMins, icao, zuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), zuluHHMM);
  if(off == null) return null;
  const raw = zuluMins + off;                   // can be <0 or >=1440
  const dayShift = Math.floor(raw / 1440);      // -1, 0, +1 (or more)
  const localMins = ((raw % 1440) + 1440) % 1440;
  return { localMins, dayShift };
}
  
function splitDayShift(rawMinutes){
  const dayShift = Math.floor(rawMinutes / 1440);               // -1,0,+1...
  const mins = ((rawMinutes % 1440) + 1440) % 1440;             // normalized 0..1439
  return { mins, dayShift };
}
  
function formatShiftSup(dayShift){
  if(dayShift === 0) return "";
  return dayShift > 0 ? `+${dayShift}` : `${dayShift}`;
}
  
function zuluHtml(mins){
  const dayShift = Math.floor(mins / 1440);
  const m = ((mins % 1440) + 1440) % 1440;

  const sh = formatShiftSup(dayShift);

  return `<span class="mono timewrap">${minutesToHHMM(m)}<span class="tz-sfx">Z</span>${sh ? `<span class="shift-sup">${sh}</span>` : ""}</span>`;
}

function localHtmlFromZuluSimple(zuluMins, icao){
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return "";

  // preserve absolute day context
  const baseShift = Math.floor(zuluMins / 1440);
  const zNorm = ((zuluMins % 1440) + 1440) % 1440;
  const zHHMM = minutesToHHMM(zNorm);

  const res = zuluToLocalWithDay(zNorm, icao, zHHMM);
  if(!res) return "";

  const totalShift = baseShift + res.dayShift;
  const sh = formatShiftSup(totalShift);

  return `<span class="mono timewrap">${minutesToHHMM(res.localMins)}<span class="tz-sfx">L</span>${sh ? `<span class="shift-sup">${sh}</span>` : ""}</span>`;
}

function localHtmlAtRawZulu(rawZuluMinutes, icao, anchorHHMM){
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return "";
  const zMins = ((rawZuluMinutes % 1440) + 1440) % 1440;
  const zHHMM = anchorHHMM || minutesToHHMM(zMins);
  const res = zuluToLocalWithDay(zMins, icao, zHHMM);
  if(!res) return "";
  const base = `${minutesToHHMM(res.localMins)}L`;
  const sh = formatShiftSup(res.dayShift);
  return sh ? `${base}<span class="shift-sup">${sh}</span>` : base;
}

function row3Html(label, zuluMinutes, localIcao, showLocal, extraClass="", midHtml=""){
  const z = zuluHtml(zuluMinutes);

  // TIMING rows: Label | spacer | Local | Zulu
  if(showLocal){
    const local = localHtmlFromZuluSimple(zuluMinutes, localIcao);

    // If you ever want “extra text” in the spacer column for timing rows, it can go here.
    const spacer = midHtml || "";

    return `
      <div class="row3 timerow ${extraClass}">
        <span class="sc-label">${label}</span>
        <span class="mcol">${spacer}</span>
        <span class="lcol">${local}</span>
        <span class="zcol">${z}</span>
      </div>
    `;
  }

  // DUTY rows: Label | message/spacer | Zulu
  // (This matches Flight Duty Period “gold standard” layout.)
  return `
    <div class="row3 dutyrow ${extraClass}">
      <span class="sc-label">${label}</span>
      <span class="lcol">${midHtml || ""}</span>
      <span class="zcol">${z}</span>
    </div>
  `;
}

// 4-column row for Show Time: Label | ORM message | Local | Zulu
function row4Html(label, zuluMinutes, localIcao, ormHtml="", extraClass=""){
  const z = zuluHtml(zuluMinutes);
  const local = localHtmlFromZuluSimple(zuluMinutes, localIcao);

  return `
    <div class="row4 ${extraClass}">
      <span class="sc-label">${label}</span>
      <span class="mcol">${ormHtml || ""}</span>
      <span class="lcol">${local}</span>
      <span class="zcol">${z}</span>
    </div>
  `;
}
  
// ---------- Phase 1.5: ICAO lookup wrapper (preps for big DB later) ----------
let ICAO_TZ_DB = null; // optional external DB (Phase 2-ready)

// optional: later you can load this from a JSON file without changing the rest of the code
async function loadIcaoDb(){
  try{
    // If you add "icao_tz_db.json" in the same folder as this HTML, this will work.
    // Example JSON shape: { "KADW":"America/New_York", "EGLL":"Europe/London", ... }
    const res = await fetch("icao_tz_db.json", { cache: "no-store" });
    if(!res.ok) return;
    ICAO_TZ_DB = await res.json();
    console.log("[ICAO DB] Loaded entries:", Object.keys(ICAO_TZ_DB).length);
  }catch(_){
    // silent fail — we just fall back to the built-in map
  }
}

// run once at page load (safe even if no JSON exists)
loadIcaoDb();

/* ----------------- ICAO -> Time Zone (Phase 1 / Step 1) ----------------- */
const ICAO_TIMEZONE = {
  /* ===================== CONUS ===================== */
  KADW: "America/New_York",     // Andrews AFB
  KDOV: "America/New_York",     // Dover AFB
  KCHS: "America/New_York",     // Charleston AFB
  KJFK: "America/New_York",
  KLGA: "America/New_York",
  KEWR: "America/New_York",
  KIAD: "America/New_York",
  KDCA: "America/New_York",

  KORD: "America/Chicago",
  KDFW: "America/Chicago",
  KDEN: "America/Denver",

  KTCM: "America/Los_Angeles", // McChord
  KSEA: "America/Los_Angeles",
  KLAX: "America/Los_Angeles",
  KSFO: "America/Los_Angeles",
  KSUU: "America/Los_Angeles", // Travis AFB

  KPHX: "America/Phoenix",     // no DST
  KDMA: "America/Phoenix",     // Davis-Monthan

  PHNL: "Pacific/Honolulu",   // Hickam / JBPHH

  /* ===================== EUROPE / EUCOM ===================== */
  EGLL: "Europe/London",       // Heathrow
  EGGW: "Europe/London",       // Luton
  EGKK: "Europe/London",       // Gatwick
  EGUN: "Europe/London",       // Mildenhall
  EGUL: "Europe/London",       // Lakenheath

  ETAR: "Europe/Berlin",       // Ramstein
  ETSN: "Europe/Berlin",
  EDDM: "Europe/Berlin",       // Munich
  EDDF: "Europe/Berlin",       // Frankfurt

  LERT: "Europe/Madrid",       // Rota
  LEZG: "Europe/Madrid",

  LIRF: "Europe/Rome",         // Rome
  LIMC: "Europe/Rome",         // Milan

  EHAM: "Europe/Amsterdam",    // AMS
  LFPG: "Europe/Paris",        // CDG
  LOWW: "Europe/Vienna",       // Vienna

  /* ===================== CENTCOM ===================== */
  OTBH: "Asia/Qatar",           // Doha
  ORBI: "Asia/Baghdad",
  OKBK: "Asia/Kuwait",
  OAKN: "Asia/Kabul",

  OMDB: "Asia/Dubai",
  OMAA: "Asia/Dubai",           // Abu Dhabi

  OEJN: "Asia/Riyadh",          // Jeddah
  OERK: "Asia/Riyadh",          // Riyadh

  /* ===================== PACOM ===================== */
  RJTY: "Asia/Tokyo",           // Yokota
  RJTT: "Asia/Tokyo",           // Haneda
  RJAA: "Asia/Tokyo",           // Narita

  RKSO: "Asia/Seoul",           // Osan
  RKSI: "Asia/Seoul",           // Incheon

  ZSPD: "Asia/Shanghai",
  ZBAA: "Asia/Shanghai",        // Beijing

  RPLL: "Asia/Manila",

  WSSS: "Asia/Singapore",

  YSSY: "Australia/Sydney",
  YMML: "Australia/Melbourne",

  /* ===================== OTHER COMMON TDY ===================== */
  CYYZ: "America/Toronto",      // Toronto
  CYVR: "America/Vancouver",

  FAOR: "Africa/Johannesburg",
  FQMA: "Africa/Maputo",

  SBGR: "America/Sao_Paulo",    // São Paulo
};

function getTimeZoneFromICAO(icao){
  const key = (icao || "").trim().toUpperCase();

  // JSON DB first
  if(ICAO_TZ_DB && ICAO_TZ_DB[key]){
    const entry = ICAO_TZ_DB[key];

    // Your dataset format: { ..., "tz": "America/New_York", ... }
    if(entry && typeof entry === "object" && entry.tz) return entry.tz;

    // Future-proofing (other datasets sometimes use these)
    if(entry && typeof entry === "object" && entry.timezone) return entry.timezone;

    // If we ever switch to a flattened JSON: "KADW": "America/New_York"
    if(typeof entry === "string") return entry;
  }

  // Built-in fallback
  return ICAO_TIMEZONE[key] || null;
}

function getOffsetMinutesForTimeZone(timeZone, dateUtc){
  const fmt = new Intl.DateTimeFormat("en-US", {
    timeZone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hourCycle: "h23",
  });

  const parts = fmt.formatToParts(dateUtc);
  const get = (type) => parts.find(p => p.type === type)?.value;

  const y  = Number(get("year"));
  const mo = Number(get("month"));
  const d  = Number(get("day"));
  const h  = Number(get("hour"));
  const mi = Number(get("minute"));
  const s  = Number(get("second"));

  const asUtc = Date.UTC(y, mo - 1, d, h, mi, s);
  return Math.round((asUtc - dateUtc.getTime()) / 60000);
}

function getUtcOffsetMinutesFromICAO(icao, hhmm){
  const tz = getTimeZoneFromICAO(icao);
  if(!tz) return null;

  const now = new Date();
  const y = now.getUTCFullYear();
  const m = now.getUTCMonth();
  const d = now.getUTCDate();

  let h = 0, mi = 0;
  if(typeof hhmm === "string" && /^\d{4}$/.test(hhmm)){
    h  = parseInt(hhmm.slice(0,2),10);
    mi = parseInt(hhmm.slice(2,4),10);
  }

  const dateUtc = new Date(Date.UTC(y, m, d, h, mi, 0));
  return getOffsetMinutesForTimeZone(tz, dateUtc);
}

function zuluToLocalMinutes(zuluMins, icao, zuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), zuluHHMM);
  if(off == null) return null;
  return zuluMins + off;
}

function localToZuluMinutes(localMins, icao, anchorZuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), anchorZuluHHMM);
  if(off == null) return null;
  return localMins - off;
}


/* ----------------- state ----------------- */
let hasCalculated = false;
let isDirty = false;
let isCalculating = false;   // NEW

let briefOffsetMin  = 150;   // 2+30
let stepOffsetMin   = 120;   // 2+00  (NEW)
let engineOffsetMin = 30;    // 0+30  (NEW)

let isEditingZulu = false;

let homeTouched = false;
let homeAutoFilled = false;
let suppressHomeTouch = false;

  
  /* Local time listeners (sync only; calculate only after first button press) */
const takeoffTime = document.getElementById("takeoffTime");
const homeICAO = document.getElementById("homeICAO");
const takeoffICAO = document.getElementById("takeoffICAO");
const takeoffLocal = document.getElementById("takeoffLocal");

const landingTime = document.getElementById("landingTime");
const landingICAO = document.getElementById("landingICAO");
const landingLocal = document.getElementById("landingLocal");
  
/* ----------------- main calc + render ----------------- */
function calculate(){
  try{
    const takeoff = padHHMM(takeoffTime.value);
    const landing = padHHMM(landingTime.value);
      // Snap the UI to normalized values (only if we can)
      if(takeoffTime.value !== takeoff) takeoffTime.value = takeoff;
      if(landingTime.value !== landing) landingTime.value = landing;
    const augmented = augmentedBox.checked;
const out = document.getElementById("output");

// Only animate expand on first-time Calculate (idle -> expanded)
const doExpandAnim = out.classList.contains("idle");

// results mode
out.classList.remove("idle");
out.style.display = "block";
    
// Only animate expand on first-time Calculate (idle -> expanded)
// Re-Calculate should update in place without re-animating or scrolling

if(doExpandAnim){
  const prevTransition = out.style.transition;
  out.style.transition = "none";
  out.classList.add("collapsing");
  out.getBoundingClientRect();
  out.style.transition = prevTransition;
}else{
  out.classList.remove("collapsing");
}
    // if the brief offset editor exists (from a previous render), honor it on every calculate
    const existingBrief = document.getElementById("briefOffsetEdit");
    if(existingBrief){
      const v = parseHPlusMM(existingBrief.value);
      if(v != null) briefOffsetMin = v;
    }

const existingStep = document.getElementById("stepOffsetEdit");
if(existingStep){
  const v = parseHPlusMM(existingStep.value);
  if(v != null) stepOffsetMin = v;
}

const existingEngine = document.getElementById("engineOffsetEdit");
if(existingEngine){
  const v = parseHPlusMM(existingEngine.value);
  if(v != null) engineOffsetMin = v;
}
    
    const takeoffMin = hhmmToMinutes(takeoff);
    const landingMin = hhmmToMinutes(landing);
    // For local-time output rows (crew timing uses takeoff ICAO)
    const tkIcao = normICAO(takeoffICAO.value);
    const ldIcao = normICAO(landingICAO.value);

// Safety net: if Home is blank at Calculate, use Takeoff ICAO (UI feedback + correct math)
if(homeICAO){
  const h = normICAO(homeICAO.value || "");
  const tkMapped = (tkIcao.length === 4 && getTimeZoneFromICAO(tkIcao));

  if(h.length === 0 && tkMapped){
    suppressHomeTouch = true;
    homeICAO.value = tkIcao;
    suppressHomeTouch = false;

    homeAutoFilled = true;
    updateIcaoHint(tkIcao, document.getElementById("homeIcaoHint"));
  }
}
    
    const showTime   = takeoffMin - 195;
    
const homeIcao = normICAO(homeICAO?.value || "");
const homeTz = homeIcao ? getTimeZoneFromICAO(homeIcao) : null;
const homeKey = homeTz ? homeIcao : tkIcao;

let homeShowLocalMins = null;
if(isICAO(homeKey) && getTimeZoneFromICAO(homeKey)){

  const zNorm = ((showTime % 1440) + 1440) % 1440;
  const zHHMM = minutesToHHMM(zNorm);
  const res = zuluToLocalWithDay(zNorm, homeKey, zHHMM);
  if(res) homeShowLocalMins = res.localMins; // only for circadian banding
}

const showCircClass = homeShowOrmClass(homeShowLocalMins);  // reuse ORM colors: orm-low / orm-mod / orm-high

const homeShowHtml = (homeShowLocalMins == null)
  ? ""
  : localHtmlFromZuluSimple(showTime, homeKey);

const homeShowOrmText =
  showCircClass === "orm-low" ? "ORM Low" :
  showCircClass === "orm-mod" ? "ORM Moderate" :
  showCircClass === "orm-high" ? "ORM High" :
  "";
    
    const crewRest   = takeoffMin - 915;
    const lastBeer   = takeoffMin - 720;
    const legalAlert = takeoffMin - 255;

const briefTime  = takeoffMin - briefOffsetMin;

const stepTime   = takeoffMin - stepOffsetMin;
const engine     = takeoffMin - engineOffsetMin;


    // Treat landing as "next day" if it’s earlier than takeoff on the clock
    const landingAbs = landingMin + (landingMin < takeoffMin ? 1440 : 0);
    
    // Use absolute timeline for flight time
    const flightMin = landingAbs - takeoffMin;
    const flightHrs = (flightMin / 60).toFixed(1);

    const fdp = augmented ? 1440 : 960;
    const cdp = augmented ? 1485 : 1080;
    const tdp = 720;
    const apu = augmented ? 1080 : 720;

    // Use the SAME absolute landing for duty/ORM math
    const landingFromShow = landingAbs - showTime;

    // FDP = KING (includes "exceed" behavior)
    function ormClassFdp(limitMinutes){
      if(limitMinutes <= 0) return "";
      if(landingFromShow > limitMinutes) return "orm-exceed";
      const ratio = landingFromShow / limitMinutes;
      if(ratio >= 0.95) return "orm-severe";
      if(ratio >= 0.90) return "orm-high";
      if(ratio >= 0.75) return "orm-mod";
      return "orm-low";
    }

    // CDT/TDD/APU = muted colors only (NO exceed behavior)
    function ormClassMuted(limitMinutes){
      if(limitMinutes <= 0) return "";
      const ratio = landingFromShow / limitMinutes;
      if(ratio >= 0.95) return "ormm-severe";
      if(ratio >= 0.90) return "ormm-high";
      if(ratio >= 0.75) return "ormm-mod";
      return "ormm-low";
    }

    // FDP-only message
    function ormMessageFdp(limitMinutes){
      if(limitMinutes <= 0) return "";
      if(landingFromShow > limitMinutes){
        return "Mission NO-GO. Max Duty Day Exceeded";
      }
      const ratio = landingFromShow / limitMinutes;
      if(ratio >= 0.95) return "ORM Severe: >95% of Max Duty Day";
      if(ratio >= 0.90) return "ORM High: 90-95% of Max Duty Day";
      if(ratio >= 0.75) return "ORM Moderate: 75-90% of Max Duty Day";
      return "ORM Low: <75% of Max Duty Day";
    }

    out.innerHTML = `
      <div class="sc-head timing-head" style="font-weight:900;text-align:center;">Crew Timing</div>
      <div class="crew-timing">

      ${row3Html("Enter Crew Rest", crewRest, tkIcao, true)}
      <div class="subtext">T/O − 15+15</div>

      ${row3Html("Last Beer", lastBeer, tkIcao, true)}
      <div class="subtext">T/O − 12+00</div>

      ${row3Html("Legal for Alert", legalAlert, tkIcao, true)}
      <div class="subtext">T/O − 4+15</div>

${row3Html(
  `<span class="showtime-inline">Show Time${
    (() => {
      if(homeShowLocalMins == null) return "";

      // Recompute local + day shift for Show Time using absolute context
      const baseShift = Math.floor(showTime / 1440);
      const zNorm = ((showTime % 1440) + 1440) % 1440;
      const zHHMM = minutesToHHMM(zNorm);
      const res = zuluToLocalWithDay(zNorm, homeKey, zHHMM);

      // Build circadian time using the SAME renderer as other Local times (monospace + correct +1/-1)
      let circHtml = "";
    if(res){
      const totalShift = baseShift + res.dayShift;
      const sh = formatShiftSup(totalShift);

      circHtml = `<span class="mono timewrap">${minutesToHHMM(homeShowLocalMins)}<span class="tz-sfx">L</span>${
      sh ? `<span class="shift-sup">${sh}</span>` : ""
      }</span>`;
      }else{
      // Fallback (should be rare)
      circHtml = `<span class="mono timewrap">${minutesToHHMM(homeShowLocalMins)}<span class="tz-sfx">L</span></span>`;
    }

      const msg = homeShowOrmText
      ? `${homeShowOrmText}: Circadian Time – <span class="showtime-circ">${circHtml}</span>`
      : `Circadian Time – <span class="showtime-circ">${circHtml}</span>`;

      return ` <span class="show-orm-inline">${msg}</span>`;
})()
}</span>`,
  showTime,
  tkIcao,
true,
`${showCircClass} showtime`
)}

<div class="subtext">T/O − 3+15</div>

      ${row3Html("Brief Time", briefTime, tkIcao, true)}
       <div class="subtext">
          <span class="subtext-line">
            T/O − <input id="briefOffsetEdit" class="inline-mini"
            value="${minutesToHPlusMM(briefOffsetMin)}" maxlength="5"
            title="H+MM (e.g., 2+30)">
           </span>
        </div>


${row3Html("Step Time", stepTime, tkIcao, true)}
<div class="subtext">
  <span class="subtext-line">
    T/O − <input id="stepOffsetEdit" class="inline-mini"
    value="${minutesToHPlusMM(stepOffsetMin)}" maxlength="5"
    title="H+MM (e.g., 2+00)">
  </span>
</div>

${row3Html("Engine Start", engine, tkIcao, true)}
<div class="subtext">
  <span class="subtext-line">
    T/O − <input id="engineOffsetEdit" class="inline-mini"
    value="${minutesToHPlusMM(engineOffsetMin)}" maxlength="5"
    title="H+MM (e.g., 0+30)">
  </span>
</div>


      ${row3Html("Takeoff", takeoffMin, tkIcao, true)}
      <div class="subtext">T/O − 0+00</div>

      ${row3Html("Landing", landingAbs, ldIcao, true)}
      <div class="subtext">LND − 0+00</div>

    </div>
      <hr>

      <div class="row flight-time">
        <span class="sc-label">Flight Time</span>
          <span>
        <span class="mono">${flightHrs}</span>
        <span class="sc-label"> hrs</span>
          </span>
      </div>

      <hr>

      <div class="sc-head duty-head" style="font-weight:900;text-align:center;">Crew Duty Limitations</div>

      ${row3Html(
        "Flight Duty Period",
        showTime + fdp,
        "",
        false,
        ormClassFdp(fdp),
        `<span class="orm-note">${ormMessageFdp(fdp)}</span>`
      )}
      <div class="subtext">Show + ${minutesToHPlusMM(fdp)}</div>

      ${row3Html("Crew Duty Time", showTime + cdp, "", false, ormClassMuted(cdp))}
      <div class="subtext">Show + ${minutesToHPlusMM(cdp)}</div>

      ${row3Html("Transition Duty Day", showTime + tdp, "", false, ormClassMuted(tdp))}
      <div class="subtext">Show + ${minutesToHPlusMM(tdp)}</div>

      ${row3Html("Autopilot INOP FDP", showTime + apu, "", false, ormClassMuted(apu))}
      <div class="subtext">Show + ${minutesToHPlusMM(apu)}</div>

<hr>
<div class="output-actions">
  <button id="resetBtn2" type="button">Reset</button>
  <button id="crewTextBtn" type="button" disabled>Generate Crew Text</button>
</div>
      
    `;

requestAnimationFrame(() => {
  // One more frame ensures the collapsed state is definitely painted
  requestAnimationFrame(() => {
   if(doExpandAnim){
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      out.classList.remove("collapsing");
    });
  });
}else{
  out.classList.remove("collapsing");
}
    
// Phase 3: no inner scroll panels on any device
// setTimeout(() => {
//   out.classList.add("fixed-expanded");
// }, 280);

  });
});

    
const reset2 = document.getElementById("resetBtn2");
reset2?.addEventListener("click", () => {
  resetAll({ scrollToTop: true });
});

const crewTextBtn = document.getElementById("crewTextBtn");
if(crewTextBtn){
  // enable only after Calculate
  crewTextBtn.disabled = false;

  // Build the text fresh each Calculate (so it always matches current numbers)
  lastCrewText = buildCrewText(tkIcao, {
    crewRest,
    legalAlert,
    showTime,
    briefTime,
    stepTime,
    takeoffMin,
  });

  crewTextBtn.addEventListener("click", async () => {
    const ok = await copyTextToClipboard(lastCrewText);
    showCrewTextCopied(ok);
    if(!ok) console.log("Crew text:\n" + lastCrewText);
  });
}
    
    // live-update brief time after first Calculate, without needing to click again
    const offInp = document.getElementById("briefOffsetEdit");
    offInp?.addEventListener("input", (e) => {
      const v = parseHPlusMM(e.target.value);
      if(v == null) return;
      briefOffsetMin = v;
    });

const stepInp = document.getElementById("stepOffsetEdit");
stepInp?.addEventListener("input", (e) => {
  const v = parseHPlusMM(e.target.value);
  if(v == null) return;
  stepOffsetMin = v;
});

const engInp = document.getElementById("engineOffsetEdit");
engInp?.addEventListener("input", (e) => {
  const v = parseHPlusMM(e.target.value);
  if(v == null) return;
  engineOffsetMin = v;
});

    
    setCalcEnabled();

  }catch(err){
    showRuntimeError(err);
  }
}


/* ----------------- local time sync ----------------- */
let suppressSync = false;

function syncLocalFromZulu(zuluInput, icaoInput, localInput, dayElId){
  if(isEditingZulu) return;
  if(suppressSync) return;

  const dayEl = document.getElementById(dayElId);
const localHintEl = document.getElementById(
  localInput.id === "takeoffLocal" ? "takeoffLocalHint" : "landingLocalHint"
);
  const icao = normICAO(icaoInput.value);

// update the hint (takeoff or landing)
updateIcaoHint(icao, document.getElementById(
  icaoInput.id === "takeoffICAO" ? "takeoffIcaoHint" : "landingIcaoHint"
));

// If ICAO is fully blank: clear Local + day marker (prevents stale local time)
if(icao.length === 0){
  suppressSync = true;
  localInput.value = "";
  if(dayEl) dayEl.textContent = "";
  if(localHintEl) updateTimeHint(localInput, localHintEl);
  suppressSync = false;
  return;
}

// If ICAO is not ready/valid/mapped yet: don’t fight the user while typing
if(!isICAO(icao) || !getTimeZoneFromICAO(icao)){
  suppressSync = true;
  if(dayEl) dayEl.textContent = "";
  suppressSync = false;
  return;
}

const z = zuluInput.value.trim();
if(!isHHMM(z)){
  // If Zulu isn't valid yet, do NOT wipe Local.
  // Local-first users may have typed Local already.
  suppressSync = true;
  if(dayEl) dayEl.textContent = "";
  suppressSync = false;
  return;
}

  const zM = hhmmToMinutes(z);
  const res = zuluToLocalWithDay(zM, icao, z);

  suppressSync = true;

  if(res == null){
    localInput.value = "";
    if(dayEl) dayEl.textContent = "";
  } else {
    localInput.value = minutesToHHMM(res.localMins);
    if(dayEl) dayEl.textContent = formatDayShift(res.dayShift);
  }

  // NEW: keep Local hint in sync when we auto-write Local
  if(localHintEl) updateTimeHint(localInput, localHintEl);


  suppressSync = false;
}

function syncZuluFromLocal(localInput, icaoInput, zuluInput){
  if(suppressSync) return;

  const icao = normICAO(icaoInput.value);
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return; // need ICAO + mapping

  const l = localInput.value.trim();
  if(!isHHMM(l)) return;

  const lM = hhmmToMinutes(l);

  // Anchor offset to what's currently in the Zulu box if valid, else "0000"
  const zAnchor = (zuluInput.value && isHHMM(zuluInput.value.trim())) ? zuluInput.value.trim() : "0000";

  const zM = localToZuluMinutes(lM, icao, zAnchor);
  if(zM == null) return;

  suppressSync = true;
  zuluInput.value = minutesToHHMM(zM);
  suppressSync = false;
}

/* ----------------- bindings ----------------- */
const augmentedBox = document.getElementById("augmented");
const augLbl = document.getElementById("augLbl");

function syncToggleLabels(){
  // CSS controls the visual state; no inline styles here.
}
  
augmentedBox.addEventListener("change", () => {
  syncToggleLabels();

  // mark changes so Calculate -> Re-Calculate (but do NOT auto-run)
  onUserEdit();

  // keep button enabled/disabled based on time validity
  setCalcEnabled();
});

syncToggleLabels();

document.getElementById("calcBtn").addEventListener("click", () => {
  isCalculating = true;

  hasCalculated = true;
  isDirty = false;
  clearDirty();
  
const shouldScroll = document.getElementById("output")?.classList.contains("idle");
  calculate();

  // smooth scroll to results (after DOM updates)
  requestAnimationFrame(() => {
const outEl = document.getElementById("output");
if(outEl && shouldScroll){
  outEl.scrollIntoView({ behavior:"smooth", block:"start" });
}

  });

  isCalculating = false;
});

document.getElementById("resetBtn").addEventListener("click", () => {
  resetAll({ scrollToTop: false });
});

function resetAll({ scrollToTop = false } = {}){
  // clear inputs
  takeoffTime.value = "";
  landingTime.value = "";
  takeoffICAO.value = "";
  landingICAO.value = "";
  homeICAO.value = "";
  takeoffLocal.value = "";
  landingLocal.value = "";

  homeTouched = false;
  homeAutoFilled = false;

  
  // clear day shift badges
  const tDay = document.getElementById("takeoffLocalDay");
  const lDay = document.getElementById("landingLocalDay");
  if(tDay) tDay.textContent = "";
  if(lDay) lDay.textContent = "";

  // reset state + output
    // clear ALL hints immediately (must happen before any early-return)
[
  "takeoffIcaoHint", "landingIcaoHint", "homeIcaoHint",
  "takeoffTimeHint", "landingTimeHint",
  "takeoffLocalHint", "landingLocalHint"
  ].forEach(id => {
    const el = document.getElementById(id);
    if(el){
      el.textContent = "";
      el.classList.remove("bad");
    }
  });

// Clear any red borders on inputs
document.querySelectorAll("input.box.invalid").forEach(el => el.classList.remove("invalid"));
  
  hasCalculated = false;
  isDirty = false;
  clearDirty();                 // puts button text back to "Calculate"
  briefOffsetMin  = 150;
  stepOffsetMin   = 120;
  engineOffsetMin = 30;


const out = document.getElementById("output");
if(out){
    delete out.dataset.expandedH; // force fresh measure next time
  // Ensure output is measurable
  out.style.display = "block";
// --- TOP RESET SAFETY: prevent "pop open then collapse" ---
  out.classList.remove("collapsing");
  out.classList.remove("collapsing-to-idle");
  out.style.removeProperty("--idleScale");

// If we're already idle, just stay idle (no animation, no flashes)
if(out.classList.contains("idle")){
  out.classList.remove("fixed-expanded");
  out.style.height = "";
  out.style.overflow = "";
  setOutputIdle("Enter inputs, then press Calculate");
  takeoffTime.focus({ preventScroll: true });
  return;
}

// Clear fixed-expanded lock BEFORE collapsing so it can't re-expand first
out.classList.remove("fixed-expanded");
out.style.height = "";
out.style.overflow = "";
out.getBoundingClientRect(); // commit cleared state

  
// Ensure we're in a stable expanded layout height before collapsing
if(out.dataset.expandedH){
    out.classList.add("fixed-expanded");
    out.style.height = out.dataset.expandedH + "px";
    out.style.overflow = "hidden"; // page doesn't reflow during collapse
  }
  out.classList.remove("collapsing");
  out.classList.remove("collapsing-to-idle");
  out.style.removeProperty("--idleScale");
  out.getBoundingClientRect(); // commit

  // Ensure we're not in idle mode while collapsing (prevents style flicker)
  out.classList.remove("idle");

  // Force a style flush so the transition always fires
  out.getBoundingClientRect();

  // Start visual-only collapse (doesn't change layout height)
  // Compute the target idle scale so we shrink directly to idle size (not to zero)
const startHeight2 = out.getBoundingClientRect().height;

  // --- shrink directly to fixed idle size (52px), no clone measurement ---
out.classList.remove("collapsing");          // important: prevent "expand blip"
out.classList.remove("collapsing-to-idle");  // clear any prior state

const startH = Math.max(1, out.getBoundingClientRect().height);
const idleH = 52; // must match .output.idle height in CSS
const idleScale = Math.max(0.15, Math.min(1, idleH / startH));
out.style.setProperty("--idleScale", String(idleScale));

out.classList.add("collapsing-to-idle");
  
// Start scroll-to-top immediately (so it happens during the collapse)
if(scrollToTop){
  const root = document.getElementById("pageRoot");
  if(root && root.scrollIntoView){
    root.scrollIntoView({ behavior: "smooth", block: "start" });
  }else{
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
}
  const finish = () => {
    out.removeEventListener("transitionend", onEnd);

    // Swap to idle content while still invisible (prevents “Crew Timing” flash)
    // Swap to idle content cleanly (no flash)
    const prevTransition = out.style.transition;
      out.style.transition = "none";
      out.style.transition = prevTransition;

    requestAnimationFrame(() => {
  // End the shrink animation state
  out.classList.remove("collapsing-to-idle");
  out.style.removeProperty("--idleScale");

  // Release the fixed expanded panel so idle can be its fixed small size
  out.classList.remove("fixed-expanded");
  out.style.height = "";
  out.style.overflow = "";

  // Now snap to idle content (no animation / no flash)
  setOutputIdle("Enter inputs, then press Calculate");

  // Focus without causing scroll jumps
  takeoffTime.focus({ preventScroll: true });
});
  };

  const onEnd = (e) => {
    // Fire only once, when the transform transition ends
    if(e.propertyName === "transform") finish();
  };

  out.addEventListener("transitionend", onEnd);

  // Safety fallback in case transitionend doesn't fire
  setTimeout(finish, 350);
}

  // optional: reset crew toggle to Basic
  augmentedBox.checked = false;
  syncToggleLabels();

  // Time hints (red "Invalid time" under Zulu)
  const tkTimeHint = document.getElementById("takeoffTimeHint");
  const ldTimeHint = document.getElementById("landingTimeHint");
  if(tkTimeHint) tkTimeHint.textContent = "";
  if(ldTimeHint) ldTimeHint.textContent = "";

  // Local hints (red "Invalid time" under Local)
  const tkLocalHint = document.getElementById("takeoffLocalHint");
  const ldLocalHint = document.getElementById("landingLocalHint");
  if(tkLocalHint) tkLocalHint.textContent = "";
  if(ldLocalHint) ldLocalHint.textContent = "";


  // recalc button enabled/disabled correctly
  setCalcEnabled();
}

[takeoffTime, landingTime].forEach(inp => {
  inp.addEventListener("focus", () => {
    isEditingZulu = true;
  });

  inp.addEventListener("blur", () => {
    isEditingZulu = false;
  });
});
  
[takeoffTime, landingTime, takeoffLocal, landingLocal].forEach(inp => {
  inp.addEventListener("input", () => {
    const clean = normHHMM(inp.value);
    if(inp.value !== clean) inp.value = clean;

    if(inp === takeoffTime) updateTimeHint(takeoffTime, document.getElementById("takeoffTimeHint"));
    if(inp === landingTime) updateTimeHint(landingTime, document.getElementById("landingTimeHint"));

    // NEW: Local time gentle validation (does not affect Calculate enable)
    if(inp === takeoffLocal) updateTimeHint(takeoffLocal, document.getElementById("takeoffLocalHint"));
    if(inp === landingLocal) updateTimeHint(landingLocal, document.getElementById("landingLocalHint"));

    setCalcEnabled();
    onUserEdit();
  });
});

[takeoffTime, landingTime, takeoffLocal, landingLocal].forEach(inp => {
  inp.addEventListener("blur", () => {
    const padded = padHHMM(inp.value);
    if(inp.value !== padded) inp.value = padded;

    // After snapping, re-sync the paired fields
    if(inp === takeoffTime) syncLocalFromZulu(takeoffTime, takeoffICAO, takeoffLocal, "takeoffLocalDay");
    if(inp === landingTime) syncLocalFromZulu(landingTime, landingICAO, landingLocal, "landingLocalDay");
    if(inp === takeoffLocal) syncZuluFromLocal(takeoffLocal, takeoffICAO, takeoffTime);
    if(inp === landingLocal) syncZuluFromLocal(landingLocal, landingICAO, landingTime);
  });
});
  
[takeoffICAO, landingICAO].forEach(inp => {
  inp.addEventListener("input", () => {
    const clean = normICAO(inp.value);
    if (inp.value !== clean) inp.value = clean;

    // update hint live as they type
    const hintId = (inp.id === "takeoffICAO") ? "takeoffIcaoHint" : "landingIcaoHint";
    updateIcaoHint(clean, document.getElementById(hintId));

    // NEW: re-sync local any time ICAO changes (including deleting it)
    const zuluInput  = (inp.id === "takeoffICAO") ? takeoffTime  : landingTime;
    const localInput = (inp.id === "takeoffICAO") ? takeoffLocal : landingLocal;
    const dayId      = (inp.id === "takeoffICAO") ? "takeoffLocalDay" : "landingLocalDay";

    syncLocalFromZulu(zuluInput, inp, localInput, dayId);

// --- Autofill Home Station ICAO from Takeoff ICAO (UI default) ---
if(inp.id === "takeoffICAO"){
  const tk = clean; // already normalized takeoff ICAO

  const tkMapped = (tk.length === 4 && getTimeZoneFromICAO(tk));
  const homeNow = normICAO(homeICAO?.value || "");

  // If Home is empty OR Home was previously auto-filled and user hasn't touched it,
  // keep Home synced to Takeoff ICAO.
  if(tkMapped && homeICAO && (!homeTouched) && (homeNow.length === 0 || homeAutoFilled)){
    suppressHomeTouch = true;
    homeICAO.value = tk;
    suppressHomeTouch = false;

    homeAutoFilled = true;

    updateIcaoHint(tk, document.getElementById("homeIcaoHint"));
    if(hasCalculated) onUserEdit();
  }

  // If user deletes Takeoff ICAO and Home was only auto-filled, clear Home too
  if(tk.length === 0 && homeICAO && homeAutoFilled && !homeTouched){
    suppressHomeTouch = true;
    homeICAO.value = "";
    suppressHomeTouch = false;

    homeAutoFilled = false;

    updateIcaoHint("", document.getElementById("homeIcaoHint"));
    if(hasCalculated) onUserEdit();
  }
}
    
    // Local-first support:
    // If user already typed Local, and ICAO just became valid/mapped, fill Zulu from Local.
    if(isICAO(clean) && getTimeZoneFromICAO(clean) && isHHMM(localInput.value.trim())){
      syncZuluFromLocal(localInput, inp, zuluInput);
      setCalcEnabled(); // important: button enables when Zulu is auto-filled
    }

    if (hasCalculated) onUserEdit();
  });
});

homeICAO?.addEventListener("input", () => {
  const clean = normICAO(homeICAO.value);
  if(homeICAO.value !== clean) homeICAO.value = clean;

  // If this was a user action (not our autofill), mark as touched
  if(!suppressHomeTouch){
    homeTouched = clean.length > 0;   // once they type something, we stop auto-overwriting
    homeAutoFilled = false;           // user took control
  }

  // If user clears Home, immediately snap it back to Takeoff ICAO (if available/mapped)
  if(clean.length === 0){
    const tk = normICAO(takeoffICAO?.value || "");
    const tkMapped = (tk.length === 4 && getTimeZoneFromICAO(tk));

    if(tkMapped){
      suppressHomeTouch = true;
      homeICAO.value = tk;
      suppressHomeTouch = false;

      homeTouched = false;     // user isn't "locking" it by clearing
      homeAutoFilled = true;

      updateIcaoHint(tk, document.getElementById("homeIcaoHint"));
      if(hasCalculated) onUserEdit();
      return;                  // we're done
    }
  }

  updateIcaoHint(clean, document.getElementById("homeIcaoHint"));

  // If results already exist, mark output stale (don’t auto-recalc)
  if(hasCalculated) onUserEdit();
});

[takeoffTime, takeoffICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(takeoffTime, takeoffICAO, takeoffLocal, "takeoffLocalDay");
}));
  
takeoffLocal.addEventListener("input", () => {
  syncZuluFromLocal(takeoffLocal, takeoffICAO, takeoffTime);
  setCalcEnabled(); // NEW: enable button once Zulu is auto-filled
  if(hasCalculated) onUserEdit();   // or markDirty(), whichever you're using
});

[landingTime, landingICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(landingTime, landingICAO, landingLocal, "landingLocalDay");
}));
landingLocal.addEventListener("input", () => {
  syncZuluFromLocal(landingLocal, landingICAO, landingTime);
  setCalcEnabled(); // NEW
  if(hasCalculated) onUserEdit();   // or markDirty()
});

/* ----------------- Phase 3: Info modal wiring ----------------- */
(function(){
  const overlay = document.getElementById("infoModal");
  const bodyEl  = document.getElementById("modalBody");
  const titleEl = document.getElementById("modalTitle");
  const closeBtn = document.getElementById("modalCloseBtn");

  if(!overlay || !bodyEl || !titleEl || !closeBtn) return;

  const titleMap = {
    disclaimer: "Disclaimer",
    feedback: "Feedback",
    credits: "Credits",
    donations: "Donations",
  };

  function openModal(key){
    const tpl = document.getElementById(`tpl-${key}`);
    if(!tpl) return;

    titleEl.textContent = titleMap[key] || "Info";
    bodyEl.innerHTML = "";
    bodyEl.appendChild(tpl.content.cloneNode(true));

    overlay.classList.add("open");
    overlay.setAttribute("aria-hidden", "false");

    // Prevent page scroll while modal is open (mobile-friendly)
    document.body.style.overflow = "hidden";
  }

  function closeModal(){
    overlay.classList.remove("open");
    overlay.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
  }

  // Link buttons
  document.querySelectorAll(".info-links button[data-modal]").forEach(btn => {
    btn.addEventListener("click", () => openModal(btn.dataset.modal));
  });

  // Close actions
  closeBtn.addEventListener("click", closeModal);

  overlay.addEventListener("click", (e) => {
    // click outside modal closes
    if(e.target === overlay) closeModal();
  });

  window.addEventListener("keydown", (e) => {
    if(e.key === "Escape" && overlay.classList.contains("open")){
      closeModal();
    }
  });
})();

  
setOutputIdle();

  setCalcEnabled();
</script>

</body>
</html>
