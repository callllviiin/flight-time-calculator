<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crew Dawg Calculator</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f7fa;
  margin:0;
  padding:20px;
  color:#222;
}

.app{
  width:100%;
  max-width:575px;
  margin:0 auto;
  padding:10px;
}

.headerbar{
  position:relative;
  margin:0 0 8px;
}

/* Title: centered, slightly larger, more authority */
.headerbar h1{
  margin:10px 0 10px;
  text-align:center;
  font-size:30px;     /* slightly larger */
  font-weight:800;    /* bolder */
  line-height:1.1;    /* tight, predictable baseline */
}
  
/* Title: small-caps look */
.app-title{
  font-variant: small-caps;
  letter-spacing: 1px;
}

/* Reset button aligned to title baseline */
.headerbar .icon-btn{
  position:absolute;
  right:0;
  bottom:0px;        /* aligns with bottom of title text */
}

.topbar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:8px;
  margin:0 0 12px;
  font-size:12px;
  color:#555;
}

.topbar input{ transform:translateY(1px); 
}

.icon-btn{
  width:32px;
  height:32px;
  border-radius:8px;
  border:2px solid #cfcfcf;
  background:#fff;
  cursor:pointer;
  font-size:28px;
  font-weight:700;   /* adds authority */
  line-height:1;
  display:grid;
  place-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  color:#1f2a44;
  padding:0;
}

.icon-btn:hover{ filter:brightness(0.98); 
}
.icon-btn:active{ transform:translateY(1px); 
}

/* Small hint under ICAO boxes (only shows when ICAO is valid-format but unmapped) */
.icao-hint{
  font-size:10px;
  font-weight:600;
  line-height:1.1;
  margin-top:2px;
  color:#666;
  min-height:12px;     /* keeps layout stable even when empty */
}

.icao-hint.bad{
  color:#8b0000;       /* subtle dark red */
}
  
/* ---------- TOP FORM (SINGLE GRID) ---------- */
.form-grid{
  display:grid;
  width: 100%;
  /* Fixed label column so inputs don’t get shoved right */
  grid-template-columns: 200px 104px 26px 104px 1fr;
  column-gap:4px;
  row-gap:20px;
  align-items:center;
  margin-top: 24px;
}

.form-row{
  display:contents;
  font-weight:bold;
}

.label{
  /* allow wrap so label column can stay narrow */
  white-space:normal;
  line-height:1.1;
}

/* Top form labels: small-caps / “manual” look */
.form-label{
  font-variant: small-caps;
  letter-spacing: 0.8px;
}
  
/* all three boxes same size */
.box{
  width:104px;
  padding:6px;
  font-size:16px;
  text-align:center;
  box-sizing:border-box;
}

input.box{
  vertical-align: middle;
}
  
input,
select{
  font-family: Consolas, Menlo, "Courier New", monospace;
}

input{
  letter-spacing: 1.5px;
  font-weight: 600;
}
  
/* Floating label wrapper (for Zulu + Local) */
.floating-wrap{
  position:relative;
  display:inline-block;
  width:104px;
}

.floating-label{
  position:absolute;
  left:8px;
  top:-9px;
  font-size:10px;
  color:#666;
  background:#f5f7fa;
  padding:0 4px;
  font-weight:normal;
}

/* Day shift indicator INSIDE the local input box */
.day-shift{
  position:absolute;
  right:6px;
  bottom:6px;          /* inside the box, bottom-right */
  font-size:10px;
  color:#666;
  font-weight:700;
  line-height:1;
  pointer-events:none; /* clicks go to the input */
  background:transparent;
}

/* Give Local inputs room so the +1/-1 doesn't overlap digits */
.local-wrap .box{
  padding-right:18px;
  padding-left:18px;
}

/* Subtle +1/-1 marker in OUTPUT (superscript style) */
.shift-sup{
  font-size:10px;
  color:#666;
  font-weight:700;
  margin-left:2px;
  vertical-align:super;
}
  
.at{
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
}

.icao-wrap{
  position:relative;
  width:104px;
}

.icao-wrap .box{
  width:100%;
}

.icao-hint{
  position:absolute;
  left:0;
  right:0;
  top:100%;
  margin-top:2px;

  font-size:10px;
  font-weight:600;
  line-height:1.1;
  color:#666;

  text-align:center;
  pointer-events:none;
  white-space:nowrap;
}

.icao-hint.bad{
  color:#8b0000;
}
  
/* slightly larger gap between ICAO and Local */
.local-wrap{ 
  margin-left:10px;
  justify-self:end;
}

/* ---------- ROW 3 ---------- */
.aircraft-crew-label{
  font-weight:bold;
}

.third-content-wide{
  grid-column: 2 / -1;    /* spans Zulu → Local columns */
  display:grid;
  grid-template-columns: auto 1fr auto;  /* left item, center space, right item */
  align-items:center;
  width: 100%;
  justify-self: stretch;
}
  
.third-content-wide > div:nth-child(1){
  justify-self:start;
}
.third-content-wide > div:nth-child(2){
  justify-self:center;
}
.third-content-wide > div:nth-child(3){
  justify-self:end;
}

.aircraft-wrap{ justify-self:start; }

#aircraft{
  width:120px;
  padding:6px;
  font-size:16px;
  box-sizing:border-box;
}

.crew-toggle{
  justify-self:end;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  white-space:nowrap;
}

.crew-label{
  font-weight:normal;
  color:#333;
}
.crew-label.active{ font-weight:bold; }

/* switch */
.switch{
  position:relative;
  width:52px;
  height:26px;
  flex:0 0 auto;
}
  
.switch input{
  position:absolute;
  opacity:0;
  width:1px;
  height:1px;
}

.slider{
  position:absolute;
  inset:0;
  background:#d0d0d0;
  border-radius:26px;
}
  
/* Visible focus ring when tabbing to the switch (robust) */
.switch:focus-within .slider{
  outline: 2px solid #ff8a3d;
  outline-offset: 2px; 
}
  
.slider:before{
  content:"◀";
  position:absolute;
  height:22px;
  width:22px;
  left:2px;
  top:2px;
  background:#fff;
  border-radius:50%;
  display:grid;
  place-items:center;
  font-size:12px;
  color:#444;
  transition:0.25s;
  box-shadow:0 1px 2px rgba(0,0,0,0.2);
}
input:checked + .slider:before{
  transform:translateX(26px);
  content:"▶";
}

/* ---------- BUTTON ---------- */
button{
  margin-top:20px;
  padding:14px 12px;
  font-size:20px;
  font-weight:800;
  font-variant: small-caps;
  letter-spacing:0.8px;
  width:100%;
  cursor:pointer;

  background:#1f2a44;      /* deep blue/gray */
  color:#fff;
  border:1px solid #141b2d;
  border-radius:10px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
}

button:hover{
  filter:brightness(1.05);
}

button:active{
  transform:translateY(1px);
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}

button:disabled{
  opacity:0.5;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}
  
/* ---------- OUTPUT ---------- */
.output{
  margin-top:28px;
  padding:20px;
  background:white;
  border-radius:8px;
  border:1px solid #1f2a44;  /* same as button background */
}

.output hr{
  margin:14px 0;
}
  
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-top:12px;
  font-weight:bold;
}

/* Output rows: label | local | zulu */
.row3{
  display:grid;
  grid-template-columns: 1fr auto auto;
  column-gap:10px;          /* tighter */
  align-items:center;
  margin-top:12px;
  font-weight:bold;
}

.row3 .lcol{
  text-align:right;
  font-weight:700;
  color:inherit;      /* same black as Zulu */
  min-width:70px;
  margin-right:40px;
}

.row3 .zcol{
  text-align:right;
  min-width:70px;
}

/* small-caps for left-column labels in output rows */
.sc-label{
  font-variant: small-caps;
  letter-spacing: 0.6px;
}

/* Section headers in output (Crew Timing, Crew Duty Limitations) */
.sc-head{
  font-variant: small-caps;
  letter-spacing: 1px;
}

/* Output times should look like your inputs */
.mono{
  font-family: Consolas, Menlo, "Courier New", monospace;
  letter-spacing: 1px;
  font-weight: 700;
}
  
.tz-sfx{
  font-size:10px;
  font-weight:700;
  margin-left:1px;
  opacity:0.8;
}
 
.subtext{
  font-size:12px;
  color:#666;
  margin-top:2px;
  margin-bottom:10px;
}

/* Small explanatory text in the "middle" column of Duty Limitations */
.orm-note{
  display:block;
  font-size:11px;
  font-weight:600;
  color:inherit;
  line-height:1.1;
  text-align:left;
  margin-right:0;      /* ensure it doesn't inherit "scoot" feeling */
}
  
.warn{
  background-color:#fff3cd;
  padding:4px 6px;
  border-radius:4px;
}

.danger{
  background-color:#f8d7da;
  padding:4px 6px;
  border-radius:4px;
}

/* ================= ORM bands (FDP = KING) ================= */
/* FDP: same strong fills, now with a darker border for definition */
.orm-low{
  background:#d4edda;
  border:1px solid #7bbf8b;     /* darker green border */
  padding:4px 6px;
  border-radius:4px;
}

.orm-mod{
  background:#fff3cd;
  border:1px solid #d6b656;     /* darker yellow border */
  padding:4px 6px;
  border-radius:4px;
}

.orm-high{
  background:#ffb74d;           /* strong amber/orange */
  border:1px solid #c77a16;     /* darker orange border */
  padding:4px 6px;
  border-radius:4px;
}

.orm-severe{
  background:#f44336;           /* strong red */
  border:1px solid #a10000;     /* darker red border */
  color:#000;                   /* keep black text */
  padding:4px 6px;
  border-radius:4px;
}
.orm-severe .tz-sfx{ color:#000; }

/* Exceeds limit: keep unchanged (your "emergency red" look) */
.orm-exceed{
  background:#c62828;
  color:#fff;
  padding:4px 6px;
  border-radius:4px;
  outline:2px solid #7f0000;
  outline-offset:-1px;
}
.orm-exceed .tz-sfx{
  color:#fff;
  opacity:1;
}

/* ================= Muted ORM bands (CDT/TDD/APU) ================= */
/* Softer fills, still readable, still scan-friendly */
.ormm-low{
  background:#eaf6ee;           /* muted green */
  border:1px solid #c7e7d0;
  padding:4px 6px;
  border-radius:4px;
}

.ormm-mod{
  background:#fff8e3;           /* muted yellow */
  border:1px solid #f1e0b6;
  padding:4px 6px;
  border-radius:4px;
}

.ormm-high{
  background:#ffe2bf;           /* muted orange */
  border:1px solid #f3c08a;
  padding:4px 6px;
  border-radius:4px;
}

.ormm-severe{
  background:#ffd1d1;           /* muted red */
  border:1px solid #f1a0a0;
  color:#000;
  padding:4px 6px;
  border-radius:4px;
}
.ormm-severe .tz-sfx{ color:#000; }

/* tiny offset editor for brief */
.inline-mini{
  width:48px;
  font-size:12px;
  padding:2px 4px;
  text-align:center;
  box-sizing:border-box;
  border-radius:4px;
  border:1px solid #cfcfcf;
  background:#fff;
}

/* ---------- DISCLAIMER / FOOTER ---------- */
.disclaimer{
  margin-top:40px;
  font-size:13px;
  color:#444;
  line-height:1.5;
  text-align:justify;
  text-justify:inter-word;
}

.footer{
  margin-top:40px;
  text-align:center;
  font-weight:bold;
}
  
.footer small{
  display:block;
  font-weight:normal;
  color:#666;
}

/* ---------- MOBILE ---------- */
@media (max-width:620px){
  .form-grid{
    grid-template-columns: max-content 1fr 26px 1fr 1fr;
  }
  .floating-wrap{ width:100%; }
  .box{ width:100%; }
  .icao-wrap{ width:100%; }
  .local-wrap{ margin-left:0; }

  .third-row-wrap{
    grid-template-columns: 1fr;
    row-gap:8px;
  }
  .third-content{
    grid-template-columns: 1fr;
    gap:10px;
  }
  .crew-toggle{ justify-self:end; }
}
</style>
</head>

<body>
<div id="pageRoot">

 <div class="app">

  <div class="headerbar">
    <h1 class="app-title">Crew Dawg Calculator</h1>
    <button id="resetBtn" class="icon-btn" title="Reset" tabindex="-1">
      &#x21bb;
    </button>
  </div>

    <div class="form-grid">

      <!-- Row 1 -->
      <div class="form-row">
        <div class="label form-label">Sched. Takeoff Time:</div>

        <div class="floating-wrap">
          <div class="floating-label">Zulu</div>
          <div id="takeoffTimeHint" class="icao-hint bad"></div>
          <input id="takeoffTime" class="box" placeholder="HHMM" maxlength="4" tabindex="1">
        </div>

        <div class="at">at</div>

      <div class="icao-wrap">
        <input id="takeoffICAO" class="box" placeholder="ICAO" maxlength="4" style="text-transform:uppercase;" tabindex="2">
        <div id="takeoffIcaoHint" class="icao-hint"></div>
      </div>

        <div class="floating-wrap local-wrap">
          <div class="floating-label">Local</div>
          <input id="takeoffLocal" class="box" placeholder="HHMM" maxlength="4" tabindex="3">
          <span id="takeoffLocalDay" class="day-shift"></span>
        </div>
      </div>

      <!-- Row 2 -->
      <div class="form-row">
        <div class="label form-label">Sched. Land Time:</div>

        <div class="floating-wrap">
          <div class="floating-label">Zulu</div>
          <div id="landingTimeHint" class="icao-hint bad"></div>
          <input id="landingTime" class="box" placeholder="HHMM" maxlength="4" tabindex="4">
        </div>

        <div class="at">at</div>

      <div class="icao-wrap">
        <input id="landingICAO" class="box" placeholder="ICAO" maxlength="4" style="text-transform:uppercase;" tabindex="5">
      <div id="landingIcaoHint" class="icao-hint"></div>
    </div>


        <div class="floating-wrap local-wrap">
          <div class="floating-label">Local</div>
          <input id="landingLocal" class="box" placeholder="HHMM" maxlength="4" tabindex="6">
          <span id="landingLocalDay" class="day-shift"></span>
        </div>
      </div>

      <!-- Row 3 -->
<div class="form-row">
  <div class="label aircraft-crew-label form-label">Aircraft / Crew:</div>

  <!-- Use columns 2 through 5 for the 3 evenly-spaced items -->
  <div class="third-content-wide">
    <div class="aircraft-wrap">
      <select id="aircraft" tabindex="7">
        <option selected>KC-135</option>
        <option>KC-46</option>
        <option>C-5</option>
        <option>C-17</option>
        <option>C-130</option>
        <option>C-21</option>
        <option>C-32</option>
        <option>C-37</option>
        <option>C-40</option>
        <option>VC-25</option>
      </select>
    </div>

    <div></div>

    <div class="crew-toggle">
      <span id="basicLbl" class="crew-label form-label active">Basic</span>
      <label class="switch">
        <input type="checkbox" id="augmented" tabindex="8">
        <span class="slider"></span>
      </label>
      <span id="augLbl" class="crew-label form-label">Augmented</span>
    </div>
  </div>
</div>

    </div>

    <button id="calcBtn" tabindex="9">Calculate</button>

    <div id="output" class="output"></div>

    <div class="disclaimer">
      <p><strong>Disclaimer:</strong> I am a crew dog, not a coder or developer. I created this tool to help other crew dogs do “pilot math.” I try to keep this up to date with current regulations, but there is no guarantee of its accuracy. Please make sure you <em>trust but verify</em> the information generated on this page (technique only). Information in this calculator is based on AFMAN 11-202V3_AMC SUP, 29 JULY 2024.</p>

      <p>Also, as much as I would like to take credit for this and lead you to think I am smart, which I am not, I created this tool with the help of ChatGPT. If you find an error or have a suggetion for a change, please let me know at <strong>[your email]</strong>.</p>

      <p><strong>Donations:</strong> This is a free tool to help manage crew timing. It costs you nothing and costs me a little time and effort. If you feel so inclined to make a donation, please pay it forward and buy your Crew Chief a beer on the next TDY… or just make the Copilot do it. I appreciate your consideration, but I have already taken the bonus, so I am screwed either way. Blue skies and fair winds. Cheers!</p>
    </div>

    <div class="footer">
      NKAWT...GF
      <small>(If you know, you know…)</small>
    </div>
  </div>

</div>

<script>
/* ----------------- helpers ----------------- */
function showRuntimeError(err){
  const out = document.getElementById("output");
  if(!out) return;
  out.innerHTML = `
    <div style="margin-top:12px; padding:10px; border-radius:8px; background:#f8d7da;">
      <div style="font-weight:bold;">Something broke (runtime error)</div>
      <div style="margin-top:6px; font-family:Consolas, Menlo, 'Courier New', monospace; font-size:12px; white-space:pre-wrap;">
        ${String(err && err.message ? err.message : err)}
      </div>
      <div style="margin-top:6px; font-size:12px; color:#333;">
        Copy/paste that error back to me and we’ll fix it fast.
      </div>
    </div>
  `;
}

function updateTimeHint(timeInput, hintEl){
  if(!hintEl) return;

  const t = padHHMM(timeInput.value);

  // show nothing while typing fewer than 4 digits
  if(t.length !== 4){
    hintEl.textContent = "";
    return;
  }

  hintEl.textContent = isHHMM(t) ? "" : "Invalid time";
}

function setCalcEnabled(){
  const tk = padHHMM(takeoffTime.value);
  const ld = padHHMM(landingTime.value);

  const ok = isHHMM(tk) && isHHMM(ld);
  const btn = document.getElementById("calcBtn");
  if(btn) btn.disabled = !ok;
}

function isHHMM(s){
  return typeof s === "string" && /^\d{4}$/.test(s) &&
    parseInt(s.slice(0,2),10) <= 23 && parseInt(s.slice(2,4),10) <= 59;
}
  
function hhmmToMinutes(hhmm){
  return parseInt(hhmm.slice(0,2),10)*60 + parseInt(hhmm.slice(2,4),10);
}
  
function minutesToHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  return String(Math.floor(mins/60)).padStart(2,"0") +
         String(mins%60).padStart(2,"0");
}
  
function minutesToHHMMZ(mins){ return minutesToHHMM(mins) + "Z"; 
}

function diffMinutes(start, end){
  let d = end - start;
  if(d < 0) d += 1440;
  return d;
}
  
function minutesToHPlusMM(mins){
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${h}+${String(m).padStart(2,"0")}`;
}
  
function parseHPlusMM(s){
  if(typeof s !== "string") return null;
  const t = s.trim();
  let m = t.match(/^(\d+)\+([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  m = t.match(/^(\d+):([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  return null;
}
  
function isICAO(s){
  return typeof s === "string" && /^[A-Z]{4}$/.test(s.trim().toUpperCase());
}

function normHHMM(s){
  // keep only digits, max 4
  return String(s || "").replace(/\D/g,"").slice(0,4);
}

function padHHMM(s){
  const d = normHHMM(s);          // digits only, up to 4
  if(d.length === 3) return "0" + d;  // 930 -> 0930
  return d;                       // 0-2 digits: leave as-is, 4 digits: keep
}
  
function normICAO(s){
  // keep only letters, max 4, uppercase
  return String(s || "").replace(/[^a-z]/gi,"").slice(0,4).toUpperCase();
}

function updateIcaoHint(icao, hintEl){
  if(!hintEl) return;

  const key = normICAO(icao);

  // Only show something once it's truly "ICAO shaped"
  if(key.length !== 4){
    hintEl.textContent = "";
    hintEl.classList.remove("bad");
    return;
  }

  // ICAO looks valid, but isn't mapped
  if(!getTimeZoneFromICAO(key)){
    hintEl.textContent = "Unknown ICAO";
    hintEl.classList.add("bad");
    return;
  }

  // Mapped — clear
  hintEl.textContent = "";
  hintEl.classList.remove("bad");
}

function formatDayShift(n){
  if(!n) return "";
  return n > 0 ? `+${n}` : `${n}`;   // +1, -1, +2, etc.
}
  
function zuluToLocalWithDay(zuluMins, icao, zuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), zuluHHMM);
  if(off == null) return null;
  const raw = zuluMins + off;                   // can be <0 or >=1440
  const dayShift = Math.floor(raw / 1440);      // -1, 0, +1 (or more)
  const localMins = ((raw % 1440) + 1440) % 1440;
  return { localMins, dayShift };
}
  
function splitDayShift(rawMinutes){
  const dayShift = Math.floor(rawMinutes / 1440);               // -1,0,+1...
  const mins = ((rawMinutes % 1440) + 1440) % 1440;             // normalized 0..1439
  return { mins, dayShift };
}
  
function formatShiftSup(dayShift){
  if(dayShift === 0) return "";
  return dayShift > 0 ? `+${dayShift}` : `${dayShift}`;
}
  
function zuluHtml(mins){
  // normalize to 0..1439 for display
  const m = ((mins % 1440) + 1440) % 1440;
return `<span class="mono">${minutesToHHMM(m)}<span class="tz-sfx">Z</span></span>`;
}

function localHtmlFromZuluSimple(zuluMins, icao){
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return "";
  const zHHMM = minutesToHHMM(((zuluMins % 1440) + 1440) % 1440);
  const res = zuluToLocalWithDay(hhmmToMinutes(zHHMM), icao, zHHMM);
  if(!res) return "";
return `<span class="mono">${minutesToHHMM(res.localMins)}<span class="tz-sfx">L</span></span>`;
}

function localHtmlAtRawZulu(rawZuluMinutes, icao, anchorHHMM){
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return "";
  const zMins = ((rawZuluMinutes % 1440) + 1440) % 1440;
  const zHHMM = anchorHHMM || minutesToHHMM(zMins);
  const res = zuluToLocalWithDay(zMins, icao, zHHMM);
  if(!res) return "";
  const base = `${minutesToHHMM(res.localMins)}L`;
  const sh = formatShiftSup(res.dayShift);
  return sh ? `${base}<span class="shift-sup">${sh}</span>` : base;
}

function row3Html(label, zuluMinutes, localIcao, showLocal, extraClass="", midHtml=""){
  const z = zuluHtml(zuluMinutes);

  // Middle column content: either Local time OR an optional message OR blank
  const middle = showLocal
    ? localHtmlFromZuluSimple(zuluMinutes, localIcao)
    : (midHtml || "");

  return `
    <div class="row3 ${extraClass}">
      <span class="sc-label">${label}</span>
      <span class="lcol">${middle}</span>
      <span class="zcol">${z}</span>
    </div>
  `;
}


  
  
// ---------- Phase 1.5: ICAO lookup wrapper (preps for big DB later) ----------
let ICAO_TZ_DB = null; // optional external DB (Phase 2-ready)

// optional: later you can load this from a JSON file without changing the rest of the code
async function loadIcaoDb(){
  try{
    // If you add "icao_tz_db.json" in the same folder as this HTML, this will work.
    // Example JSON shape: { "KADW":"America/New_York", "EGLL":"Europe/London", ... }
    const res = await fetch("icao_tz_db.json", { cache: "no-store" });
    if(!res.ok) return;
    ICAO_TZ_DB = await res.json();
  }catch(_){
    // silent fail — we just fall back to the built-in map
  }
}

// run once at page load (safe even if no JSON exists)
loadIcaoDb();

/* ----------------- ICAO -> Time Zone (Phase 1 / Step 1) ----------------- */
const ICAO_TIMEZONE = {
  /* ===================== CONUS ===================== */
  KADW: "America/New_York",     // Andrews AFB
  KDOV: "America/New_York",     // Dover AFB
  KCHS: "America/New_York",     // Charleston AFB
  KJFK: "America/New_York",
  KLGA: "America/New_York",
  KEWR: "America/New_York",
  KIAD: "America/New_York",
  KDCA: "America/New_York",

  KORD: "America/Chicago",
  KDFW: "America/Chicago",
  KDEN: "America/Denver",

  KTCM: "America/Los_Angeles", // McChord
  KSEA: "America/Los_Angeles",
  KLAX: "America/Los_Angeles",
  KSFO: "America/Los_Angeles",
  KSUU: "America/Los_Angeles", // Travis AFB

  KPHX: "America/Phoenix",     // no DST
  KDMA: "America/Phoenix",     // Davis-Monthan

  PHNL: "Pacific/Honolulu",   // Hickam / JBPHH

  /* ===================== EUROPE / EUCOM ===================== */
  EGLL: "Europe/London",       // Heathrow
  EGGW: "Europe/London",       // Luton
  EGKK: "Europe/London",       // Gatwick
  EGUN: "Europe/London",       // Mildenhall
  EGUL: "Europe/London",       // Lakenheath

  ETAR: "Europe/Berlin",       // Ramstein
  ETSN: "Europe/Berlin",
  EDDM: "Europe/Berlin",       // Munich
  EDDF: "Europe/Berlin",       // Frankfurt

  LERT: "Europe/Madrid",       // Rota
  LEZG: "Europe/Madrid",

  LIRF: "Europe/Rome",         // Rome
  LIMC: "Europe/Rome",         // Milan

  EHAM: "Europe/Amsterdam",    // AMS
  LFPG: "Europe/Paris",        // CDG
  LOWW: "Europe/Vienna",       // Vienna

  /* ===================== CENTCOM ===================== */
  OTBH: "Asia/Qatar",           // Doha
  ORBI: "Asia/Baghdad",
  OKBK: "Asia/Kuwait",
  OAKN: "Asia/Kabul",

  OMDB: "Asia/Dubai",
  OMAA: "Asia/Dubai",           // Abu Dhabi

  OEJN: "Asia/Riyadh",          // Jeddah
  OERK: "Asia/Riyadh",          // Riyadh

  /* ===================== PACOM ===================== */
  RJTY: "Asia/Tokyo",           // Yokota
  RJTT: "Asia/Tokyo",           // Haneda
  RJAA: "Asia/Tokyo",           // Narita

  RKSO: "Asia/Seoul",           // Osan
  RKSI: "Asia/Seoul",           // Incheon

  ZSPD: "Asia/Shanghai",
  ZBAA: "Asia/Shanghai",        // Beijing

  RPLL: "Asia/Manila",

  WSSS: "Asia/Singapore",

  YSSY: "Australia/Sydney",
  YMML: "Australia/Melbourne",

  /* ===================== OTHER COMMON TDY ===================== */
  CYYZ: "America/Toronto",      // Toronto
  CYVR: "America/Vancouver",

  FAOR: "Africa/Johannesburg",
  FQMA: "Africa/Maputo",

  SBGR: "America/Sao_Paulo",    // São Paulo
};

function getTimeZoneFromICAO(icao){
  const key = (icao || "").trim().toUpperCase();
  return (ICAO_TZ_DB && ICAO_TZ_DB[key]) || ICAO_TIMEZONE[key] || null;
}

function getOffsetMinutesForTimeZone(timeZone, dateUtc){
  const fmt = new Intl.DateTimeFormat("en-US", {
    timeZone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hourCycle: "h23",
  });

  const parts = fmt.formatToParts(dateUtc);
  const get = (type) => parts.find(p => p.type === type)?.value;

  const y  = Number(get("year"));
  const mo = Number(get("month"));
  const d  = Number(get("day"));
  const h  = Number(get("hour"));
  const mi = Number(get("minute"));
  const s  = Number(get("second"));

  const asUtc = Date.UTC(y, mo - 1, d, h, mi, s);
  return Math.round((asUtc - dateUtc.getTime()) / 60000);
}

function getUtcOffsetMinutesFromICAO(icao, hhmm){
  const tz = getTimeZoneFromICAO(icao);
  if(!tz) return null;

  const now = new Date();
  const y = now.getUTCFullYear();
  const m = now.getUTCMonth();
  const d = now.getUTCDate();

  let h = 0, mi = 0;
  if(typeof hhmm === "string" && /^\d{4}$/.test(hhmm)){
    h  = parseInt(hhmm.slice(0,2),10);
    mi = parseInt(hhmm.slice(2,4),10);
  }

  const dateUtc = new Date(Date.UTC(y, m, d, h, mi, 0));
  return getOffsetMinutesForTimeZone(tz, dateUtc);
}

function zuluToLocalMinutes(zuluMins, icao, zuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), zuluHHMM);
  if(off == null) return null;
  return zuluMins + off;
}

function localToZuluMinutes(localMins, icao, anchorZuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), anchorZuluHHMM);
  if(off == null) return null;
  return localMins - off;
}


/* ----------------- state ----------------- */
let hasCalculated = false;
let briefOffsetMin = 150; // default 2+30

/* ----------------- main calc + render ----------------- */
function calculate(){
  try{
    const takeoff = padHHMM(takeoffTime.value);
    const landing = padHHMM(landingTime.value);
      // Snap the UI to normalized values (only if we can)
      if(takeoffTime.value !== takeoff) takeoffTime.value = takeoff;
      if(landingTime.value !== landing) landingTime.value = landing;
    const augmented = augmentedBox.checked;
    const out = document.getElementById("output");

    if(!isHHMM(takeoff) || !isHHMM(landing)){
      out.innerHTML = "Please enter times in HHMM format (0000–2359).";
      return;
    }

    // if the brief offset editor exists (from a previous render), honor it on every calculate
    const existingBrief = document.getElementById("briefOffsetEdit");
    if(existingBrief){
      const v = parseHPlusMM(existingBrief.value);
      if(v != null) briefOffsetMin = v;
    }

    const takeoffMin = hhmmToMinutes(takeoff);
    const landingMin = hhmmToMinutes(landing);

    // For local-time output rows (crew timing uses takeoff ICAO)
    const tkIcao = normICAO(takeoffICAO.value);
    const ldIcao = normICAO(landingICAO.value);


    const showTime   = takeoffMin - 195;
    const crewRest   = takeoffMin - 855;
    const lastBeer   = takeoffMin - 720;
    const legalAlert = takeoffMin - 255;

    const briefTime  = takeoffMin - briefOffsetMin;

    const stepTime   = takeoffMin - 120;
    const engine     = takeoffMin - 30;

    const flightMin = diffMinutes(takeoffMin, landingMin);
    const flightHrs = (flightMin/60).toFixed(1);

    const fdp = augmented ? 1440 : 960;
    const cdp = augmented ? 1485 : 1080;
    const tdp = 720;
    const apu = augmented ? 1080 : 720;

    const landingFromShow = diffMinutes(showTime, landingMin);

    // FDP = KING (includes "exceed" behavior)
    function ormClassFdp(limitMinutes){
      if(limitMinutes <= 0) return "";
      if(landingFromShow > limitMinutes) return "orm-exceed";
      const ratio = landingFromShow / limitMinutes;
      if(ratio >= 0.95) return "orm-severe";
      if(ratio >= 0.90) return "orm-high";
      if(ratio >= 0.75) return "orm-mod";
      return "orm-low";
    }

    // CDT/TDD/APU = muted colors only (NO exceed behavior)
    function ormClassMuted(limitMinutes){
      if(limitMinutes <= 0) return "";
      const ratio = landingFromShow / limitMinutes;
      if(ratio >= 0.95) return "ormm-severe";
      if(ratio >= 0.90) return "ormm-high";
      if(ratio >= 0.75) return "ormm-mod";
      return "ormm-low";
    }

    // FDP-only message
    function ormMessageFdp(limitMinutes){
      if(limitMinutes <= 0) return "";
      if(landingFromShow > limitMinutes){
        return "Mission NO-GO. Maximum Duty Day Exceeded";
      }
      const ratio = landingFromShow / limitMinutes;
      if(ratio >= 0.95) return "ORM Severe: >95% of Maximum Duty Day";
      if(ratio >= 0.90) return "ORM High: 90-95% of Maximum Duty Day";
      if(ratio >= 0.75) return "ORM Moderate: 75-90% of Maximum Duty Day";
      return "ORM Low: <75% of Maximum Duty Day";
    }

    out.innerHTML = `
      <div class="sc-head" style="font-weight:900;font-size:18px;text-align:center;">Crew Timing</div>

      ${row3Html("Enter Crew Rest", crewRest, tkIcao, true)}
      <div class="subtext">T/O − 14+15</div>

      ${row3Html("Last Beer", lastBeer, tkIcao, true)}
      <div class="subtext">T/O − 12+00</div>

      ${row3Html("Legal for Alert", legalAlert, tkIcao, true)}
      <div class="subtext">T/O − 4+15</div>

      ${row3Html("Show Time", showTime, tkIcao, true)}
      <div class="subtext">T/O − 3+15</div>

      ${row3Html("Brief Time", briefTime, tkIcao, true)}
      <div class="subtext">
        T/O − <input id="briefOffsetEdit" class="inline-mini"
          value="${minutesToHPlusMM(briefOffsetMin)}" maxlength="5"
          title="H+MM (e.g., 2+30)">
      </div>

      ${row3Html("Step Time", stepTime, tkIcao, true)}
      <div class="subtext">T/O − 2+00</div>

      ${row3Html("Engine Start", engine, tkIcao, true)}
      <div class="subtext">T/O − 0+30</div>

      ${row3Html("Takeoff", takeoffMin, tkIcao, true)}
      <div class="subtext">T/O − 0+00</div>

      ${row3Html("Landing", landingMin, ldIcao, true)}
      <div class="subtext">LND − 0+00</div>

      <hr>

      <div class="row">
        <span class="sc-label">Flight Time</span>
          <span>
        <span class="mono">${flightHrs}</span>
        <span class="sc-label"> hrs</span>
          </span>
      </div>

      <hr>

      <div class="sc-head" style="font-weight:900;font-size:18px;text-align:center;">Crew Duty Limitations</div>

      ${row3Html(
        "Flight Duty Period",
        showTime + fdp,
        "",
        false,
        ormClassFdp(fdp),
        `<span class="orm-note">${ormMessageFdp(fdp)}</span>`
      )}
      <div class="subtext">Show + ${minutesToHPlusMM(fdp)}</div>

      ${row3Html("Crew Duty Time", showTime + cdp, "", false, ormClassMuted(cdp))}
      <div class="subtext">Show + ${minutesToHPlusMM(cdp)}</div>

      ${row3Html("Transition Duty Day", showTime + tdp, "", false, ormClassMuted(tdp))}
      <div class="subtext">Show + ${minutesToHPlusMM(tdp)}</div>

      ${row3Html("Autopilot INOP FDP", showTime + apu, "", false, ormClassMuted(apu))}
      <div class="subtext">Show + ${minutesToHPlusMM(apu)}</div>
    `;

    // live-update brief time after first Calculate, without needing to click again
    const offInp = document.getElementById("briefOffsetEdit");
    offInp?.addEventListener("input", (e) => {
      const v = parseHPlusMM(e.target.value);
      if(v == null) return;
      briefOffsetMin = v;
      if(hasCalculated) calculate();
    });

  }catch(err){
    showRuntimeError(err);
  }
}

/* ----------------- local time sync ----------------- */
let suppressSync = false;

function syncLocalFromZulu(zuluInput, icaoInput, localInput, dayElId){
  if(suppressSync) return;

  const dayEl = document.getElementById(dayElId);
  const icao = normICAO(icaoInput.value);

// update the hint (takeoff or landing)
updateIcaoHint(icao, document.getElementById(
  icaoInput.id === "takeoffICAO" ? "takeoffIcaoHint" : "landingIcaoHint"
));

// If ICAO is fully blank: clear Local + day marker (prevents stale local time)
if(icao.length === 0){
  suppressSync = true;
  localInput.value = "";
  if(dayEl) dayEl.textContent = "";
  suppressSync = false;
  return;
}

// If ICAO is not ready/valid/mapped yet: don’t fight the user while typing
if(!isICAO(icao) || !getTimeZoneFromICAO(icao)){
  suppressSync = true;
  if(dayEl) dayEl.textContent = "";
  suppressSync = false;
  return;
}

  const z = zuluInput.value.trim();
  if(!isHHMM(z)){
    suppressSync = true;
    if(dayEl) dayEl.textContent = "";
    suppressSync = false;
    return;
  }

  const zM = hhmmToMinutes(z);
  const res = zuluToLocalWithDay(zM, icao, z);

  suppressSync = true;

  if(res == null){
    localInput.value = "";
    if(dayEl) dayEl.textContent = "";
  } else {
    localInput.value = minutesToHHMM(res.localMins);
    if(dayEl) dayEl.textContent = formatDayShift(res.dayShift);
  }

  suppressSync = false;
}

function syncZuluFromLocal(localInput, icaoInput, zuluInput){
  if(suppressSync) return;

  const icao = normICAO(icaoInput.value);
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return; // need ICAO + mapping

  const l = localInput.value.trim();
  if(!isHHMM(l)) return;

  const lM = hhmmToMinutes(l);

  // Anchor offset to what's currently in the Zulu box if valid, else "0000"
  const zAnchor = (zuluInput.value && isHHMM(zuluInput.value.trim())) ? zuluInput.value.trim() : "0000";

  const zM = localToZuluMinutes(lM, icao, zAnchor);
  if(zM == null) return;

  suppressSync = true;
  zuluInput.value = minutesToHHMM(zM);
  suppressSync = false;
}

/* ----------------- bindings ----------------- */
const augmentedBox = document.getElementById("augmented");
const basicLbl = document.getElementById("basicLbl");
const augLbl = document.getElementById("augLbl");

function syncToggleLabels(){
  basicLbl.classList.toggle("active", !augmentedBox.checked);
  augLbl.classList.toggle("active", augmentedBox.checked);
}
augmentedBox.addEventListener("change", () => {
  syncToggleLabels();
  if(hasCalculated) calculate();
});
syncToggleLabels();

document.getElementById("calcBtn").addEventListener("click", () => {
  hasCalculated = true;
  calculate();

  // smooth scroll to results
  const outEl = document.getElementById("output");
if(outEl) outEl.scrollIntoView({ behavior:"smooth", block:"start" });
});

document.getElementById("resetBtn").addEventListener("click", () => {
  // clear inputs
  takeoffTime.value = "";
  landingTime.value = "";
  takeoffICAO.value = "";
  landingICAO.value = "";
  takeoffLocal.value = "";
  landingLocal.value = "";

  // clear day shift badges
  const tDay = document.getElementById("takeoffLocalDay");
  const lDay = document.getElementById("landingLocalDay");
  if(tDay) tDay.textContent = "";
  if(lDay) lDay.textContent = "";

  // reset state + output
  hasCalculated = false;
  briefOffsetMin = 150;
  document.getElementById("output").innerHTML = "";

  // optional: reset crew toggle to Basic
  augmentedBox.checked = false;
  syncToggleLabels();

// clear ICAO hints
const tHint = document.getElementById("takeoffIcaoHint");
const lHint = document.getElementById("landingIcaoHint");
if(tHint){
  tHint.textContent = "";
  tHint.classList.remove("bad");
}
if(lHint){
  lHint.textContent = "";
  lHint.classList.remove("bad");
}
  
  // put cursor back at first box
  takeoffTime.focus();

  hasCalculated = false;

});

  

/* Local time listeners (sync only; calculate only after first button press) */
const takeoffTime = document.getElementById("takeoffTime");
const takeoffICAO = document.getElementById("takeoffICAO");
const takeoffLocal = document.getElementById("takeoffLocal");

const landingTime = document.getElementById("landingTime");
const landingICAO = document.getElementById("landingICAO");
const landingLocal = document.getElementById("landingLocal");

// Auto-normalize inputs (prevents invisible spaces / weird chars from breaking logic)
[takeoffTime, landingTime, takeoffLocal, landingLocal].forEach(inp => {
  inp.addEventListener("input", () => {
    const clean = normHHMM(inp.value);
    if(inp.value !== clean) inp.value = clean;

    if(inp === takeoffTime) updateTimeHint(takeoffTime, document.getElementById("takeoffTimeHint"));
    if(inp === landingTime) updateTimeHint(landingTime, document.getElementById("landingTimeHint"));
  setCalcEnabled();
  });
});

[takeoffTime, landingTime, takeoffLocal, landingLocal].forEach(inp => {
  inp.addEventListener("blur", () => {
    const padded = padHHMM(inp.value);
    if(inp.value !== padded) inp.value = padded;

    // After snapping, re-sync the paired fields
    if(inp === takeoffTime) syncLocalFromZulu(takeoffTime, takeoffICAO, takeoffLocal, "takeoffLocalDay");
    if(inp === landingTime) syncLocalFromZulu(landingTime, landingICAO, landingLocal, "landingLocalDay");
    if(inp === takeoffLocal) syncZuluFromLocal(takeoffLocal, takeoffICAO, takeoffTime);
    if(inp === landingLocal) syncZuluFromLocal(landingLocal, landingICAO, landingTime);

    if(hasCalculated) calculate();
  });
});
  
[takeoffICAO, landingICAO].forEach(inp => {
  inp.addEventListener("input", () => {
    const clean = normICAO(inp.value);
    if (inp.value !== clean) inp.value = clean;

    // update hint live as they type
    const hintId = (inp.id === "takeoffICAO") ? "takeoffIcaoHint" : "landingIcaoHint";
    updateIcaoHint(clean, document.getElementById(hintId));

    // NEW: re-sync local any time ICAO changes (including deleting it)
    const zuluInput  = (inp.id === "takeoffICAO") ? takeoffTime  : landingTime;
    const localInput = (inp.id === "takeoffICAO") ? takeoffLocal : landingLocal;
    const dayId      = (inp.id === "takeoffICAO") ? "takeoffLocalDay" : "landingLocalDay";

    syncLocalFromZulu(zuluInput, inp, localInput, dayId);

    if (hasCalculated) calculate();
  });
});
  
[takeoffTime, takeoffICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(takeoffTime, takeoffICAO, takeoffLocal, "takeoffLocalDay");
  if(hasCalculated) calculate();
}));
takeoffLocal.addEventListener("input", () => {
  syncZuluFromLocal(takeoffLocal, takeoffICAO, takeoffTime);
  if(hasCalculated) calculate();
});

[landingTime, landingICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(landingTime, landingICAO, landingLocal, "landingLocalDay");
  if(hasCalculated) calculate();
}));
landingLocal.addEventListener("input", () => {
  syncZuluFromLocal(landingLocal, landingICAO, landingTime);
  if(hasCalculated) calculate();
});
  setCalcEnabled();
</script>

</body>
</html>
