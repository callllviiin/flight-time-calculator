<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crew Dawg Calculator</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f7fa;
  margin:0;
  padding:20px;
  color:#222;
}

.app{
  width:100%;
  max-width:575px;
  margin:0 auto;
  padding:10px;
}

h1{
  text-align:center;
  margin:10px 0 10px;
}

.topbar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:8px;
  margin:0 0 12px;
  font-size:12px;
  color:#555;
}

  .topbar input{ transform:translateY(1px); }

/* ---------- TOP FORM (SINGLE GRID) ---------- */
.form-grid{
  display:grid;
  width: 100%;
 
  /* Fixed label column so inputs don’t get shoved right */
  grid-template-columns: 200px 104px 26px 104px 1fr;

  column-gap:4px;
  row-gap:14px;
  align-items:center;
  margin-top: 24px;
}

.form-row{
  display:contents;
  font-weight:bold;
}

.label{
  /* allow wrap so label column can stay narrow */
  white-space:normal;
  line-height:1.1;
}

/* all three boxes same size */
.box{
  width:104px;
  padding:6px;
  font-size:16px;
  text-align:center;
  box-sizing:border-box;
}

input,
select{
  font-family: Consolas, Menlo, "Courier New", monospace;
}

input{
  letter-spacing: 1.5px;
  font-weight: 600;
}
  
/* Floating label wrapper (for Zulu + Local) */
.floating-wrap{
  position:relative;
  display:inline-block;
  width:104px;
}
  
.floating-label{
  position:absolute;
  left:8px;
  top:-9px;
  font-size:10px;
  color:#666;
  background:#f5f7fa;
  padding:0 4px;
  font-weight:normal;
}

.at{
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
}

.icao-wrap{
  display:inline-block;
  width:104px;
}

/* slightly larger gap between ICAO and Local */
.local-wrap{ 
  margin-left:10px;
  justify-self:end;
}

/* ---------- ROW 3 ---------- */
.aircraft-crew-label{
  font-weight:bold;
}

.third-content-wide{
  grid-column: 2 / -1;    /* spans Zulu → Local columns */
  display:grid;
  grid-template-columns: auto 1fr auto;  /* left item, center space, right item */
  align-items:center;
  width: 100%;
  justify-self: stretch;
}
  
.third-content-wide > div:nth-child(1){
  justify-self:start;
}
.third-content-wide > div:nth-child(2){
  justify-self:center;
}
.third-content-wide > div:nth-child(3){
  justify-self:end;
}

.aircraft-wrap{ justify-self:start; }

#aircraft{
  width:120px;
  padding:6px;
  font-size:16px;
  box-sizing:border-box;
}

.crew-toggle{
  justify-self:end;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  white-space:nowrap;
}

.crew-label{
  font-weight:normal;
  color:#333;
}
.crew-label.active{ font-weight:bold; }

/* switch */
.switch{
  position:relative;
  width:52px;
  height:26px;
  flex:0 0 auto;
}
.switch input{ display:none; }

.slider{
  position:absolute;
  inset:0;
  background:#d0d0d0;
  border-radius:26px;
}
.slider:before{
  content:"◀";
  position:absolute;
  height:22px;
  width:22px;
  left:2px;
  top:2px;
  background:#fff;
  border-radius:50%;
  display:grid;
  place-items:center;
  font-size:12px;
  color:#444;
  transition:0.25s;
  box-shadow:0 1px 2px rgba(0,0,0,0.2);
}
input:checked + .slider:before{
  transform:translateX(26px);
  content:"▶";
}

/* ---------- BUTTON ---------- */
button{
  margin-top:20px;
  padding:12px;
  font-size:16px;
  width:100%;
  cursor:pointer;
}

/* ---------- OUTPUT ---------- */
.output{
  margin-top:28px;
  padding:20px;
  background:white;
  border-radius:8px;
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-top:12px;
  font-weight:bold;
}

.subtext{
  font-size:12px;
  color:#666;
  margin-top:2px;
  margin-bottom:6px;
}

.warn{
  background-color:#fff3cd;
  padding:4px 6px;
  border-radius:4px;
}

.danger{
  background-color:#f8d7da;
  padding:4px 6px;
  border-radius:4px;
}

/* tiny offset editor for brief */
.inline-mini{
  width:48px;
  font-size:12px;
  padding:2px 4px;
  text-align:center;
  box-sizing:border-box;
  border-radius:4px;
  border:1px solid #cfcfcf;
  background:#fff;
}

/* ---------- DISCLAIMER / FOOTER ---------- */
.disclaimer{
  margin-top:40px;
  font-size:13px;
  color:#444;
  line-height:1.5;
  text-align:justify;
  text-justify:inter-word;
}

.footer{
  margin-top:40px;
  text-align:center;
  font-weight:bold;
}
.footer small{
  display:block;
  font-weight:normal;
  color:#666;
}

/* ---------- MOBILE ---------- */
@media (max-width:620px){
  .form-grid{
    grid-template-columns: max-content 1fr 26px 1fr 1fr;
  }
  .floating-wrap{ width:100%; }
  .box{ width:100%; }
  .icao-wrap{ width:100%; }
  .local-wrap{ margin-left:0; }

  .third-row-wrap{
    grid-template-columns: 1fr;
    row-gap:8px;
  }
  .third-content{
    grid-template-columns: 1fr;
    gap:10px;
  }
  .crew-toggle{ justify-self:end; }
}
</style>
</head>

<body>
<div id="pageRoot">

  <div class="app">
    <h1>Crew Dawg Calculator</h1>

    <div class="form-grid">

      <!-- Row 1 -->
      <div class="form-row">
        <div class="label">Scheduled Takeoff Time:</div>

        <div class="floating-wrap">
          <div class="floating-label">Zulu</div>
          <input id="takeoffTime" class="box" placeholder="HHMM" maxlength="4">
        </div>

        <div class="at">at</div>

        <div class="icao-wrap">
          <input id="takeoffICAO" class="box" placeholder="ICAO" maxlength="4" style="text-transform:uppercase;">
        </div>

        <div class="floating-wrap local-wrap">
          <div class="floating-label">Local</div>
          <input id="takeoffLocal" class="box" placeholder="HHMM" maxlength="4">
        </div>
      </div>

      <!-- Row 2 -->
      <div class="form-row">
        <div class="label">Scheduled Land Time:</div>

        <div class="floating-wrap">
          <div class="floating-label">Zulu</div>
          <input id="landingTime" class="box" placeholder="HHMM" maxlength="4">
        </div>

        <div class="at">at</div>

        <div class="icao-wrap">
          <input id="landingICAO" class="box" placeholder="ICAO" maxlength="4" style="text-transform:uppercase;">
        </div>

        <div class="floating-wrap local-wrap">
          <div class="floating-label">Local</div>
          <input id="landingLocal" class="box" placeholder="HHMM" maxlength="4">
        </div>
      </div>

      <!-- Row 3 -->
<div class="form-row">
  <div class="label aircraft-crew-label">Aircraft / Crew:</div>

  <!-- Use columns 2 through 5 for the 3 evenly-spaced items -->
  <div class="third-content-wide">
    <div class="aircraft-wrap">
      <select id="aircraft">
        <option selected>KC-135</option>
        <option>KC-46</option>
        <option>C-5</option>
        <option>C-17</option>
        <option>C-130</option>
        <option>C-21</option>
        <option>C-32</option>
        <option>C-37</option>
        <option>C-40</option>
        <option>VC-25</option>
      </select>
    </div>

    <div></div>

    <div class="crew-toggle">
      <span id="basicLbl" class="crew-label active">Basic</span>
      <label class="switch">
        <input type="checkbox" id="augmented">
        <span class="slider"></span>
      </label>
      <span id="augLbl" class="crew-label">Augmented</span>
    </div>
  </div>
</div>

    </div>

    <button id="calcBtn">Calculate</button>

    <div id="output" class="output"></div>

    <div class="disclaimer">
      <p><strong>Disclaimer:</strong> I am a crew dog, not a coder or developer. I created this tool to help other crew dogs do “pilot math.” I try to keep this up to date with current regulations, but there is no guarantee of its accuracy. Please make sure you <em>trust but verify</em> the information generated on this page (technique only). Information in this calculator is based on AFMAN 11-202V3_AMC SUP, 29 JULY 2024.</p>

      <p>Also, as much as I would like to take credit for this and lead you to think I am smart, which I am not, I created this tool with the help of ChatGPT. If you find an error or have a suggetion for a change, please let me know at <strong>[your email]</strong>.</p>

      <p><strong>Donations:</strong> This is a free tool to help manage crew timing. It costs you nothing and costs me a little time and effort. If you feel so inclined to make a donation, please pay it forward and buy your Crew Chief a beer on the next TDY… or just make the Copilot do it. I appreciate your consideration, but I have already taken the bonus, so I am screwed either way. Blue skies and fair winds. Cheers!</p>
    </div>

    <div class="footer">
      NKAWT...GF
      <small>(If you know, you know…)</small>
    </div>
  </div>

</div>

<script>
/* ----------------- helpers ----------------- */
function isHHMM(s){
  return typeof s === "string" && /^\d{4}$/.test(s) &&
    parseInt(s.slice(0,2),10) <= 23 && parseInt(s.slice(2,4),10) <= 59;
}
function hhmmToMinutes(hhmm){
  return parseInt(hhmm.slice(0,2),10)*60 + parseInt(hhmm.slice(2,4),10);
}
function minutesToHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  return String(Math.floor(mins/60)).padStart(2,"0") +
         String(mins%60).padStart(2,"0");
}
function minutesToHHMMZ(mins){ return minutesToHHMM(mins) + "Z"; }
function diffMinutes(start, end){
  let d = end - start;
  if(d < 0) d += 1440;
  return d;
}
function minutesToHPlusMM(mins){
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${h}+${String(m).padStart(2,"0")}`;
}
function parseHPlusMM(s){
  if(typeof s !== "string") return null;
  const t = s.trim();
  let m = t.match(/^(\d+)\+([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  m = t.match(/^(\d+):([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  return null;
}
function isICAO(s){
  return typeof s === "string" && /^[A-Z]{4}$/.test(s.trim().toUpperCase());
}

/* ----------------- ICAO -> Time Zone (Phase 1 / Step 1) ----------------- */
const ICAO_TIMEZONE = {
  /* ===================== CONUS ===================== */
  KADW: "America/New_York",     // Andrews AFB
  KDOV: "America/New_York",     // Dover AFB
  KCHS: "America/New_York",     // Charleston AFB
  KJFK: "America/New_York",
  KLGA: "America/New_York",
  KEWR: "America/New_York",
  KIAD: "America/New_York",
  KDCA: "America/New_York",

  KORD: "America/Chicago",
  KDFW: "America/Chicago",
  KDEN: "America/Denver",

  KTCM: "America/Los_Angeles", // McChord
  KSEA: "America/Los_Angeles",
  KLAX: "America/Los_Angeles",
  KSFO: "America/Los_Angeles",
  KSUU: "America/Los_Angeles", // Travis AFB

  KPHX: "America/Phoenix",     // no DST
  KDMA: "America/Phoenix",     // Davis-Monthan

  PHNL: "Pacific/Honolulu",   // Hickam / JBPHH

  /* ===================== EUROPE / EUCOM ===================== */
  EGLL: "Europe/London",       // Heathrow
  EGGW: "Europe/London",       // Luton
  EGKK: "Europe/London",       // Gatwick
  EGUN: "Europe/London",       // Mildenhall
  EGUL: "Europe/London",       // Lakenheath

  ETAR: "Europe/Berlin",       // Ramstein
  ETSN: "Europe/Berlin",
  EDDM: "Europe/Berlin",       // Munich
  EDDF: "Europe/Berlin",       // Frankfurt

  LERT: "Europe/Madrid",       // Rota
  LEZG: "Europe/Madrid",

  LIRF: "Europe/Rome",         // Rome
  LIMC: "Europe/Rome",         // Milan

  EHAM: "Europe/Amsterdam",    // AMS
  LFPG: "Europe/Paris",        // CDG
  LOWW: "Europe/Vienna",       // Vienna

  /* ===================== CENTCOM ===================== */
  OTBH: "Asia/Qatar",           // Doha
  ORBI: "Asia/Baghdad",
  OKBK: "Asia/Kuwait",
  OAKN: "Asia/Kabul",

  OMDB: "Asia/Dubai",
  OMAA: "Asia/Dubai",           // Abu Dhabi

  OEJN: "Asia/Riyadh",          // Jeddah
  OERK: "Asia/Riyadh",          // Riyadh

  /* ===================== PACOM ===================== */
  RJTY: "Asia/Tokyo",           // Yokota
  RJTT: "Asia/Tokyo",           // Haneda
  RJAA: "Asia/Tokyo",           // Narita

  RKSO: "Asia/Seoul",           // Osan
  RKSI: "Asia/Seoul",           // Incheon

  ZSPD: "Asia/Shanghai",
  ZBAA: "Asia/Shanghai",        // Beijing

  RPLL: "Asia/Manila",

  WSSS: "Asia/Singapore",

  YSSY: "Australia/Sydney",
  YMML: "Australia/Melbourne",

  /* ===================== OTHER COMMON TDY ===================== */
  CYYZ: "America/Toronto",      // Toronto
  CYVR: "America/Vancouver",

  FAOR: "Africa/Johannesburg",
  FQMA: "Africa/Maputo",

  SBGR: "America/Sao_Paulo",    // São Paulo
};

function getTimeZoneFromICAO(icao){
  const key = (icao || "").trim().toUpperCase();
  return ICAO_TIMEZONE[key] || null;
}

function getOffsetMinutesForTimeZone(timeZone, dateUtc){
  const fmt = new Intl.DateTimeFormat("en-US", {
    timeZone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hourCycle: "h23",
  });

  const parts = fmt.formatToParts(dateUtc);
  const get = (type) => parts.find(p => p.type === type)?.value;

  const y  = Number(get("year"));
  const mo = Number(get("month"));
  const d  = Number(get("day"));
  const h  = Number(get("hour"));
  const mi = Number(get("minute"));
  const s  = Number(get("second"));

  const asUtc = Date.UTC(y, mo - 1, d, h, mi, s);
  return Math.round((asUtc - dateUtc.getTime()) / 60000);
}

function getUtcOffsetMinutesFromICAO(icao, hhmm){
  const tz = getTimeZoneFromICAO(icao);
  if(!tz) return null;

  const now = new Date();
  const y = now.getUTCFullYear();
  const m = now.getUTCMonth();
  const d = now.getUTCDate();

  let h = 0, mi = 0;
  if(typeof hhmm === "string" && /^\d{4}$/.test(hhmm)){
    h  = parseInt(hhmm.slice(0,2),10);
    mi = parseInt(hhmm.slice(2,4),10);
  }

  const dateUtc = new Date(Date.UTC(y, m, d, h, mi, 0));
  return getOffsetMinutesForTimeZone(tz, dateUtc);
}

function zuluToLocalMinutes(zuluMins, icao, zuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), zuluHHMM);
  if(off == null) return null;
  return zuluMins + off;
}

function localToZuluMinutes(localMins, icao, anchorZuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), anchorZuluHHMM);
  if(off == null) return null;
  return localMins - off;
}


/* ----------------- state ----------------- */
let hasCalculated = false;
let briefOffsetMin = 150; // default 2+30

/* ----------------- main calc + render ----------------- */
function calculate(){
  const takeoff = takeoffTime.value.trim();
  const landing = landingTime.value.trim();
  const augmented = augmentedBox.checked;
  const out = document.getElementById("output");

  if(!isHHMM(takeoff) || !isHHMM(landing)){
    out.innerHTML = "Please enter times in HHMM format (0000–2359).";
    return;
  }

  // if the brief offset editor exists (from a previous render), honor it on every calculate
  const existingBrief = document.getElementById("briefOffsetEdit");
  if(existingBrief){
    const v = parseHPlusMM(existingBrief.value);
    if(v != null) briefOffsetMin = v;
  }

  const takeoffMin = hhmmToMinutes(takeoff);
  const landingMin = hhmmToMinutes(landing);

  const showTime   = takeoffMin - 195;
  const crewRest   = takeoffMin - 855;
  const lastBeer   = takeoffMin - 720;
  const legalAlert = takeoffMin - 255;

  const briefTime  = takeoffMin - briefOffsetMin;

  const stepTime   = takeoffMin - 120;
  const engine     = takeoffMin - 30;

  const flightMin = diffMinutes(takeoffMin, landingMin);
  const flightHrs = (flightMin/60).toFixed(1);

  const fdp = augmented ? 1440 : 960;
  const cdp = augmented ? 1485 : 1080;
  const tdp = 720;
  const apu = augmented ? 1080 : 720;

  const landingFromShow = diffMinutes(showTime, landingMin);

  function hl(limitMinutes){
    if(landingFromShow > limitMinutes) return "danger";
    if(landingFromShow >= limitMinutes * 0.8) return "warn";
    return "";
  }

  out.innerHTML = `
    <div style="font-weight:bold;font-size:18px;text-align:center;">Crew Timing</div>

    <div class="row"><span>Enter Crew Rest</span><span>${minutesToHHMMZ(crewRest)}</span></div>
    <div class="subtext">T/O − 14+15</div>

    <div class="row"><span>Last Beer</span><span>${minutesToHHMMZ(lastBeer)}</span></div>
    <div class="subtext">T/O − 12+00</div>

    <div class="row"><span>Legal for Alert</span><span>${minutesToHHMMZ(legalAlert)}</span></div>
    <div class="subtext">T/O − 4+15</div>

    <div class="row"><span>Show Time</span><span>${minutesToHHMMZ(showTime)}</span></div>
    <div class="subtext">T/O − 3+15</div>

    <div class="row"><span>Brief Time</span><span>${minutesToHHMMZ(briefTime)}</span></div>
    <div class="subtext">
      T/O − <input id="briefOffsetEdit" class="inline-mini" value="${minutesToHPlusMM(briefOffsetMin)}" maxlength="5" title="H+MM (e.g., 2+30)">
    </div>

    <div class="row"><span>Step Time</span><span>${minutesToHHMMZ(stepTime)}</span></div>
    <div class="subtext">T/O − 2+00</div>

    <div class="row"><span>Engine Start</span><span>${minutesToHHMMZ(engine)}</span></div>
    <div class="subtext">T/O − 0+30</div>

    <div class="row"><span>Takeoff</span><span>${minutesToHHMMZ(takeoffMin)}</span></div>
    <div class="subtext">T/O − 0+00</div>

    <hr>

    <div class="row"><span>Flight Time</span><span>${flightHrs} hrs</span></div>

    <hr>

    <div style="font-weight:bold;font-size:18px;text-align:center;">Duty Limitations</div>

    <div class="row ${hl(fdp)}"><span>Flight Duty Period</span><span>${minutesToHHMMZ(showTime+fdp)}</span></div>
    <div class="subtext">Show + ${minutesToHPlusMM(fdp)}</div>

    <div class="row ${hl(cdp)}"><span>Crew Duty Time</span><span>${minutesToHHMMZ(showTime+cdp)}</span></div>
    <div class="subtext">Show + ${minutesToHPlusMM(cdp)}</div>

    <div class="row"><span>Transition Duty Day</span><span>${minutesToHHMMZ(showTime+tdp)}</span></div>
    <div class="subtext">Show + ${minutesToHPlusMM(tdp)}</div>

    <div class="row ${hl(apu)}"><span>Autopilot INOP FDP</span><span>${minutesToHHMMZ(showTime+apu)}</span></div>
    <div class="subtext">Show + ${minutesToHPlusMM(apu)}</div>
  `;

  // live-update brief time after first Calculate, without needing to click again
  const offInp = document.getElementById("briefOffsetEdit");
  offInp?.addEventListener("input", (e) => {
    const v = parseHPlusMM(e.target.value);
    if(v == null) return;
    briefOffsetMin = v;
    if(hasCalculated) calculate();
  });
}

/* ----------------- local time sync ----------------- */
let suppressSync = false;

function syncLocalFromZulu(zuluInput, icaoInput, localInput){
  if(suppressSync) return;

  const icao = (icaoInput.value || "").trim().toUpperCase();

  // Don’t populate Local unless ICAO is valid AND mapped to a timezone
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)){
    suppressSync = true;
    localInput.value = "";
    suppressSync = false;
    return;
  }

  const z = zuluInput.value.trim();
  if(!isHHMM(z)) return;

  const zM = hhmmToMinutes(z);
  const locM = zuluToLocalMinutes(zM, icao, z); // <-- pass HHMM for offset anchoring
  suppressSync = true;
  localInput.value = (locM == null) ? "" : minutesToHHMM(locM);
  suppressSync = false;
}

function syncZuluFromLocal(localInput, icaoInput, zuluInput){
  if(suppressSync) return;

  const icao = (icaoInput.value || "").trim().toUpperCase();
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return; // need ICAO + mapping

  const l = localInput.value.trim();
  if(!isHHMM(l)) return;

  const lM = hhmmToMinutes(l);

  // Anchor offset to what's currently in the Zulu box if valid, else "0000"
  const zAnchor = (zuluInput.value && isHHMM(zuluInput.value.trim())) ? zuluInput.value.trim() : "0000";

  const zM = localToZuluMinutes(lM, icao, zAnchor);
  if(zM == null) return;

  suppressSync = true;
  zuluInput.value = minutesToHHMM(zM);
  suppressSync = false;
}

/* ----------------- bindings ----------------- */
const augmentedBox = document.getElementById("augmented");
const basicLbl = document.getElementById("basicLbl");
const augLbl = document.getElementById("augLbl");

function syncToggleLabels(){
  basicLbl.classList.toggle("active", !augmentedBox.checked);
  augLbl.classList.toggle("active", augmentedBox.checked);
}
augmentedBox.addEventListener("change", () => {
  syncToggleLabels();
  if(hasCalculated) calculate();
});
syncToggleLabels();

document.getElementById("calcBtn").addEventListener("click", () => {
  hasCalculated = true;
  calculate();
});

/* Local time listeners (sync only; calculate only after first button press) */
const takeoffTime = document.getElementById("takeoffTime");
const takeoffICAO = document.getElementById("takeoffICAO");
const takeoffLocal = document.getElementById("takeoffLocal");

const landingTime = document.getElementById("landingTime");
const landingICAO = document.getElementById("landingICAO");
const landingLocal = document.getElementById("landingLocal");

[takeoffTime, takeoffICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(takeoffTime, takeoffICAO, takeoffLocal);
  if(hasCalculated) calculate();
}));
takeoffLocal.addEventListener("input", () => {
  syncZuluFromLocal(takeoffLocal, takeoffICAO, takeoffTime);
  if(hasCalculated) calculate();
});

[landingTime, landingICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(landingTime, landingICAO, landingLocal);
  if(hasCalculated) calculate();
}));
landingLocal.addEventListener("input", () => {
  syncZuluFromLocal(landingLocal, landingICAO, landingTime);
  if(hasCalculated) calculate();
});
</script>

</body>
</html>
