<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crew Dawg Calculator</title>

<style>
html{
  overflow-y: scroll;   /* always reserve scrollbar space to prevent 1st-click centering shift */
}

body{
  font-family: Arial, sans-serif;
  background:#f5f7fa;
  margin:0;
  padding:20px;
  color:#222;
}

.app{
  width:100%;
  max-width:575px;
  margin:0 auto;
  padding:10px;
}

.headerbar{
  position:relative;
  margin:0 0 8px;
}

/* Title: centered, slightly larger, more authority */
.headerbar h1{
  margin:10px 0 10px;
  text-align:center;
  font-size:30px;     /* slightly larger */
  font-weight:800;    /* bolder */
  line-height:1.1;    /* tight, predictable baseline */
}
  
/* Title: small-caps look */
.app-title{
  font-variant: small-caps;
  letter-spacing: 1px;
}

/* Reset button aligned to title baseline */
.headerbar .icon-btn{
  position:absolute;
  right:0;
  bottom:0px;        /* aligns with bottom of title text */
}

.topbar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:8px;
  margin:0 0 12px;
  font-size:12px;
  color:#555;
}

.topbar input{ transform:translateY(1px); 
}

.icon-btn{
  width:32px;
  height:32px;
  border-radius:8px;
  border:2px solid #cfcfcf;
  background:#fff;
  cursor:pointer;
  font-size:28px;
  font-weight:700;   /* adds authority */
  line-height:0;
  display:grid;
  place-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  color:#1f2a44;
  padding:0;
}
  
.icon-btn:hover{ filter:brightness(0.98); 
}
.icon-btn:active{ transform:translateY(1px); 
}

/* Small hint under ICAO boxes (only shows when ICAO is valid-format but unmapped) */
.icao-hint{
  font-size:10px;
  font-weight:600;
  line-height:1.1;
  margin-top:6px;    
  color:#666;
  min-height:14px;    /* ensures stable spacing */
}

.icao-hint.bad{
  color:#8b0000;       /* subtle dark red */
}
  
/* ---------- TOP FORM (SINGLE GRID) ---------- */
.form-grid{
  display:grid;
  width: 100%;
  /* Fixed label column so inputs don’t get shoved right */
  grid-template-columns: 200px 104px 26px 104px 1fr;
  column-gap:4px;
  row-gap:20px;
  align-items:center;
  margin-top: 24px;
}

.form-row{
  display:contents;
  font-weight:bold;
}

.label{
  /* allow wrap so label column can stay narrow */
  white-space:normal;
  line-height:1.1;
}

/* Top form labels: small-caps / “manual” look */
.form-label{
  font-variant: small-caps;
  letter-spacing: 0.8px;
}
  
/* all three boxes same size */
.box{
  width:104px;
  padding:6px;
  font-size:16px;
  text-align:center;
  box-sizing:border-box;
}

input.box{
  vertical-align: middle;
}
  
input,
select{
  font-family: Consolas, Menlo, "Courier New", monospace;
}

input{
  letter-spacing: 1.5px;
  font-weight: 600;
}
  
/* Floating label wrapper (for Zulu + Local) */
.floating-wrap{
  position:relative;
  display:inline-block;
  width:104px;
}

.floating-label{
  position:absolute;
  left:8px;
  top:-9px;
  font-size:10px;
  color:#666;
  background:#f5f7fa;
  padding:0 4px;
  font-weight:normal;
}

/* Day shift indicator INSIDE the local input box */
.day-shift{
  position:absolute;
  right:6px;
  bottom:6px;          /* inside the box, bottom-right */
  font-size:10px;
  color:#666;
  font-weight:700;
  line-height:1;
  pointer-events:none; /* clicks go to the input */
  background:transparent;
}

/* Give Local inputs room so the +1/-1 doesn't overlap digits */
.local-wrap .box{
  padding-right:18px;
  padding-left:18px;
}

/* Subtle +1/-1 marker in OUTPUT (superscript style) */
.shift-sup{
  font-size:10px;
  color:#666;
  font-weight:700;
  margin-left:2px;
  vertical-align:super;
}

/* Float day-shift without affecting alignment */
.timewrap{
  position:relative;
  display:inline-block;
  padding-right:16px;     /* reserves space so columns stay aligned */
}

.timewrap .shift-sup{
  position:absolute;
  right:0;
  top:-2px;              /* small lift (superscript feel) */
  margin-left:0;         /* no inline spacing needed */
}
  
.at{
  font-weight:bold;
  display:flex;
  align-items:center;
  justify-content:center;
}

.icao-wrap{
  position:relative;
  width:104px;
}

.icao-wrap .box{
  width:100%;
}

.icao-hint{
  position:absolute;
  left:0;
  right:0;
  top:100%;
  margin-top:2px;

  font-size:10px;
  font-weight:600;
  line-height:1.1;
  color:#666;

  text-align:center;
  pointer-events:none;
  white-space:nowrap;
}
  
/* Time-only hint: tuck it under the right side of the Zulu input to avoid overlap */
.icao-hint.time-hint{
  left:auto;           /* stop stretching full width */
  right:0;             /* align to right edge of its input */
  width:104px;         /* match the box width */
  text-align:right;    /* text hugs the right edge */
}

  
.icao-hint.bad{
  color:#8b0000;
}
  
/* slightly larger gap between ICAO and Local */
.local-wrap{ 
  margin-left:10px;
  justify-self:end;
}

/* ---------- ROW 3 ---------- */
.aircraft-crew-label{
  font-weight:bold;
}

.third-content-wide{
  grid-column: 2 / -1;    /* spans Zulu → Local columns */
  display:grid;
  grid-template-columns: auto 1fr auto;  /* left item, center space, right item */
  align-items:center;
  width: 100%;
  justify-self: stretch;
}
  
.third-content-wide > div:nth-child(1){
  justify-self:start;
}
.third-content-wide > div:nth-child(2){
  justify-self:center;
}
.third-content-wide > div:nth-child(3){
  justify-self:end;
}

.aircraft-wrap{ justify-self:start; }

#aircraft{
  width:120px;
  padding:6px;
  font-size:16px;
  font-weight:700;
  text-align:center;      /* center text inside dropdown */
  box-sizing:border-box;
}

/* Row 3: Aircraft + Home ICAO side-by-side */
.aircraft-home{
  display:flex;
  align-items:center;
  gap:8px;
}

.home-wrap{
  position:relative;
  width:88px; /* slightly smaller than normal boxes */
}

.home-wrap .box{
  width:100%;
  padding:6px;
  font-size:16px;
  text-align:center;
}
  
.crew-toggle{
  justify-self:end;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  white-space:nowrap;
}

.crew-label{
  font-weight:normal;
  color:#333;
}
.crew-label.active{ font-weight:bold; }

/* switch */
.switch{
  position:relative;
  width:52px;
  height:26px;
  flex:0 0 auto;
}
  
.switch input{
  position:absolute;
  opacity:0;
  width:1px;
  height:1px;
}

.slider{
  position:absolute;
  inset:0;
  background:#d0d0d0;
  border-radius:26px;
}
  
/* Visible focus ring when tabbing to the switch (robust) */
.switch:focus-within .slider{
  outline: 2px solid #ff8a3d;
  outline-offset: 2px; 
}
  
.slider:before{
  content:"◀";
  position:absolute;
  height:22px;
  width:22px;
  left:2px;
  top:2px;
  background:#fff;
  border-radius:50%;
  display:grid;
  place-items:center;
  font-size:12px;
  color:#444;
  transition:0.25s;
  box-shadow:0 1px 2px rgba(0,0,0,0.2);
}
input:checked + .slider:before{
  transform:translateX(26px);
  content:"▶";
}

/* ---------- BUTTON ---------- */
button{
  margin-top:20px;
  padding:14px 12px;
  font-size:20px;
  font-weight:800;
  font-variant: small-caps;
  letter-spacing:0.8px;
  width:100%;
  cursor:pointer;

  background:#1f2a44;      /* deep blue/gray */
  color:#fff;
  border:1px solid #141b2d;
  border-radius:10px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);
}

button:hover{
  filter:brightness(1.05);
}

/* Circadian highlight for Home Station Show Time (subtle, scan-friendly) */
.circ-low{
  background:#eaf6ee;
  border:1px solid #c7e7d0;
  padding:2px 4px;
  border-radius:4px;
}

.circ-mod{
  background:#fff8e3;
  border:1px solid #f1e0b6;
  padding:2px 4px;
  border-radius:4px;
}

.circ-high{
  background:#ffe2bf;
  border:1px solid #f3c08a;
  padding:2px 4px;
  border-radius:4px;
}

.circ-severe{
  background:#ffd1d1;
  border:1px solid #f1a0a0;
  padding:2px 4px;
  border-radius:4px;
}
  
/* ---------- Global focus / accent color (force orange) ---------- */
:focus-visible{
  outline: 2px solid #ff8a3d;
  outline-offset: 2px;
}

/* Remove inconsistent browser focus rings */
button:focus:not(:focus-visible),
input:focus:not(:focus-visible),
select:focus:not(:focus-visible){
  outline: none;
}
  
button:active{
  transform:translateY(1px);
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
}

button:disabled{
  opacity:0.5;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}
  
/* ---------- OUTPUT ---------- */
.output{
  margin-top:28px;
  padding:20px 20px 12px;
  background:white;
  border-radius:8px;
  border:1px solid #1f2a44;  /* same as button background */
  overflow-y: scroll;        /* reserve scrollbar space to prevent text shifting */
}

/* Visual-only collapse (prevents scroll snap during reset) */
.output{
  transform-origin: top;
  transition: opacity 260ms ease, transform 260ms ease;
}

.output.collapsing{
  opacity: 0;
  transform: scaleY(0);
}

/* Reset: shrink results down to the idle-size (NOT to zero) */
.output.collapsing-to-idle{
  opacity:1;
  transform: scaleY(var(--idleScale, 0.35));
}
  
.output hr{
  margin:14px 0;
}

/* Expanded output: behave like a panel without hard pixel-locking */
.output.fixed-expanded{
  max-height: calc(100vh - 220px);
  overflow-y: auto;
  overflow-x: hidden;
}

/* Mobile: don't lock expanded height */
@media (max-width:620px){
  .output.fixed-expanded{
    height:auto !important;
    overflow:visible !important;
  }
}
  
/* ---------- OUTPUT ACTION BUTTONS (BOTTOM) ---------- */
.output-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.output-actions button{
  margin-top:0;            /* override global button margin */
  width:100%;
  padding:12px 12px;
  font-size:16px;
  border-radius:10px;
}

.output-actions button:disabled{
  opacity:0.55;
}

/* Output panel: idle (pre-calc) */
/* Output panel: idle (pre-calc) — same height as Calculate button */
.output.idle{
  height:52px;                 /* match Calculate button height */
  padding:0 12px;              /* no vertical padding (prevents tall box) */

  border:1px solid #1f2a44;    /* match expanded output + Calculate */
  border-radius:10px;
  background:#fff;

  font-variant: small-caps;
  letter-spacing:0.8px;

  font-size:14px;
  font-weight:600;
  color:rgba(31,42,68,0.55);
  line-height:1;

  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  text-align:center;
}
  
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-top:12px;
  font-weight:bold;
}

/* Flight Time: match Crew Timing row size */
.row.flight-time .sc-label,
.row.flight-time .mono{
  font-size:17.5px;
}

/* Slightly larger text for Crew Timing rows only */
.crew-timing .row3{
  font-size:17.5px;
}

/* Duty section header slightly larger */
.sc-head.duty-head{
  font-size:19px;
}
  
/* Output rows: label | local | zulu */
.row3{
  display:grid;
  grid-template-columns: 1fr auto auto;
  column-gap:10px;          /* tighter */
  align-items:center;
  margin-top:12px;
  font-weight:bold;
}

.row3 .lcol{
  text-align:right;
  font-weight:700;
  color:inherit;      /* same black as Zulu */
  min-width:70px;
  margin-right:40px;
}

.row3 .zcol{
  text-align:right;
  min-width:70px;
}

/* Give ORM message column more space */
.row3.midtext{
  grid-template-columns: 190px 1fr auto; /* fixed label width, message gets the rest */
  column-gap:10px;
}

.row3.midtext > span:first-child{
  white-space:nowrap;
}
  
/* Center the ORM message within the middle column */
.row3.midtext .lcol{
  display:flex;
  justify-content:center;   /* horizontal centering */
  align-items:center;       /* vertical centering */
}
  
/* small-caps for left-column labels in output rows */
.sc-label{
  font-variant: small-caps;
  letter-spacing: 0.6px;
}

/* Section headers in output (Crew Timing, Crew Duty Limitations) */
.sc-head{
  font-variant: small-caps;
  letter-spacing: 1px;
}

/* Crew Timing header: largest emphasis */
.sc-head.timing-head{
  font-size:20px;
}
  
/* Output times should look like your inputs */
.mono{
  font-family: Consolas, Menlo, "Courier New", monospace;
  letter-spacing: 1px;
  font-weight: 700;
  font-size: 1.05em;   /* subtle optical correction */
}
  
.tz-sfx{
  font-size:10px;
  font-weight:700;
  margin-left:1px;
  opacity:0.8;
}
 
.subtext{
  font-size:12px;
  color:#666;
  margin-top:2px;
  margin-bottom:10px;
}

/* Small explanatory text in the "middle" column of Duty Limitations */
.orm-note{
  display:block;
  font-size:11px;
  font-weight:600;
  color:inherit;
  line-height:1.1;
  text-align:left;
  margin-right:0;
}

.row3.midtext .orm-note{
  white-space:nowrap;
  display:inline-block;
}
  
.warn{
  background-color:#fff3cd;
  padding:4px 6px;
  border-radius:4px;
}

.danger{
  background-color:#f8d7da;
  padding:4px 6px;
  border-radius:4px;
}

/* ================= ORM bands (FDP = KING) ================= */
/* FDP: same strong fills, now with a darker border for definition */
.orm-low{
  background:#d4edda;
  border:1px solid #7bbf8b;     /* darker green border */
  padding:4px 6px;
  border-radius:4px;
}

.orm-mod{
  background:#fff3cd;
  border:1px solid #d6b656;     /* darker yellow border */
  padding:4px 6px;
  border-radius:4px;
}

.orm-high{
  background:#ffb74d;           /* strong amber/orange */
  border:1px solid #c77a16;     /* darker orange border */
  padding:4px 6px;
  border-radius:4px;
}

.orm-severe{
  background:#f44336;           /* strong red */
  border:1px solid #a10000;     /* darker red border */
  color:#000;                   /* keep black text */
  padding:4px 6px;
  border-radius:4px;
}
.orm-severe .tz-sfx{ color:#000; }

/* Exceeds limit: keep unchanged (your "emergency red" look) */
.orm-exceed{
  background:#c62828;
  color:#fff;
  padding:4px 6px;
  border-radius:4px;
  outline:2px solid #7f0000;
  outline-offset:-1px;
}
.orm-exceed .tz-sfx{
  color:#fff;
  opacity:1;
}

/* ================= Muted ORM bands (CDT/TDD/APU) ================= */
/* Softer fills, still readable, still scan-friendly */
.ormm-low{
  background:#eaf6ee;           /* muted green */
  border:1px solid #c7e7d0;
  padding:4px 6px;
  border-radius:4px;
}

.ormm-mod{
  background:#fff8e3;           /* muted yellow */
  border:1px solid #f1e0b6;
  padding:4px 6px;
  border-radius:4px;
}

.ormm-high{
  background:#ffe2bf;           /* muted orange */
  border:1px solid #f3c08a;
  padding:4px 6px;
  border-radius:4px;
}

.ormm-severe{
  background:#ffd1d1;           /* muted red */
  border:1px solid #f1a0a0;
  color:#000;
  padding:4px 6px;
  border-radius:4px;
}
.ormm-severe .tz-sfx{ color:#000; }

/* Make day shift readable on highlighted duty rows */
.orm-low .shift-sup,
.orm-mod .shift-sup,
.orm-high .shift-sup,
.orm-severe .shift-sup,
.orm-exceed .shift-sup,
.ormm-low .shift-sup,
.ormm-mod .shift-sup,
.ormm-high .shift-sup,
.ormm-severe .shift-sup{
  font-weight:900;
  opacity:1;
  color:inherit;
}
  
/* tiny offset editor for brief */
.inline-mini{
  width:44px;                          /* slightly smaller */
  font-size:11px;                     /* slightly tighter */
  font-family: Consolas, Menlo, "Courier New", monospace;

  padding:1px 1px;                    /* vertical centering for inputs */
  text-align:center;
  box-sizing:border-box;

  border-radius:4px;
  border:1px solid #cfcfcf;
  background:#fff;
}

/* ---------- DISCLAIMER / FOOTER ---------- */
.disclaimer{
  margin-top:40px;
  font-size:13px;
  color:#444;
  line-height:1.5;
  text-align:justify;
  text-justify:inter-word;
}

.footer{
  margin-top:40px;
  text-align:center;
  font-weight:bold;
}
  
.footer small{
  display:block;
  font-weight:normal;
  color:#666;
}

/* ---------- MOBILE ---------- */
@media (max-width:620px){
  .form-grid{
    grid-template-columns: max-content 1fr 26px 1fr 1fr;
  }
  .floating-wrap{ width:100%; }
  .box{ width:100%; }
  .icao-wrap{ width:100%; }
  .local-wrap{ margin-left:0; }

  .third-row-wrap{
    grid-template-columns: 1fr;
    row-gap:8px;
  }
  .third-content{
    grid-template-columns: 1fr;
    gap:10px;
  }
  .crew-toggle{ justify-self:end; }
}
</style>
</head>

<body>
<div id="pageRoot">

 <div class="app">

  <div class="headerbar">
    <h1 class="app-title">Crew Dawg Calculator</h1>
    <button id="resetBtn" class="icon-btn" title="Reset" tabindex="-1">
      &#x21bb;
    </button>
  </div>

    <div class="form-grid">

      <!-- Row 1 -->
      <div class="form-row">
        <div class="label form-label">Sched. Takeoff Time:</div>

        <div class="floating-wrap">
          <div class="floating-label">Zulu</div>
          <div id="takeoffTimeHint" class="icao-hint bad time-hint"></div>
          <input id="takeoffTime" class="box" placeholder="HHMM" maxlength="4" tabindex="1">
        </div>

        <div class="at">at</div>

      <div class="icao-wrap">
        <input id="takeoffICAO" class="box" placeholder="ICAO" maxlength="4" style="text-transform:uppercase;" tabindex="2">
        <div id="takeoffIcaoHint" class="icao-hint time-hint"></div>
      </div>

      <div class="floating-wrap local-wrap">
        <div class="floating-label">Local</div>
          <input id="takeoffLocal" class="box" placeholder="HHMM" maxlength="4" tabindex="-1">
          <span id="takeoffLocalDay" class="day-shift"></span>
         <div id="takeoffLocalHint" class="icao-hint bad time-hint"></div>
      </div>

      </div>

      <!-- Row 2 -->
      <div class="form-row">
        <div class="label form-label">Sched. Land Time:</div>

        <div class="floating-wrap">
          <div class="floating-label">Zulu</div>
          <div id="landingTimeHint" class="icao-hint bad time-hint"></div>
          <input id="landingTime" class="box" placeholder="HHMM" maxlength="4" tabindex="3">
        </div>

        <div class="at">at</div>

      <div class="icao-wrap">
        <input id="landingICAO" class="box" placeholder="ICAO" maxlength="4" style="text-transform:uppercase;" tabindex="4">
      <div id="landingIcaoHint" class="icao-hint time-hint"></div>
    </div>


        <div class="floating-wrap local-wrap">
          <div class="floating-label">Local</div>
           <input id="landingLocal" class="box" placeholder="HHMM" maxlength="4" tabindex="-1">
            <span id="landingLocalDay" class="day-shift"></span>
         <div id="landingLocalHint" class="icao-hint bad time-hint"></div>
      </div>

      </div>

      <!-- Row 3 -->
<div class="form-row">
  <div class="label aircraft-crew-label form-label">Aircraft / Crew:</div>

  <!-- Use columns 2 through 5 for the 3 evenly-spaced items -->
  <div class="third-content-wide">
<div class="aircraft-wrap">
  <div class="aircraft-home">
    <select id="aircraft" tabindex="-1">
      <option selected>KC-135</option>
      <option>KC-46</option>
      <option>C-5</option>
      <option>C-17</option>
      <option>C-130</option>
      <option>C-21</option>
      <option>C-32</option>
      <option>C-37</option>
      <option>C-40</option>
      <option>VC-25</option>
    </select>

    <div class="home-wrap">
      <input id="homeICAO" class="box" placeholder="HOME" maxlength="4" style="text-transform:uppercase;" tabindex="-1">
      <div id="homeIcaoHint" class="icao-hint time-hint"></div>
    </div>
  </div>
</div>

    <div class="crew-toggle">
      <span id="basicLbl" class="crew-label form-label active">Basic</span>
      <label class="switch">
        <input type="checkbox" id="augmented" tabindex="-1">
        <span class="slider"></span>
      </label>
      <span id="augLbl" class="crew-label form-label">Augmented</span>
    </div>
  </div>
</div>

    </div>

    <button id="calcBtn" tabindex="5">Calculate</button>

    <div id="output" class="output"></div>

    <div class="disclaimer">
      <p><strong>Disclaimer:</strong> I am a crew dog, not a coder or developer. I created this tool to help other crew dogs do “pilot math.” I try to keep this up to date with current regulations, but there is no guarantee of its accuracy. Please make sure you <em>trust but verify</em> the information generated on this page (technique only). Information in this calculator is based on AFMAN 11-202V3_AMC SUP, 29 JULY 2024.</p>

      <p>Also, as much as I would like to take credit for this and lead you to think I am smart, which I am not, I created this tool with the help of ChatGPT. If you find an error or have a suggetion for a change, please let me know at <strong>[your email]</strong>.</p>

      <p><strong>Donations:</strong> This is a free tool to help manage crew timing. It costs you nothing and costs me a little time and effort. If you feel so inclined to make a donation, please pay it forward and buy your Crew Chief a beer on the next TDY… or just make the Copilot do it. I appreciate your consideration, but I have already taken the bonus, so I am screwed either way. Blue skies and fair winds. Cheers!</p>
    </div>

    <div class="footer">
      NKAWT...GF
      <small>(If you know, you know…)</small>
    </div>
  </div>

</div>

<script>
/* ----------------- helpers ----------------- */
function showRuntimeError(err){
  const out = document.getElementById("output");
  if(!out) return;
  out.innerHTML = `
    <div style="margin-top:12px; padding:10px; border-radius:8px; background:#f8d7da;">
      <div style="font-weight:bold;">Something broke (runtime error)</div>
      <div style="margin-top:6px; font-family:Consolas, Menlo, 'Courier New', monospace; font-size:12px; white-space:pre-wrap;">
        ${String(err && err.message ? err.message : err)}
      </div>
      <div style="margin-top:6px; font-size:12px; color:#333;">
        Copy/paste that error back to me and we’ll fix it fast.
      </div>
    </div>
  `;
}

function circadianClassFromLocalMins(localMins){
  if(localMins == null) return "";

  // Simple, editable banding (tune these later if you want)
  // Low: 0700–2159
  // Mod: 2200–2359 and 0600–0659
  // High: 0400–0559
  // Severe: 0000–0359
  const m = ((localMins % 1440) + 1440) % 1440;

  if(m < 240) return "circ-severe";     // 0000–0359
  if(m < 360) return "circ-high";       // 0400–0559
  if(m < 420) return "circ-mod";        // 0600–0659
  if(m < 1320) return "circ-low";       // 0700–2159
  return "circ-mod";                    // 2200–2359
}
  
function setOutputIdle(message){
  const out = document.getElementById("output");
  if(!out) return;

  out.classList.add("idle");
out.style.display = "block";
out.style.opacity = "1";
out.innerHTML = message || "Enter inputs, then press Calculate";
}
  
function markDirty(){
  if(!hasCalculated) return;
  if(isCalculating) return;

  isDirty = true;

  const btn = document.getElementById("calcBtn");
  if(btn && btn.textContent !== "Re-Calculate"){
    btn.textContent = "Re-Calculate";
  }
}

function onUserEdit(){
  if(!hasCalculated) return;
  markDirty();
}
  
function clearDirty(){
  isDirty = false;

  const btn = document.getElementById("calcBtn");
  if(btn) btn.textContent = "Calculate";
}
  
function updateTimeHint(timeInput, hintEl){
  if(!hintEl) return;

  const raw = normHHMM(timeInput.value); // digits only, no padding

  // show nothing while typing fewer than 4 digits
  if(raw.length !== 4){
    hintEl.textContent = "";
    return;
  }

  // only validate once they truly have 4 digits
  hintEl.textContent = isHHMM(raw) ? "" : "Invalid time";
}

function setCalcEnabled(){
  const tk = padHHMM(takeoffTime.value);
  const ld = padHHMM(landingTime.value);

  const ok = isHHMM(tk) && isHHMM(ld);

  const btn = document.getElementById("calcBtn");
  if(btn) btn.disabled = !ok;

  // Gentle idle guidance (pre-calculate only)
  if(!hasCalculated){
    const out = document.getElementById("output");
    if(out && out.classList.contains("idle")){
      const anyTyped =
        takeoffTime.value.trim().length > 0 ||
        landingTime.value.trim().length > 0;

      if(anyTyped && !ok){
        out.innerHTML = "Enter valid HHMM times (0000–2359), then press Calculate";
      }else{
        out.innerHTML = "Enter inputs, then press Calculate";
      }
    }
  }
}


function isHHMM(s){
  return typeof s === "string" && /^\d{4}$/.test(s) &&
    parseInt(s.slice(0,2),10) <= 23 && parseInt(s.slice(2,4),10) <= 59;
}
  
function hhmmToMinutes(hhmm){
  return parseInt(hhmm.slice(0,2),10)*60 + parseInt(hhmm.slice(2,4),10);
}
  
function minutesToHHMM(mins){
  mins = ((mins % 1440) + 1440) % 1440;
  return String(Math.floor(mins/60)).padStart(2,"0") +
         String(mins%60).padStart(2,"0");
}
  
function minutesToHHMMZ(mins){ return minutesToHHMM(mins) + "Z"; 
}

function diffMinutes(start, end){
  let d = end - start;
  if(d < 0) d += 1440;
  return d;
}
  
function minutesToHPlusMM(mins){
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${h}+${String(m).padStart(2,"0")}`;
}
  
function parseHPlusMM(s){
  if(typeof s !== "string") return null;
  const t = s.trim();
  let m = t.match(/^(\d+)\+([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  m = t.match(/^(\d+):([0-5]\d)$/);
  if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
  return null;
}
  
function isICAO(s){
  return typeof s === "string" && /^[A-Z]{4}$/.test(s.trim().toUpperCase());
}

function normHHMM(s){
  // keep only digits, max 4
  return String(s || "").replace(/\D/g,"").slice(0,4);
}

function padHHMM(s){
  const d = normHHMM(s);          // digits only, up to 4
  if(d.length === 3) return "0" + d;  // 930 -> 0930
  return d;                       // 0-2 digits: leave as-is, 4 digits: keep
}
  
function normICAO(s){
  // keep only letters, max 4, uppercase
  return String(s || "").replace(/[^a-z]/gi,"").slice(0,4).toUpperCase();
}

function updateIcaoHint(icao, hintEl){
  if(!hintEl) return;

  const key = normICAO(icao);

  // Only show something once it's truly "ICAO shaped"
  if(key.length !== 4){
    hintEl.textContent = "";
    hintEl.classList.remove("bad");
    return;
  }

  // ICAO looks valid, but isn't mapped
  if(!getTimeZoneFromICAO(key)){
    hintEl.textContent = "Invalid ICAO";
    hintEl.classList.add("bad");
    return;
  }

  // Mapped — clear
  hintEl.textContent = "";
  hintEl.classList.remove("bad");
}

function formatDayShift(n){
  if(!n) return "";
  return n > 0 ? `+${n}` : `${n}`;   // +1, -1, +2, etc.
}
  
function zuluToLocalWithDay(zuluMins, icao, zuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), zuluHHMM);
  if(off == null) return null;
  const raw = zuluMins + off;                   // can be <0 or >=1440
  const dayShift = Math.floor(raw / 1440);      // -1, 0, +1 (or more)
  const localMins = ((raw % 1440) + 1440) % 1440;
  return { localMins, dayShift };
}
  
function splitDayShift(rawMinutes){
  const dayShift = Math.floor(rawMinutes / 1440);               // -1,0,+1...
  const mins = ((rawMinutes % 1440) + 1440) % 1440;             // normalized 0..1439
  return { mins, dayShift };
}
  
function formatShiftSup(dayShift){
  if(dayShift === 0) return "";
  return dayShift > 0 ? `+${dayShift}` : `${dayShift}`;
}
  
function zuluHtml(mins){
  const dayShift = Math.floor(mins / 1440);
  const m = ((mins % 1440) + 1440) % 1440;

  const sh = formatShiftSup(dayShift);

  return `<span class="mono timewrap">${minutesToHHMM(m)}<span class="tz-sfx">Z</span>${sh ? `<span class="shift-sup">${sh}</span>` : ""}</span>`;
}

function localHtmlFromZuluSimple(zuluMins, icao){
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return "";

  // preserve absolute day context
  const baseShift = Math.floor(zuluMins / 1440);
  const zNorm = ((zuluMins % 1440) + 1440) % 1440;
  const zHHMM = minutesToHHMM(zNorm);

  const res = zuluToLocalWithDay(zNorm, icao, zHHMM);
  if(!res) return "";

  const totalShift = baseShift + res.dayShift;
  const sh = formatShiftSup(totalShift);

  return `<span class="mono timewrap">${minutesToHHMM(res.localMins)}<span class="tz-sfx">L</span>${sh ? `<span class="shift-sup">${sh}</span>` : ""}</span>`;
}

function localHtmlAtRawZulu(rawZuluMinutes, icao, anchorHHMM){
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return "";
  const zMins = ((rawZuluMinutes % 1440) + 1440) % 1440;
  const zHHMM = anchorHHMM || minutesToHHMM(zMins);
  const res = zuluToLocalWithDay(zMins, icao, zHHMM);
  if(!res) return "";
  const base = `${minutesToHHMM(res.localMins)}L`;
  const sh = formatShiftSup(res.dayShift);
  return sh ? `${base}<span class="shift-sup">${sh}</span>` : base;
}

function row3Html(label, zuluMinutes, localIcao, showLocal, extraClass="", midHtml=""){
  const z = zuluHtml(zuluMinutes);

  // Middle column content: either Local time OR an optional message OR blank
  const middle = showLocal
    ? localHtmlFromZuluSimple(zuluMinutes, localIcao)
    : (midHtml || "");
  const midClass = (!showLocal && midHtml) ? "midtext" : "";

  return `
    <div class="row3 ${midClass} ${extraClass}">
      <span class="sc-label">${label}</span>
      <span class="lcol">${middle}</span>
      <span class="zcol">${z}</span>
    </div>
  `;
}


  
  
// ---------- Phase 1.5: ICAO lookup wrapper (preps for big DB later) ----------
let ICAO_TZ_DB = null; // optional external DB (Phase 2-ready)

// optional: later you can load this from a JSON file without changing the rest of the code
async function loadIcaoDb(){
  try{
    // If you add "icao_tz_db.json" in the same folder as this HTML, this will work.
    // Example JSON shape: { "KADW":"America/New_York", "EGLL":"Europe/London", ... }
    const res = await fetch("icao_tz_db.json", { cache: "no-store" });
    if(!res.ok) return;
    ICAO_TZ_DB = await res.json();
    console.log("[ICAO DB] Loaded entries:", Object.keys(ICAO_TZ_DB).length);
  }catch(_){
    // silent fail — we just fall back to the built-in map
  }
}

// run once at page load (safe even if no JSON exists)
loadIcaoDb();

/* ----------------- ICAO -> Time Zone (Phase 1 / Step 1) ----------------- */
const ICAO_TIMEZONE = {
  /* ===================== CONUS ===================== */
  KADW: "America/New_York",     // Andrews AFB
  KDOV: "America/New_York",     // Dover AFB
  KCHS: "America/New_York",     // Charleston AFB
  KJFK: "America/New_York",
  KLGA: "America/New_York",
  KEWR: "America/New_York",
  KIAD: "America/New_York",
  KDCA: "America/New_York",

  KORD: "America/Chicago",
  KDFW: "America/Chicago",
  KDEN: "America/Denver",

  KTCM: "America/Los_Angeles", // McChord
  KSEA: "America/Los_Angeles",
  KLAX: "America/Los_Angeles",
  KSFO: "America/Los_Angeles",
  KSUU: "America/Los_Angeles", // Travis AFB

  KPHX: "America/Phoenix",     // no DST
  KDMA: "America/Phoenix",     // Davis-Monthan

  PHNL: "Pacific/Honolulu",   // Hickam / JBPHH

  /* ===================== EUROPE / EUCOM ===================== */
  EGLL: "Europe/London",       // Heathrow
  EGGW: "Europe/London",       // Luton
  EGKK: "Europe/London",       // Gatwick
  EGUN: "Europe/London",       // Mildenhall
  EGUL: "Europe/London",       // Lakenheath

  ETAR: "Europe/Berlin",       // Ramstein
  ETSN: "Europe/Berlin",
  EDDM: "Europe/Berlin",       // Munich
  EDDF: "Europe/Berlin",       // Frankfurt

  LERT: "Europe/Madrid",       // Rota
  LEZG: "Europe/Madrid",

  LIRF: "Europe/Rome",         // Rome
  LIMC: "Europe/Rome",         // Milan

  EHAM: "Europe/Amsterdam",    // AMS
  LFPG: "Europe/Paris",        // CDG
  LOWW: "Europe/Vienna",       // Vienna

  /* ===================== CENTCOM ===================== */
  OTBH: "Asia/Qatar",           // Doha
  ORBI: "Asia/Baghdad",
  OKBK: "Asia/Kuwait",
  OAKN: "Asia/Kabul",

  OMDB: "Asia/Dubai",
  OMAA: "Asia/Dubai",           // Abu Dhabi

  OEJN: "Asia/Riyadh",          // Jeddah
  OERK: "Asia/Riyadh",          // Riyadh

  /* ===================== PACOM ===================== */
  RJTY: "Asia/Tokyo",           // Yokota
  RJTT: "Asia/Tokyo",           // Haneda
  RJAA: "Asia/Tokyo",           // Narita

  RKSO: "Asia/Seoul",           // Osan
  RKSI: "Asia/Seoul",           // Incheon

  ZSPD: "Asia/Shanghai",
  ZBAA: "Asia/Shanghai",        // Beijing

  RPLL: "Asia/Manila",

  WSSS: "Asia/Singapore",

  YSSY: "Australia/Sydney",
  YMML: "Australia/Melbourne",

  /* ===================== OTHER COMMON TDY ===================== */
  CYYZ: "America/Toronto",      // Toronto
  CYVR: "America/Vancouver",

  FAOR: "Africa/Johannesburg",
  FQMA: "Africa/Maputo",

  SBGR: "America/Sao_Paulo",    // São Paulo
};

function getTimeZoneFromICAO(icao){
  const key = (icao || "").trim().toUpperCase();

  // JSON DB first
  if(ICAO_TZ_DB && ICAO_TZ_DB[key]){
    const entry = ICAO_TZ_DB[key];

    // Your dataset format: { ..., "tz": "America/New_York", ... }
    if(entry && typeof entry === "object" && entry.tz) return entry.tz;

    // Future-proofing (other datasets sometimes use these)
    if(entry && typeof entry === "object" && entry.timezone) return entry.timezone;

    // If we ever switch to a flattened JSON: "KADW": "America/New_York"
    if(typeof entry === "string") return entry;
  }

  // Built-in fallback
  return ICAO_TIMEZONE[key] || null;
}

function getOffsetMinutesForTimeZone(timeZone, dateUtc){
  const fmt = new Intl.DateTimeFormat("en-US", {
    timeZone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hourCycle: "h23",
  });

  const parts = fmt.formatToParts(dateUtc);
  const get = (type) => parts.find(p => p.type === type)?.value;

  const y  = Number(get("year"));
  const mo = Number(get("month"));
  const d  = Number(get("day"));
  const h  = Number(get("hour"));
  const mi = Number(get("minute"));
  const s  = Number(get("second"));

  const asUtc = Date.UTC(y, mo - 1, d, h, mi, s);
  return Math.round((asUtc - dateUtc.getTime()) / 60000);
}

function getUtcOffsetMinutesFromICAO(icao, hhmm){
  const tz = getTimeZoneFromICAO(icao);
  if(!tz) return null;

  const now = new Date();
  const y = now.getUTCFullYear();
  const m = now.getUTCMonth();
  const d = now.getUTCDate();

  let h = 0, mi = 0;
  if(typeof hhmm === "string" && /^\d{4}$/.test(hhmm)){
    h  = parseInt(hhmm.slice(0,2),10);
    mi = parseInt(hhmm.slice(2,4),10);
  }

  const dateUtc = new Date(Date.UTC(y, m, d, h, mi, 0));
  return getOffsetMinutesForTimeZone(tz, dateUtc);
}

function zuluToLocalMinutes(zuluMins, icao, zuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), zuluHHMM);
  if(off == null) return null;
  return zuluMins + off;
}

function localToZuluMinutes(localMins, icao, anchorZuluHHMM){
  const off = getUtcOffsetMinutesFromICAO((icao||"").toUpperCase(), anchorZuluHHMM);
  if(off == null) return null;
  return localMins - off;
}


/* ----------------- state ----------------- */
let hasCalculated = false;
let isDirty = false;
let isCalculating = false;   // NEW
let briefOffsetMin = 150;
let isEditingZulu = false;

  /* Local time listeners (sync only; calculate only after first button press) */
const takeoffTime = document.getElementById("takeoffTime");
const homeICAO = document.getElementById("homeICAO");
const takeoffICAO = document.getElementById("takeoffICAO");
const takeoffLocal = document.getElementById("takeoffLocal");

const landingTime = document.getElementById("landingTime");
const landingICAO = document.getElementById("landingICAO");
const landingLocal = document.getElementById("landingLocal");
  
/* ----------------- main calc + render ----------------- */
function calculate(){
  try{
    const takeoff = padHHMM(takeoffTime.value);
    const landing = padHHMM(landingTime.value);
      // Snap the UI to normalized values (only if we can)
      if(takeoffTime.value !== takeoff) takeoffTime.value = takeoff;
      if(landingTime.value !== landing) landingTime.value = landing;
    const augmented = augmentedBox.checked;
    const out = document.getElementById("output");
     // results mode
      out.classList.remove("idle");
      out.style.display = "block";
    
// Only animate expand on first-time Calculate (idle -> expanded)
// Re-Calculate should update in place without re-animating or scrolling
const doExpandAnim = out.classList.contains("idle");

if(doExpandAnim){
  const prevTransition = out.style.transition;
  out.style.transition = "none";
  out.classList.add("collapsing");
  out.getBoundingClientRect();
  out.style.transition = prevTransition;
}else{
  out.classList.remove("collapsing");
}
    // if the brief offset editor exists (from a previous render), honor it on every calculate
    const existingBrief = document.getElementById("briefOffsetEdit");
    if(existingBrief){
      const v = parseHPlusMM(existingBrief.value);
      if(v != null) briefOffsetMin = v;
    }

    const takeoffMin = hhmmToMinutes(takeoff);
    const landingMin = hhmmToMinutes(landing);
    // For local-time output rows (crew timing uses takeoff ICAO)
    const tkIcao = normICAO(takeoffICAO.value);
    const ldIcao = normICAO(landingICAO.value);
    
    const showTime   = takeoffMin - 195;
    
const homeIcao = normICAO(homeICAO?.value || "");
const homeTz = homeIcao ? getTimeZoneFromICAO(homeIcao) : null;
const homeKey = homeTz ? homeIcao : tkIcao;

let homeShowLocalMins = null;
if(isICAO(homeKey) && getTimeZoneFromICAO(homeKey)){

  const zNorm = ((showTime % 1440) + 1440) % 1440;
  const zHHMM = minutesToHHMM(zNorm);
  const res = zuluToLocalWithDay(zNorm, homeKey, zHHMM);
  if(res) homeShowLocalMins = res.localMins; // only for circadian banding
}

const showCircClass = circadianClassFromLocalMins(homeShowLocalMins);
const homeShowHtml = (homeShowLocalMins == null) ? "" : localHtmlFromZuluSimple(showTime, homeKey);

    
    const crewRest   = takeoffMin - 855;
    const lastBeer   = takeoffMin - 720;
    const legalAlert = takeoffMin - 255;

    const briefTime  = takeoffMin - briefOffsetMin;

    const stepTime   = takeoffMin - 120;
    const engine     = takeoffMin - 30;

    // Treat landing as "next day" if it’s earlier than takeoff on the clock
    const landingAbs = landingMin + (landingMin < takeoffMin ? 1440 : 0);
    
    // Use absolute timeline for flight time
    const flightMin = landingAbs - takeoffMin;
    const flightHrs = (flightMin / 60).toFixed(1);

    const fdp = augmented ? 1440 : 960;
    const cdp = augmented ? 1485 : 1080;
    const tdp = 720;
    const apu = augmented ? 1080 : 720;

    // Use the SAME absolute landing for duty/ORM math
    const landingFromShow = landingAbs - showTime;

    // FDP = KING (includes "exceed" behavior)
    function ormClassFdp(limitMinutes){
      if(limitMinutes <= 0) return "";
      if(landingFromShow > limitMinutes) return "orm-exceed";
      const ratio = landingFromShow / limitMinutes;
      if(ratio >= 0.95) return "orm-severe";
      if(ratio >= 0.90) return "orm-high";
      if(ratio >= 0.75) return "orm-mod";
      return "orm-low";
    }

    // CDT/TDD/APU = muted colors only (NO exceed behavior)
    function ormClassMuted(limitMinutes){
      if(limitMinutes <= 0) return "";
      const ratio = landingFromShow / limitMinutes;
      if(ratio >= 0.95) return "ormm-severe";
      if(ratio >= 0.90) return "ormm-high";
      if(ratio >= 0.75) return "ormm-mod";
      return "ormm-low";
    }

    // FDP-only message
    function ormMessageFdp(limitMinutes){
      if(limitMinutes <= 0) return "";
      if(landingFromShow > limitMinutes){
        return "Mission NO-GO. Maximum Duty Day Exceeded";
      }
      const ratio = landingFromShow / limitMinutes;
      if(ratio >= 0.95) return "ORM Severe: >95% of Maximum Duty Day";
      if(ratio >= 0.90) return "ORM High: 90-95% of Maximum Duty Day";
      if(ratio >= 0.75) return "ORM Moderate: 75-90% of Maximum Duty Day";
      return "ORM Low: <75% of Maximum Duty Day";
    }

    out.innerHTML = `
      <div class="sc-head timing-head" style="font-weight:900;text-align:center;">Crew Timing</div>
      <div class="crew-timing">

      ${row3Html("Enter Crew Rest", crewRest, tkIcao, true)}
      <div class="subtext">T/O − 14+15</div>

      ${row3Html("Last Beer", lastBeer, tkIcao, true)}
      <div class="subtext">T/O − 12+00</div>

      ${row3Html("Legal for Alert", legalAlert, tkIcao, true)}
      <div class="subtext">T/O − 4+15</div>

      ${row3Html("Show Time", showTime, tkIcao, true, showCircClass)}
      <div class="subtext">
      T/O − 3+15${homeShowHtml ? ` • Home: ${homeShowHtml}` : ""}
      </div>

      ${row3Html("Brief Time", briefTime, tkIcao, true)}
      <div class="subtext">
        T/O − <input id="briefOffsetEdit" class="inline-mini"
          value="${minutesToHPlusMM(briefOffsetMin)}" maxlength="5"
          title="H+MM (e.g., 2+30)">
      </div>

      ${row3Html("Step Time", stepTime, tkIcao, true)}
      <div class="subtext">T/O − 2+00</div>

      ${row3Html("Engine Start", engine, tkIcao, true)}
      <div class="subtext">T/O − 0+30</div>

      ${row3Html("Takeoff", takeoffMin, tkIcao, true)}
      <div class="subtext">T/O − 0+00</div>

      ${row3Html("Landing", landingAbs, ldIcao, true)}
      <div class="subtext">LND − 0+00</div>

    </div>
      <hr>

      <div class="row flight-time">
        <span class="sc-label">Flight Time</span>
          <span>
        <span class="mono">${flightHrs}</span>
        <span class="sc-label"> hrs</span>
          </span>
      </div>

      <hr>

      <div class="sc-head duty-head" style="font-weight:900;text-align:center;">Crew Duty Limitations</div>

      ${row3Html(
        "Flight Duty Period",
        showTime + fdp,
        "",
        false,
        ormClassFdp(fdp),
        `<span class="orm-note">${ormMessageFdp(fdp)}</span>`
      )}
      <div class="subtext">Show + ${minutesToHPlusMM(fdp)}</div>

      ${row3Html("Crew Duty Time", showTime + cdp, "", false, ormClassMuted(cdp))}
      <div class="subtext">Show + ${minutesToHPlusMM(cdp)}</div>

      ${row3Html("Transition Duty Day", showTime + tdp, "", false, ormClassMuted(tdp))}
      <div class="subtext">Show + ${minutesToHPlusMM(tdp)}</div>

      ${row3Html("Autopilot INOP FDP", showTime + apu, "", false, ormClassMuted(apu))}
      <div class="subtext">Show + ${minutesToHPlusMM(apu)}</div>

<hr>
<div class="output-actions">
  <button id="resetBtn2" type="button">Reset</button>
  <button id="crewTextBtn" type="button" disabled>Generate Crew Text</button>
</div>
      
    `;

requestAnimationFrame(() => {
  // One more frame ensures the collapsed state is definitely painted
  requestAnimationFrame(() => {
   if(doExpandAnim){
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      out.classList.remove("collapsing");
    });
  });
}else{
  out.classList.remove("collapsing");
}
    
setTimeout(() => {
      // No hard height lock — just turn on panel behavior
      out.classList.add("fixed-expanded");
    }, 280); // slightly > 260ms transition

  });
});

    
const reset2 = document.getElementById("resetBtn2");
reset2?.addEventListener("click", () => {
  resetAll({ scrollToTop: true });
});

const crewTextBtn = document.getElementById("crewTextBtn");
crewTextBtn?.addEventListener("click", () => {
  // Placeholder for Phase 2/2.5
  // Later: generate text + copy to clipboard
});
    
    // live-update brief time after first Calculate, without needing to click again
    const offInp = document.getElementById("briefOffsetEdit");
    offInp?.addEventListener("input", (e) => {
      const v = parseHPlusMM(e.target.value);
      if(v == null) return;
      briefOffsetMin = v;
    });
    
    setCalcEnabled();

  }catch(err){
    showRuntimeError(err);
  }
}


/* ----------------- local time sync ----------------- */
let suppressSync = false;

function syncLocalFromZulu(zuluInput, icaoInput, localInput, dayElId){
  if(isEditingZulu) return;
  if(suppressSync) return;

  const dayEl = document.getElementById(dayElId);
const localHintEl = document.getElementById(
  localInput.id === "takeoffLocal" ? "takeoffLocalHint" : "landingLocalHint"
);
  const icao = normICAO(icaoInput.value);

// update the hint (takeoff or landing)
updateIcaoHint(icao, document.getElementById(
  icaoInput.id === "takeoffICAO" ? "takeoffIcaoHint" : "landingIcaoHint"
));

// If ICAO is fully blank: clear Local + day marker (prevents stale local time)
if(icao.length === 0){
  suppressSync = true;
  localInput.value = "";
  if(dayEl) dayEl.textContent = "";
  if(localHintEl) updateTimeHint(localInput, localHintEl);
  suppressSync = false;
  return;
}

// If ICAO is not ready/valid/mapped yet: don’t fight the user while typing
if(!isICAO(icao) || !getTimeZoneFromICAO(icao)){
  suppressSync = true;
  if(dayEl) dayEl.textContent = "";
  suppressSync = false;
  return;
}

const z = zuluInput.value.trim();
if(!isHHMM(z)){
  // If Zulu isn't valid yet, do NOT wipe Local.
  // Local-first users may have typed Local already.
  suppressSync = true;
  if(dayEl) dayEl.textContent = "";
  suppressSync = false;
  return;
}

  const zM = hhmmToMinutes(z);
  const res = zuluToLocalWithDay(zM, icao, z);

  suppressSync = true;

  if(res == null){
    localInput.value = "";
    if(dayEl) dayEl.textContent = "";
  } else {
    localInput.value = minutesToHHMM(res.localMins);
    if(dayEl) dayEl.textContent = formatDayShift(res.dayShift);
  }

  // NEW: keep Local hint in sync when we auto-write Local
  if(localHintEl) updateTimeHint(localInput, localHintEl);


  suppressSync = false;
}

function syncZuluFromLocal(localInput, icaoInput, zuluInput){
  if(suppressSync) return;

  const icao = normICAO(icaoInput.value);
  if(!isICAO(icao) || !getTimeZoneFromICAO(icao)) return; // need ICAO + mapping

  const l = localInput.value.trim();
  if(!isHHMM(l)) return;

  const lM = hhmmToMinutes(l);

  // Anchor offset to what's currently in the Zulu box if valid, else "0000"
  const zAnchor = (zuluInput.value && isHHMM(zuluInput.value.trim())) ? zuluInput.value.trim() : "0000";

  const zM = localToZuluMinutes(lM, icao, zAnchor);
  if(zM == null) return;

  suppressSync = true;
  zuluInput.value = minutesToHHMM(zM);
  suppressSync = false;
}

/* ----------------- bindings ----------------- */
const augmentedBox = document.getElementById("augmented");
const basicLbl = document.getElementById("basicLbl");
const augLbl = document.getElementById("augLbl");

function syncToggleLabels(){
  basicLbl.classList.toggle("active", !augmentedBox.checked);
  augLbl.classList.toggle("active", augmentedBox.checked);
}
  
augmentedBox.addEventListener("change", () => {
  syncToggleLabels();

  // mark changes so Calculate -> Re-Calculate (but do NOT auto-run)
  onUserEdit();

  // keep button enabled/disabled based on time validity
  setCalcEnabled();
});

syncToggleLabels();

document.getElementById("calcBtn").addEventListener("click", () => {
  isCalculating = true;

  hasCalculated = true;
  isDirty = false;
  clearDirty();
  
const shouldScroll = document.getElementById("output")?.classList.contains("idle");
  calculate();

  // smooth scroll to results (after DOM updates)
  requestAnimationFrame(() => {
const outEl = document.getElementById("output");
if(outEl && shouldScroll){
  outEl.scrollIntoView({ behavior:"smooth", block:"start" });
}

  });

  isCalculating = false;
});

document.getElementById("resetBtn").addEventListener("click", () => {
  resetAll({ scrollToTop: false });
});

function resetAll({ scrollToTop = false } = {}){
  // clear inputs
  takeoffTime.value = "";
  landingTime.value = "";
  takeoffICAO.value = "";
  landingICAO.value = "";
  homeICAO.value = "";
  takeoffLocal.value = "";
  landingLocal.value = "";

  // clear day shift badges
  const tDay = document.getElementById("takeoffLocalDay");
  const lDay = document.getElementById("landingLocalDay");
  if(tDay) tDay.textContent = "";
  if(lDay) lDay.textContent = "";

  // reset state + output
    // clear ALL hints immediately (must happen before any early-return)
[
  "takeoffIcaoHint", "landingIcaoHint", "homeIcaoHint",
  "takeoffTimeHint", "landingTimeHint",
  "takeoffLocalHint", "landingLocalHint"
  ].forEach(id => {
    const el = document.getElementById(id);
    if(el){
      el.textContent = "";
      el.classList.remove("bad");
    }
  });

  hasCalculated = false;
  isDirty = false;
  clearDirty();                 // puts button text back to "Calculate"
  briefOffsetMin = 150;

const out = document.getElementById("output");
if(out){
    delete out.dataset.expandedH; // force fresh measure next time
  // Ensure output is measurable
  out.style.display = "block";
// --- TOP RESET SAFETY: prevent "pop open then collapse" ---
  out.classList.remove("collapsing");
  out.classList.remove("collapsing-to-idle");
  out.style.removeProperty("--idleScale");

// If we're already idle, just stay idle (no animation, no flashes)
if(out.classList.contains("idle")){
  out.classList.remove("fixed-expanded");
  out.style.height = "";
  out.style.overflow = "";
  setOutputIdle("Enter inputs, then press Calculate");
  takeoffTime.focus({ preventScroll: true });
  return;
}

// Clear fixed-expanded lock BEFORE collapsing so it can't re-expand first
out.classList.remove("fixed-expanded");
out.style.height = "";
out.style.overflow = "";
out.getBoundingClientRect(); // commit cleared state

  
// Ensure we're in a stable expanded layout height before collapsing
if(out.dataset.expandedH){
    out.classList.add("fixed-expanded");
    out.style.height = out.dataset.expandedH + "px";
    out.style.overflow = "hidden"; // page doesn't reflow during collapse
  }
  out.classList.remove("collapsing");
  out.classList.remove("collapsing-to-idle");
  out.style.removeProperty("--idleScale");
  out.getBoundingClientRect(); // commit

  // Ensure we're not in idle mode while collapsing (prevents style flicker)
  out.classList.remove("idle");

  // Force a style flush so the transition always fires
  out.getBoundingClientRect();

  // Start visual-only collapse (doesn't change layout height)
  // Compute the target idle scale so we shrink directly to idle size (not to zero)
const startHeight2 = out.getBoundingClientRect().height;

  // --- shrink directly to fixed idle size (52px), no clone measurement ---
out.classList.remove("collapsing");          // important: prevent "expand blip"
out.classList.remove("collapsing-to-idle");  // clear any prior state

const startH = Math.max(1, out.getBoundingClientRect().height);
const idleH = 52; // must match .output.idle height in CSS
const idleScale = Math.max(0.15, Math.min(1, idleH / startH));
out.style.setProperty("--idleScale", String(idleScale));

out.classList.add("collapsing-to-idle");
  
// Start scroll-to-top immediately (so it happens during the collapse)
if(scrollToTop){
  const root = document.getElementById("pageRoot");
  if(root && root.scrollIntoView){
    root.scrollIntoView({ behavior: "smooth", block: "start" });
  }else{
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
}
  const finish = () => {
    out.removeEventListener("transitionend", onEnd);

    // Swap to idle content while still invisible (prevents “Crew Timing” flash)
    // Swap to idle content cleanly (no flash)
    const prevTransition = out.style.transition;
      out.style.transition = "none";
      out.style.transition = prevTransition;

    requestAnimationFrame(() => {
  // End the shrink animation state
  out.classList.remove("collapsing-to-idle");
  out.style.removeProperty("--idleScale");

  // Release the fixed expanded panel so idle can be its fixed small size
  out.classList.remove("fixed-expanded");
  out.style.height = "";
  out.style.overflow = "";

  // Now snap to idle content (no animation / no flash)
  setOutputIdle("Enter inputs, then press Calculate");

  // Focus without causing scroll jumps
  takeoffTime.focus({ preventScroll: true });
});
  };

  const onEnd = (e) => {
    // Fire only once, when the transform transition ends
    if(e.propertyName === "transform") finish();
  };

  out.addEventListener("transitionend", onEnd);

  // Safety fallback in case transitionend doesn't fire
  setTimeout(finish, 350);
}

  // optional: reset crew toggle to Basic
  augmentedBox.checked = false;
  syncToggleLabels();

  // Time hints (red "Invalid time" under Zulu)
  const tkTimeHint = document.getElementById("takeoffTimeHint");
  const ldTimeHint = document.getElementById("landingTimeHint");
  if(tkTimeHint) tkTimeHint.textContent = "";
  if(ldTimeHint) ldTimeHint.textContent = "";

  // Local hints (red "Invalid time" under Local)
  const tkLocalHint = document.getElementById("takeoffLocalHint");
  const ldLocalHint = document.getElementById("landingLocalHint");
  if(tkLocalHint) tkLocalHint.textContent = "";
  if(ldLocalHint) ldLocalHint.textContent = "";


  // recalc button enabled/disabled correctly
  setCalcEnabled();
}

[takeoffTime, landingTime].forEach(inp => {
  inp.addEventListener("focus", () => {
    isEditingZulu = true;
  });

  inp.addEventListener("blur", () => {
    isEditingZulu = false;
  });
});
  
[takeoffTime, landingTime, takeoffLocal, landingLocal].forEach(inp => {
  inp.addEventListener("input", () => {
    const clean = normHHMM(inp.value);
    if(inp.value !== clean) inp.value = clean;

    if(inp === takeoffTime) updateTimeHint(takeoffTime, document.getElementById("takeoffTimeHint"));
    if(inp === landingTime) updateTimeHint(landingTime, document.getElementById("landingTimeHint"));

    // NEW: Local time gentle validation (does not affect Calculate enable)
    if(inp === takeoffLocal) updateTimeHint(takeoffLocal, document.getElementById("takeoffLocalHint"));
    if(inp === landingLocal) updateTimeHint(landingLocal, document.getElementById("landingLocalHint"));

    setCalcEnabled();
    onUserEdit();
  });
});

[takeoffTime, landingTime, takeoffLocal, landingLocal].forEach(inp => {
  inp.addEventListener("blur", () => {
    const padded = padHHMM(inp.value);
    if(inp.value !== padded) inp.value = padded;

    // After snapping, re-sync the paired fields
    if(inp === takeoffTime) syncLocalFromZulu(takeoffTime, takeoffICAO, takeoffLocal, "takeoffLocalDay");
    if(inp === landingTime) syncLocalFromZulu(landingTime, landingICAO, landingLocal, "landingLocalDay");
    if(inp === takeoffLocal) syncZuluFromLocal(takeoffLocal, takeoffICAO, takeoffTime);
    if(inp === landingLocal) syncZuluFromLocal(landingLocal, landingICAO, landingTime);
  });
});
  
[takeoffICAO, landingICAO].forEach(inp => {
  inp.addEventListener("input", () => {
    const clean = normICAO(inp.value);
    if (inp.value !== clean) inp.value = clean;

    // update hint live as they type
    const hintId = (inp.id === "takeoffICAO") ? "takeoffIcaoHint" : "landingIcaoHint";
    updateIcaoHint(clean, document.getElementById(hintId));

    // NEW: re-sync local any time ICAO changes (including deleting it)
    const zuluInput  = (inp.id === "takeoffICAO") ? takeoffTime  : landingTime;
    const localInput = (inp.id === "takeoffICAO") ? takeoffLocal : landingLocal;
    const dayId      = (inp.id === "takeoffICAO") ? "takeoffLocalDay" : "landingLocalDay";

    syncLocalFromZulu(zuluInput, inp, localInput, dayId);
    // Local-first support:
    // If user already typed Local, and ICAO just became valid/mapped, fill Zulu from Local.
    if(isICAO(clean) && getTimeZoneFromICAO(clean) && isHHMM(localInput.value.trim())){
      syncZuluFromLocal(localInput, inp, zuluInput);
      setCalcEnabled(); // important: button enables when Zulu is auto-filled
    }

    if (hasCalculated) onUserEdit();
  });
});

homeICAO?.addEventListener("input", () => {
  const clean = normICAO(homeICAO.value);
  if(homeICAO.value !== clean) homeICAO.value = clean;

  updateIcaoHint(clean, document.getElementById("homeIcaoHint"));

  // If results already exist, mark output stale (don’t auto-recalc)
  if(hasCalculated) onUserEdit();
});
  
[takeoffTime, takeoffICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(takeoffTime, takeoffICAO, takeoffLocal, "takeoffLocalDay");
}));
  
takeoffLocal.addEventListener("input", () => {
  syncZuluFromLocal(takeoffLocal, takeoffICAO, takeoffTime);
  setCalcEnabled(); // NEW: enable button once Zulu is auto-filled
  if(hasCalculated) onUserEdit();   // or markDirty(), whichever you're using
});

[landingTime, landingICAO].forEach(el => el.addEventListener("input", () => {
  syncLocalFromZulu(landingTime, landingICAO, landingLocal, "landingLocalDay");
}));
landingLocal.addEventListener("input", () => {
  syncZuluFromLocal(landingLocal, landingICAO, landingTime);
  setCalcEnabled(); // NEW
  if(hasCalculated) onUserEdit();   // or markDirty()
});
  
setOutputIdle();

  setCalcEnabled();
</script>

</body>
</html>
